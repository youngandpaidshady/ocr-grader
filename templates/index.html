<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Grader Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(215, 10%, 4%)',    /* Deep midnight blue layer 0 */
                        foreground: 'hsl(215, 5%, 98%)',
                        card: 'hsl(215, 10%, 6%)',          /* Elevated surface */
                        'card-foreground': 'hsl(215, 5%, 98%)',
                        muted: 'hsl(215, 10%, 15%)',
                        'muted-foreground': 'hsl(215, 10%, 65%)',
                        primary: 'hsl(215, 90%, 55%)',      /* QSI Blue */
                        'primary-foreground': 'hsl(0, 0%, 98%)',
                        accent: 'hsl(215, 80%, 70%)',
                        destructive: 'hsl(0, 72%, 51%)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: 0.2 },
                            '50%': { opacity: 0.4 },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- OpenCV.js for Advanced Document Detection -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="console.log('OpenCV loaded');"
        type="text/javascript"></script>

    <style>
        :root {
            --brand-rgb: 33, 150, 243;
            /* Matches primary HSL 215, 90%, 55% */
        }

        body {
            background-color: theme('colors.background');
            color: theme('colors.foreground');
        }

        /* 21st.dev Premium Depth & Textures */
        .dot-matrix {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .shadow-glow {
            box-shadow: 0 0 20px rgba(var(--brand-rgb), 0.3);
        }

        .shadow-glow-lg {
            box-shadow: 0 0 40px rgba(var(--brand-rgb), 0.4);
        }

        .shadow-bloom {
            box-shadow: 0 0 60px 20px rgba(var(--brand-rgb), 0.15);
        }

        .noise {
            position: relative;
        }

        .noise::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Input Animations */
        .input-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }

        .input-focus-anim {
            position: absolute;
            inset: -1px;
            background: linear-gradient(90deg, transparent, rgba(var(--brand-rgb), 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border-radius: 0.75rem;
        }

        select:focus~.input-focus-anim,
        input[type="text"]:focus~.input-focus-anim {
            opacity: 1;
        }

        /* Animation Base */
        .reveal {
            opacity: 1;
            /* Fallback to visible if observer fails */
            transform: translateY(0) scale(1);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: opacity, transform;
        }

        /* We'll use JS to add a class to hide them initially if JS loads */
        .reveal-initial {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
        }

        .reveal.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .reveal-delay-1 {
            transition-delay: 100ms;
        }

        .reveal-delay-2 {
            transition-delay: 200ms;
        }

        /* Card Light Beam (Active Card Effect) */
        .light-beam-card {
            position: relative;
        }

        .light-beam-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .light-beam-card:hover::before {
            opacity: 1;
        }

        /* Holographic Sheen */
        .holographic {
            background-image: linear-gradient(75deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            background-size: 200% 100%;
            background-position: 100% 0;
            transition: background-position 0.6s ease;
        }

        .holographic:hover {
            background-position: -100% 0;
        }

        /* 3D Button Effects */
        .btn-3d {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            position: relative;
            transform-style: preserve-3d;
        }

        .btn-3d:active {
            transform: translateY(4px) scale(0.98);
        }

        /* Float Animation */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        /* Mobile Touch Ripples */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 600ms linear;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        @keyframes ripple-anim {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Magnetic Button Transition */
        .magnetic {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s;
            will-change: transform;
        }

        /* Component Overrides */
        #video-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 3/4;
            /* Optimized for portrait document scanning */
            margin: 0 auto;
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            background-color: #000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        @media (min-width: 768px) {
            #video-container {
                /* Larger screens can handle wider or taller boxes nicely */
                aspect-ratio: 4/5;
            }
        }

        #camera-feed {
            width: 100%;
            height: auto;
            object-fit: cover;
            display: block;
        }

        .captured-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Toast Notification System */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            max-width: 380px;
            width: calc(100% - 2rem);
        }

        .toast {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            font-size: 0.8125rem;
            font-weight: 600;
            line-height: 1.4;
            color: white;
        }

        .toast.toast-exit {
            animation: toastSlideOut 0.3s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards;
        }

        .toast-success {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .toast-error {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .toast-info {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .toast-icon {
            font-size: 1.1rem;
            margin-top: 1px;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            color: #10b981;
        }

        .toast-warning .toast-icon {
            color: #f59e0b;
        }

        .toast-error .toast-icon {
            color: #ef4444;
        }

        .toast-info .toast-icon {
            color: #3b82f6;
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            padding: 2px;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 1px;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: white;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(40px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateX(40px) scale(0.9);
            }
        }

        /* Recent Session Cards */
        .session-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px -8px rgba(var(--brand-rgb), 0.3);
        }

        .session-card:active {
            transform: scale(0.98);
        }

        /* Landing entry cards */
        .entry-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .entry-card:hover {
            transform: translateY(-4px);
        }

        .entry-card:active {
            transform: scale(0.97);
        }

        /* Section transitions */
        .section-transition {
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }
    </style>
</head>

<body class="min-h-screen font-sans antialiased overflow-x-hidden selection:bg-primary/30 relative bg-background">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scroll Progress Indicator -->
    <div id="scroll-progress"
        class="fixed top-0 left-0 h-1 bg-gradient-to-r from-primary to-accent z-50 transition-all duration-100 origin-left shadow-glow border-b border-primary"
        style="width: 0%;"></div>

    <!-- Fun Full-Screen Loading Overlay -->
    <div id="grading-loading-overlay"
        class="fixed inset-0 z-[100] bg-background/95 backdrop-blur-xl hidden flex-col items-center justify-center transition-all duration-500">
        <div class="relative w-40 h-40 mb-8 flex items-center justify-center">
            <!-- Outer spinning ring -->
            <div
                class="absolute inset-0 border-4 border-primary/20 border-t-primary rounded-full animate-[spin_2s_linear_infinite]">
            </div>
            <!-- Inner spinning ring -->
            <div
                class="absolute inset-4 border-4 border-emerald-500/20 border-b-emerald-500 rounded-full animate-[spin_1.5s_linear_infinite_reverse]">
            </div>
            <!-- Center pulsing icon -->
            <div class="absolute inset-0 flex items-center justify-center text-5xl">
                <i
                    class="fa-solid fa-wand-magic-sparkles text-primary animate-pulse filter drop-shadow-[0_0_15px_rgba(33,150,243,0.8)]"></i>
            </div>
            <!-- Floating math symbols for fun -->
            <i class="fa-solid fa-plus absolute top-0 left-0 text-emerald-400 text-sm animate-bounce"></i>
            <i class="fa-solid fa-divide absolute bottom-2 right-4 text-purple-400 text-sm animate-pulse"></i>
            <i class="fa-solid fa-minus absolute top-4 right-2 text-yellow-400 text-sm animate-bounce"
                style="animation-delay: 0.2s;"></i>
        </div>
        <h3 class="text-3xl font-heading font-black text-white mb-3 tracking-tight animate-pulse-glow">AI is Grading
            Papers...</h3>
        <p class="text-muted-foreground font-medium text-center max-w-sm px-4">
            Extracting handwriting, matching student names, and calculating final scores.
        </p>
        <div class="mt-8 w-64 h-2 bg-white/10 rounded-full overflow-hidden">
            <div
                class="h-full bg-gradient-to-r from-primary via-emerald-400 to-primary w-[200%] animate-[scan_2s_linear_infinite]">
            </div>
        </div>
    </div>
    <style>
        @keyframes scan {
            0% {
                transform: translateX(-50%);
            }

            100% {
                transform: translateX(0%);
            }
        }
    </style>

    <!-- Depth Layer 1: Atmosphere (Dot Matrix + Single Spotlight Glow) -->
    <div class="fixed inset-0 z-0 noise pointer-events-none"></div>
    <div class="fixed inset-0 z-0 dot-matrix pointer-events-none opacity-50"></div>
    <div
        class="fixed top-[-20%] left-[-10%] w-[60vw] h-[60vw] rounded-full bg-primary/10 blur-[120px] pointer-events-none z-0">
    </div>

    <!-- Depth Layer 3: Foreground Content -->
    <div class="max-w-4xl mx-auto p-4 md:p-8 relative z-10 w-full animate-fade-in-up">

        <!-- Header -->
        <header class="text-center mb-16 pt-12 reveal visible relative">
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-primary/20 blur-[60px] rounded-full -z-10">
            </div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-extrabold text-white mb-4 tracking-tight">
                <i
                    class="fa-solid fa-graduation-cap mr-3 text-primary drop-shadow-[0_0_15px_rgba(var(--brand-rgb),0.5)]"></i>QSI
                Smart Grader
            </h1>
            <p class="text-muted-foreground text-lg max-w-xl mx-auto font-medium">Capture handwritten exam scripts and
                let the AI automatically extract, format, and rank the results directly to Excel.</p>
        </header>

        <main>
            <!-- Step 1: Start Screen / Assessment Details -->
            <section id="start-section" class="mb-12">

                <!-- PHASE 1: LANDING (3 Options) -->
                <div id="landing-phase"
                    class="bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl md:text-3xl font-heading font-black text-white mb-3 tracking-tight">What are
                            we grading today?</h2>
                        <p class="text-muted-foreground text-sm font-medium">Pick up where you left off, or start fresh.
                        </p>
                    </div>

                    <!-- Recent Sessions -->
                    <div id="recent-sessions-container" class="mb-6 hidden">
                        <label
                            class="block text-[10px] font-bold text-muted-foreground uppercase tracking-widest pl-1 mb-3">
                            <i class="fa-solid fa-clock-rotate-left mr-1.5"></i>Continue a Recent Session
                        </label>
                        <div id="recent-sessions-list" class="space-y-2"></div>
                    </div>

                    <!-- Two Entry Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
                        <!-- Option 2: Upload Excel -->
                        <button id="btn-entry-excel" type="button"
                            class="entry-card holographic btn-3d magnetic bg-black/40 hover:bg-emerald-500/10 border border-white/10 hover:border-emerald-500/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-[0_0_20px_rgba(16,185,129,0.3)] relative overflow-hidden h-full reveal reveal-delay-3">
                            <div
                                class="w-14 h-14 rounded-2xl bg-emerald-500/15 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform duration-300 border border-emerald-500/20 floating">
                                <i class="fa-solid fa-file-excel text-emerald-400 text-2xl"></i>
                            </div>
                            <span class="font-bold text-[15px] tracking-wide text-emerald-100">I Have My Excel</span>
                            <span class="text-[11px] text-emerald-200/50 font-medium leading-tight">Pick up
                                exactly<br>where you left off.</span>
                        </button>
                        <input type="file" id="entry-excel-upload" accept=".xlsx,.xls,.csv" class="hidden">

                        <button id="btn-entry-fresh" type="button" onclick="window.showSetup && window.showSetup(null)"
                            class="entry-card holographic btn-3d magnetic bg-black/30 hover:bg-primary/10 border border-white/10 hover:border-primary/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-glow relative overflow-hidden h-full reveal reveal-delay-2">
                            <div
                                class="w-14 h-14 rounded-2xl bg-primary/15 flex items-center justify-center mb-1 group-hover:scale-110 transition-transform duration-300 border border-primary/20 floating">
                                <i class="fa-solid fa-wand-magic-sparkles text-primary text-2xl"></i>
                            </div>
                            <span class="font-bold text-[15px] tracking-wide">Start Fresh</span>
                            <span class="text-[11px] text-muted-foreground font-medium leading-tight">Brand new
                                class.<br>Set up your students and begin.</span>
                        </button>
                    </div>
                </div>

                <!-- PHASE 2: SETUP (shown after entry choice) -->
                <div id="setup-phase"
                    class="hidden bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">

                    <!-- Back button -->
                    <button id="btn-back-to-landing" type="button" onclick="window.showLanding && window.showLanding()"
                        class="text-muted-foreground hover:text-white text-sm font-bold mb-4 flex items-center gap-2 transition-colors">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>

                    <!-- Context banner (shown for returning teachers) -->
                    <div id="setup-context-banner"
                        class="hidden bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-circle-check text-emerald-400 text-lg mt-0.5"></i>
                            <div>
                                <p id="setup-context-text" class="text-sm font-bold text-white"></p>
                                <p id="setup-context-sub" class="text-xs text-emerald-300/70 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-black/20 rounded-xl border border-white/5 p-4 md:p-6 relative z-10 shadow-inner max-w-2xl mx-auto">

                        <!-- Class & Subject -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <!-- Target Class -->
                            <div class="space-y-2 group">
                                <label
                                    class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Class
                                    Name</label>
                                <div class="flex items-center gap-2">
                                    <div
                                        class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors flex-1 relative rounded-xl">
                                        <select id="target-class"
                                            class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-bold tracking-wide">
                                            <option value="" disabled selected class="bg-card">-- Select a Class --
                                            </option>
                                        </select>
                                        <i
                                            class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                        <div class="input-focus-anim rounded-xl"></div>
                                    </div>
                                    <button type="button" id="btn-open-paste-modal"
                                        class="shrink-0 bg-primary/20 hover:bg-primary/40 text-primary border border-primary/30 font-bold px-4 py-4 rounded-xl transition-all shadow-glow text-sm flex items-center gap-2"
                                        title="Add New Class">
                                        <i class="fa-solid fa-plus"></i> <span>Add Class</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Subject Select -->
                            <div class="space-y-2 focus-within:z-20 relative">
                                <label
                                    class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Subject
                                    Name</label>
                                <div class="flex gap-2 relative">
                                    <div
                                        class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors flex-1 relative rounded-xl">
                                        <select id="subject-name"
                                            class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-bold">
                                            <option value="" disabled selected class="bg-card">-- Select a Subject --
                                            </option>
                                            <option value="Mathematics" class="bg-card">Mathematics</option>
                                            <option value="English" class="bg-card">English</option>
                                            <option value="Basic Science" class="bg-card">Basic Science</option>
                                            <option value="Biology" class="bg-card">Biology</option>
                                            <option value="Chemistry" class="bg-card">Chemistry</option>
                                            <option value="Physics" class="bg-card">Physics</option>
                                            <option value="custom" class="bg-card">-- Custom Subject --</option>
                                        </select>
                                        <i
                                            class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                        <div class="input-focus-anim rounded-xl"></div>
                                    </div>
                                </div>
                                <div class="input-wrapper border border-white/10 bg-black/40 mt-2 hidden rounded-xl"
                                    id="custom-subject-wrapper">
                                    <input type="text" id="custom-subject"
                                        class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-bold tracking-wide"
                                        placeholder="e.g., History">
                                    <div class="input-focus-anim rounded-xl"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Assessment Type -->
                        <div id="assessment-type-container"
                            class="space-y-2 focus-within:z-20 relative mb-5 pt-4 border-t border-white/5 border-dashed">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Assessment
                                Type</label>
                            <div class="flex gap-2 relative">
                                <div
                                    class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors flex-[2] relative rounded-xl">
                                    <select id="assessment-type"
                                        class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-bold tracking-wide">
                                        <option value="" disabled selected class="bg-card">-- Select Assessment Type --
                                        </option>
                                        <option value="1st CA" class="bg-card">1st CA</option>
                                        <option value="2nd CA" class="bg-card">2nd CA</option>
                                        <option value="Exam" class="bg-card">Exam</option>
                                        <option value="Open Day" class="bg-card">Open Day</option>
                                        <option value="Assignment" class="bg-card">Assignment</option>
                                        <option value="custom" class="bg-card">-- Custom --</option>
                                    </select>
                                    <i
                                        class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                    <div class="input-focus-anim rounded-xl"></div>
                                </div>
                            </div>
                            <p id="assessment-hint" class="text-[10px] text-primary/70 pl-1 hidden"><i
                                    class="fa-solid fa-wand-magic-sparkles mr-1"></i><span></span></p>
                            <div class="input-wrapper border border-white/10 bg-black/40 mt-2 hidden rounded-xl"
                                id="custom-assessment-wrapper">
                                <input type="text" id="custom-assessment"
                                    class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-bold tracking-wide"
                                    placeholder="e.g., Final Project">
                                <div class="input-focus-anim rounded-xl"></div>
                            </div>
                        </div>

                        <!-- Enrollment: Who takes this subject? -->
                        <div id="enrollment-section" class="pt-4 border-t border-white/5 border-dashed mb-5 hidden">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1 mb-3">Who
                                takes this subject?</label>
                            <div class="flex rounded-xl overflow-hidden border border-white/10 bg-black/30">
                                <button type="button" id="btn-enroll-general"
                                    class="flex-1 py-3 px-4 text-xs font-bold transition-all text-white bg-primary/20 border-r border-white/10 flex items-center justify-center gap-2 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                                    <i class="fa-solid fa-users text-primary"></i> Everyone in Class
                                </button>
                                <button type="button" id="btn-enroll-selective"
                                    class="flex-1 py-3 px-4 text-xs font-bold transition-all text-muted-foreground hover:text-white flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-user-check text-yellow-400/50"></i> Only Some Students
                                </button>
                            </div>
                            <p id="enrollment-desc" class="text-[10px] text-muted-foreground/70 pl-1 mt-2">All students
                                take this subject</p>

                            <!-- Selective students inline container -->
                            <div id="selective-inline-container"
                                class="hidden mt-4 border border-yellow-500/30 rounded-xl p-4 md:p-6 bg-yellow-500/5 shadow-inner">
                                <label
                                    class="block text-[11px] font-bold text-yellow-500 uppercase tracking-widest mb-4 flex items-center">
                                    <i class="fa-solid fa-list-check mr-2"></i> Tick the students who take this subject
                                </label>

                                <div class="mb-5 border border-yellow-500/30 bg-black/40 hover:bg-yellow-500/10 rounded-xl p-4 cursor-pointer transition-all shadow-[0_0_15px_rgba(234,179,8,0.05)] hover:shadow-[0_0_20px_rgba(234,179,8,0.1)] flex items-center justify-center gap-2 group"
                                    onclick="document.getElementById('enrollment-list-file').click()">
                                    <i
                                        class="fa-solid fa-camera text-yellow-500 group-hover:scale-110 transition-transform"></i>
                                    <span class="text-[13px] font-bold text-yellow-500">Scan Handwritten List
                                        Instead</span>
                                    <input type="file" id="enrollment-list-file" accept="image/*, .pdf" class="hidden"
                                        onchange="document.getElementById('enrollment-file-label').innerText = this.files[0] ? this.files[0].name : '';">
                                </div>
                                <p id="enrollment-file-label"
                                    class="text-xs text-center text-yellow-400/80 mb-3 font-medium min-h-[16px]"></p>

                                <div id="selective-students-list"
                                    class="space-y-1 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    <div class="p-4 text-center text-sm text-yellow-500/60 font-medium">Select a class
                                        and subject first to view students.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Smart Mode Toggle -->
                        <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-3 mb-6">
                            <div class="flex items-center justify-between w-full cursor-pointer group"
                                id="btn-toggle-smart-mode">
                                <div>
                                    <label
                                        class="text-[11px] font-bold text-indigo-300 uppercase tracking-widest pl-1 block cursor-pointer flex items-center gap-2 group-hover:text-indigo-200 transition-colors">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI Smart Mode
                                    </label>
                                    <p class="text-[10px] text-indigo-200/50 pl-1 mt-0.5 max-w-[200px] leading-tight">
                                        Give the AI custom instructions.</p>
                                </div>
                                <div class="w-10 h-5 bg-black/50 rounded-full relative shadow-inner border border-white/10 transition-colors"
                                    id="smart-mode-switch-bg">
                                    <div class="w-3 h-3 bg-muted-foreground rounded-full absolute top-1 left-1 transition-all"
                                        id="smart-mode-switch-knob"></div>
                                </div>
                            </div>
                            <div id="smart-instruction-wrapper" class="hidden mt-3 animation-fade-in relative w-full">
                                <textarea id="smart-instruction-input" rows="2"
                                    class="w-full p-3 bg-black/40 border border-indigo-500/30 rounded-lg text-white text-xs outline-none placeholder:text-muted-foreground/50 focus:border-indigo-400 focus:bg-black/60 transition-all font-bold tracking-wide resize-none"
                                    placeholder="e.g., 'The final score is circled in red ink at the top of the page'"></textarea>
                            </div>
                        </div>

                        <!-- How to add scores -->
                        <div class="pt-6 border-t border-white/5">
                            <h3 class="text-lg font-heading font-bold text-white mb-4 tracking-tight text-center">How
                                would you like to add scores?</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button id="btn-start-camera" type="button"
                                    class="entry-card holographic btn-3d magnetic bg-black/40 hover:bg-primary/10 border border-white/10 hover:border-primary/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-glow relative overflow-hidden h-full">
                                    <div
                                        class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-camera text-primary text-xl"></i>
                                    </div>
                                    <span class="font-bold text-[15px] tracking-wide">I Have the Scripts</span>
                                    <span class="text-[11px] text-muted-foreground font-medium">Scan test papers one by
                                        line.<br>The AI reads name & score.</span>
                                </button>

                                <button id="btn-upload-scoresheet" type="button"
                                    class="entry-card holographic btn-3d bg-black/40 hover:bg-indigo-500/10 border border-white/10 hover:border-indigo-500/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-[0_0_20px_rgba(99,102,241,0.2)] relative overflow-hidden h-full">
                                    <div
                                        class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-file-invoice text-indigo-400 text-xl"></i>
                                    </div>
                                    <span class="font-bold text-[15px] tracking-wide">I Have a Score List</span>
                                    <span class="text-[11px] text-muted-foreground font-medium">Upload a photo of
                                        your<br>recorded grades.</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </section>

            <!-- Step 1: Capture Area -->
            <section id="capture-section"
                class="hidden reveal reveal-delay-1 bg-card rounded-[1.5rem] border border-white/5 p-2 md:p-6 mb-12 relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <!-- Inner subtle gradient for volume -->
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <!-- Header (Compact) -->
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h2 class="text-xl font-heading font-bold text-white tracking-tight flex items-center">
                        <span
                            class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center mr-3 border border-primary/20 shadow-glow"><i
                                class="fa-solid fa-camera text-primary text-sm"></i></span>
                        Capture Scripts
                    </h2>
                </div>

                <!-- Video Feed with Overlays -->
                <div id="video-container"
                    class="mb-6 border-2 border-primary/20 flex items-center justify-center bg-black shadow-inner overflow-hidden relative group z-10 rounded-2xl">
                    <video id="camera-feed" class="w-full h-full object-cover relative z-0" autoplay
                        playsinline></video>

                    <!-- OpenCV Canvas Visualizer -->
                    <canvas id="cv-visualizer"
                        class="absolute inset-0 w-full h-full z-10 pointer-events-none opacity-80 mix-blend-screen"></canvas>

                    <div id="camera-loading"
                        class="absolute z-20 text-muted-foreground text-sm flex flex-col items-center gap-3 bg-black/70 backdrop-blur-xl p-5 rounded-2xl border border-white/5">
                        <i class="fa-solid fa-circle-notch fa-spin text-primary text-3xl"></i>
                        <span class="font-medium tracking-wide">Initializing Camera...</span>
                    </div>

                    <!-- Top Overlays -->
                    <div
                        class="absolute top-3 left-3 right-3 flex justify-between items-start z-20 pointer-events-none">
                        <!-- Queue Count -->
                        <div
                            class="pointer-events-auto bg-black/60 backdrop-blur-md border border-white/10 text-[10px] font-semibold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm text-white uppercase tracking-widest hidden">
                            Queue
                            <span id="batch-count"
                                class="bg-primary text-white px-2 py-0.5 rounded-md text-[10px] font-bold shadow-glow border border-primary/30">0/10</span>
                        </div>

                        <div class="flex gap-2">
                            <!-- Flashlight Toggle -->
                            <button id="btn-flashlight"
                                class="pointer-events-auto w-10 h-10 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-white transition-all hover:scale-105 active:scale-95 shadow-sm flex items-center justify-center hidden">
                                <i class="fa-solid fa-bolt"></i>
                            </button>

                            <!-- Flip Camera -->
                            <button id="btn-camera"
                                class="pointer-events-auto w-10 h-10 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-white transition-all hover:scale-105 active:scale-95 shadow-sm flex items-center justify-center">
                                <i class="fa-solid fa-camera-rotate"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Bottom Overlays -->
                    <div class="absolute bottom-3 inset-x-3 flex justify-center z-20 pointer-events-none">
                        <!-- Auto-Capture Toggle -->
                        <div
                            class="pointer-events-auto flex items-center gap-3 bg-black/70 backdrop-blur-xl px-4 py-2.5 rounded-full border border-white/10 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.8)]">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-capture-toggle" class="sr-only peer">
                                <div
                                    class="w-9 h-5 bg-muted-foreground/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary shadow-inner">
                                </div>
                            </label>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-bold text-white tracking-widest uppercase leading-tight drop-shadow-md">AI
                                    Auto-Capture</span>
                            </div>
                            <div id="auto-capture-status"
                                class="ml-1 w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capture Controls (SNAP button full width) -->
                <div class="mb-6 relative z-10 px-2 lg:px-0">
                    <button id="btn-capture"
                        class="magnetic shadow-glow bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl w-full mx-auto transition-all active:scale-95 flex items-center justify-center tracking-wide overflow-hidden relative group">
                        <span
                            class="absolute inset-0 w-full h-full bg-white opacity-0 active:opacity-40 transition-opacity duration-100 mix-blend-overlay"></span>
                        <i class="fa-solid fa-camera mr-2 group-hover:scale-110 transition-transform"></i> <span
                            class="tracking-widest uppercase text-sm">Capture Script</span>
                    </button>
                </div>

                <!-- Captured Thumbnails -->
                <div id="thumbnails-container"
                    class="flex overflow-x-auto space-x-3 py-2 mb-6 min-h-[70px] relative z-10 scrollbar-hide"></div>

                <!-- Action Area / Action Zone Divider -->
                <div class="relative flex justify-center mt-6 mb-2 z-20 reveal reveal-delay-2">
                    <button id="btn-process" disabled
                        class="magnetic holographic shadow-glow-lg bg-card border border-white/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:bg-card disabled:holographic-none text-white font-extrabold text-sm uppercase px-10 py-5 rounded-full transition-all active:scale-95 flex items-center justify-center tracking-widest group">
                        <span
                            class="absolute inset-0 rounded-full border border-primary/30 group-hover:border-primary/60 transition-colors"></span>
                        <i
                            class="fa-solid fa-wand-magic-sparkles mr-2 text-primary group-hover:scale-110 transition-transform"></i>
                        Grade Scanned Scripts
                    </button>
                </div>

                <div id="processing-indicator"
                    class="hidden text-center mt-8 mb-4 text-primary font-medium flex flex-col items-center justify-center gap-3">
                    <div class="relative flex items-center justify-center p-2">
                        <div
                            class="absolute inset-0 border-2 border-primary/20 border-t-primary rounded-full animate-spin">
                        </div>
                        <i class="fa-solid fa-microchip text-primary"></i>
                    </div>
                    <span
                        class="text-xs font-bold tracking-widest uppercase border border-primary/20 bg-primary/10 px-5 py-2 rounded-full shadow-glow">AI
                        is Grading Papers...</span>
                </div>

            </section>

            <!-- Step 2: Review Area -->
            <section id="review-section"
                class="reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mt-16 mb-8 hidden relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <div
                    class="flex flex-col md:flex-row md:justify-between items-start md:items-center mb-10 gap-4 relative z-10">
                    <h2 class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight flex items-center">
                        <span
                            class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center mr-3 border border-white/10 shadow-sm"><i
                                class="fa-solid fa-list-check text-white text-sm"></i></span>
                        Review Grades
                    </h2>
                    <button id="btn-reset"
                        class="text-xs font-bold tracking-widest uppercase text-muted-foreground hover:text-white transition-colors px-4 py-2 rounded-lg border border-white/5 hover:border-white/20 bg-black/40 hover:bg-black/60 flex items-center shadow-sm">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Delete these & Start Over
                    </button>
                </div>

                <div class="overflow-x-visible md:overflow-x-auto mb-10 relative z-10">
                    <table class="w-full text-sm text-left block md:table">
                        <thead
                            class="hidden md:table-header-group text-[11px] uppercase bg-black/60 border-b border-white/5 tracking-widest font-bold text-muted-foreground/80">
                            <tr>
                                <th scope="col"
                                    class="px-5 py-4 w-12 text-center rounded-tl-xl border-r border-white/5">#</th>
                                <th scope="col" class="px-5 py-4 border-r border-white/5">Student Name <span
                                        class="text-primary">*</span></th>
                                <th scope="col" class="px-5 py-4 border-r border-white/5">Class</th>
                                <th scope="col" class="px-5 py-4 text-right rounded-tr-xl" id="score-th">Score</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="block md:table-row-group space-y-4 md:space-y-0">
                            <!-- Results go here via JS -->
                        </tbody>
                    </table>
                </div>

                <button id="btn-export"
                    class="magnetic holographic shadow-glow w-full bg-primary hover:bg-primary/90 text-white font-extrabold text-sm uppercase tracking-widest py-5 px-6 rounded-xl transition-all active:scale-95 flex justify-center items-center group relative z-10 border border-t-white/30 border-primary shadow-[0_4px_14px_0_rgba(var(--brand-rgb),0.39)]">
                    <i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Save
                    Grades to Active Roster
                </button>
                <div id="export-msg" class="text-center mt-5 text-sm font-bold hidden relative z-10"></div>

                <!-- Feedback / What's Next block -->
                <div id="whats-next-block"
                    class="hidden mt-8 pt-8 border-t border-white/5 animate-fade-in-up relative z-10">
                    <h3
                        class="text-white font-bold text-[11px] uppercase tracking-widest mb-2 flex items-center gap-2 text-indigo-400">
                        <i class="fa-solid fa-lightbulb"></i> What would you like to do next?
                    </h3>

                    <!-- Dynamic state messages will go here -->
                    <p id="whats-next-message" class="text-sm text-muted-foreground mb-4 font-medium leading-relaxed">
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="whats-next-actions">
                        <!-- Actions injected via JS based on context -->
                    </div>
                </div>
            </section>
            <!-- Step 3: Analytics Dashboard (Appears after export) -->
            <section id="analytics-section"
                class="hidden reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mb-12 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">
                <div class="flex items-center gap-3 mb-8">
                    <span
                        class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shadow-glow"><i
                            class="fa-solid fa-chart-pie text-emerald-400 text-sm"></i></span>
                    <h2 class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight">Class Statistics
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Average Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-chart-line text-4xl text-primary"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Class Average
                        </p>
                        <p id="stat-avg" class="text-4xl font-extrabold text-white">--</p>
                    </div>
                    <!-- Highest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-up text-4xl text-emerald-400"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Highest Score
                        </p>
                        <p id="stat-high" class="text-4xl font-extrabold text-emerald-400">--</p>
                        <p id="stat-high-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                    <!-- Lowest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-down text-4xl text-destructive"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Lowest Score
                        </p>
                        <p id="stat-low" class="text-4xl font-extrabold text-destructive">--</p>
                        <p id="stat-low-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="btn-download-sheet" onclick="window.location.href='/download-sheet'"
                        class="w-full md:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-glow flex items-center justify-center group mb-2 md:mb-0">
                        <i class="fa-solid fa-download mr-2 group-hover:translate-y-1 transition-transform"></i>
                        Download Complete Excel Sheet
                    </button>
                    <button id="btn-new-batch"
                        class="w-full md:w-auto bg-white/5 hover:bg-white/10 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-sm border border-white/10 flex items-center justify-center group">
                        <i
                            class="fa-solid fa-rotate-right mr-2 group-hover:-rotate-90 transition-transform duration-500"></i>
                        Scan More Papers
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer
            class="mt-20 mb-10 text-center text-muted-foreground/40 text-[10px] uppercase font-bold tracking-widest animate-fade-in-up flex items-center justify-center gap-2"
            style="animation-delay: 0.5s;">
            <div class="w-8 h-px bg-white/10"></div>
            <p>Made with <span class="text-destructive mx-1 animate-pulse inline-block opacity-80"></span> for <span
                    class="text-white/80">QSI</span></p>
            <div class="w-8 h-px bg-white/10"></div>
        </footer>
    </div>

    <!-- Modal: Upload Score List Photo -->
    <div id="upload-scoresheet-modal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm items-center justify-center p-4 transition-all duration-300 opacity-0 font-sans"
        onclick="if(event.target===this){this.classList.remove('flex');this.classList.add('hidden');}">
        <div
            class="bg-card w-full max-w-md rounded-2xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div
                class="px-6 py-4 border-b border-indigo-500/20 flex justify-between items-center bg-black/40 relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-transparent pointer-events-none">
                </div>
                <h3 class="text-lg font-heading font-bold text-white tracking-tight flex items-center relative z-10">
                    <i
                        class="fa-solid fa-file-invoice text-indigo-400 mr-3 text-xl drop-shadow-[0_0_10px_rgba(99,102,241,0.5)]"></i>
                    Upload Score List
                </h3>
                <button id="btn-close-scoresheet-modal"
                    class="text-muted-foreground hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5 relative z-10">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <p class="text-sm text-muted-foreground mb-6 text-center leading-relaxed">
                    Upload a clear photo of your handwritten score list. The AI will read all student names and scores
                    from the page.
                </p>
                <div class="border-2 border-dashed border-white/10 hover:border-indigo-500/30 rounded-xl p-6 text-center transition-colors cursor-pointer group"
                    onclick="document.getElementById('scoresheet-file').click()">
                    <i
                        class="fa-solid fa-cloud-arrow-up text-3xl text-indigo-400/50 group-hover:text-indigo-400 transition-colors mb-3 block"></i>
                    <p class="text-sm font-bold text-white/80">Tap to select photo</p>
                    <p class="text-[10px] text-muted-foreground mt-1">JPG, PNG, or HEIC</p>
                </div>
                <input type="file" id="scoresheet-file" accept="image/*" class="hidden">
                <p id="scoresheet-msg"
                    class="text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 hidden"></p>
            </div>
            <div class="p-6 border-t border-white/5 bg-black/20 shrink-0">
                <button type="button" id="btn-submit-scoresheet"
                    class="bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-4 rounded-xl w-full transition-all shadow-[0_0_20px_rgba(99,102,241,0.3)] flex items-center justify-center gap-2 group text-sm tracking-widest uppercase">
                    <i class="fa-solid fa-wand-magic-sparkles group-hover:scale-110 transition-transform"></i> Scan
                    Score List
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Upload Excel Score Sheet (Resume Grading) -->
    <div id="upload-xlsx-modal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm items-center justify-center p-4 transition-all duration-300 opacity-0 font-sans">
        <div
            class="bg-card w-full max-w-md rounded-2xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div
                class="px-6 py-4 border-b border-emerald-500/20 flex justify-between items-center bg-black/40 relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-transparent pointer-events-none">
                </div>
                <h3 class="text-lg font-heading font-bold text-white tracking-tight flex items-center relative z-10"><i
                        class="fa-solid fa-file-excel text-emerald-400 mr-3 text-xl drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]"></i>
                    Update Score List</h3>
                <button id="btn-close-xlsx-modal"
                    class="text-muted-foreground hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5 relative z-10"><i
                        class="fa-solid fa-xmark text-lg"></i></button>
            </div>

            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <p class="text-sm text-muted-foreground mb-6 text-center leading-relaxed">Select an existing Excel sheet
                    (e.g., from a previous session) to continue grading or bulk update scores. The system will
                    auto-detect columns.
                </p>
                <div class="space-y-1.5 focus-within:z-20 relative border border-emerald-500/30 bg-emerald-500/5 hover:bg-emerald-500/10 transition-colors rounded-xl p-6 border-dashed cursor-pointer shadow-[0_0_15px_rgba(16,185,129,0.05)] group flex flex-col items-center justify-center"
                    onclick="document.getElementById('xlsx-file').click()">
                    <i
                        class="fa-solid fa-file-arrow-up text-4xl text-emerald-400/80 mb-3 group-hover:-translate-y-1 transition-transform"></i>
                    <p class="text-[11px] font-bold text-white uppercase tracking-widest text-center">Select Excel
                        (.xlsx) / CSV</p>
                    <p class="text-xs text-muted-foreground mt-1 truncate px-2 text-center" id="xlsx-file-label">
                        Tap to choose file</p>
                    <input type="file" id="xlsx-file" accept=".xlsx, .xls, .csv" class="hidden"
                        onchange="document.getElementById('xlsx-file-label').innerText = this.files[0] ? this.files[0].name : 'Tap to choose file';">
                </div>
            </div>

            <div class="p-6 border-t border-white/5 bg-black/20 shrink-0">
                <button type="button" id="btn-submit-xlsx"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl w-full transition-all shadow-[0_0_15px_rgba(16,185,129,0.4)] flex items-center justify-center gap-2 group text-sm tracking-widest uppercase"><i
                        class="fa-solid fa-magnifying-glass-chart group-hover:scale-110 transition-transform"></i>
                    Update
                    Score List</button>
                <div id="xlsx-msg"
                    class="text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 text-white">
                </div>
            </div>
        </div>
    </div>

    <!-- Invisible Canvas for capturing image frames -->
    <canvas id="canvas" class="hidden"></canvas>

    <!-- Paste Roster Modal -->
    <div id="paste-modal"
        class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div
            class="bg-card w-full max-w-md mx-4 rounded-2xl border border-white/10 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.8)] p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-white font-bold text-lg tracking-wide"><i
                        class="fa-solid fa-paste text-primary mr-2"></i>Type or Paste Student Names</h3>
                <button id="btn-close-paste"
                    class="text-white/50 hover:text-white transition-colors w-8 h-8 flex justify-center items-center rounded-full hover:bg-white/10">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="space-y-2 group">
                    <label
                        class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Class
                        Name
                    </label>
                    <div class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                        <input type="text" id="paste-target-class"
                            class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide"
                            placeholder="e.g., JSS 1, SS 2A" required>
                        <div class="input-focus-anim"></div>
                    </div>
                </div>

                <div class="space-y-2 group">
                    <label
                        class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1 flex justify-between">
                        <span>Student Names</span>
                        <span class="text-primary/70">One per line</span>
                    </label>
                    <p class="text-[10px] text-yellow-500/80 px-1 mb-2 leading-tight">Must upload the <b>COMPLETE class
                            list</b> so the AI has 100% handwriting recognition accuracy.</p>
                    <div class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                        <textarea id="paste-raw-text" rows="8"
                            class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide resize-none"
                            placeholder="Ajayi Elizabeth&#x0a;Oluwatoyin Jewel&#x0a;..."></textarea>
                        <div class="input-focus-anim"></div>
                    </div>
                </div>

                <button id="btn-submit-paste"
                    class="magnetic w-full bg-primary hover:bg-primary/90 text-white font-bold py-3.5 rounded-xl transition-all shadow-glow mt-2 flex justify-center items-center">
                    Save Student Names
                </button>
            </div>
        </div>
    </div>

    <script>
        // 
        //  TOAST NOTIFICATION SYSTEM
        // 
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const icons = { success: 'fa-circle-check', warning: 'fa-triangle-exclamation', error: 'fa-circle-xmark', info: 'fa-circle-info' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${icons[type] || icons.info} toast-icon"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.remove(), 300)">
                    <i class="fa-solid fa-xmark"></i>
                </button>`;
            container.appendChild(toast);
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('toast-exit');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // 
        //  LANDING PAGE LOGIC
        // 
        document.addEventListener('DOMContentLoaded', function () {
            const landingPhase = document.getElementById('landing-phase');
            const setupPhase = document.getElementById('setup-phase');

            window.showLanding = function () {
                if (landingPhase) landingPhase.classList.remove('hidden');
                if (setupPhase) setupPhase.classList.add('hidden');
            };

            window.showSetup = function (contextText, contextSub) {
                if (landingPhase) landingPhase.classList.add('hidden');
                if (setupPhase) {
                    setupPhase.classList.remove('hidden');
                    setupPhase.style.opacity = '0';
                    setupPhase.style.transform = 'translateY(20px)';
                    requestAnimationFrame(() => {
                        setupPhase.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                        setupPhase.style.opacity = '1';
                        setupPhase.style.transform = 'translateY(0)';
                    });
                }
                const banner = document.getElementById('setup-context-banner');
                if (contextText && banner) {
                    document.getElementById('setup-context-text').textContent = contextText;
                    document.getElementById('setup-context-sub').textContent = contextSub || '';
                    banner.classList.remove('hidden');
                } else if (banner) {
                    banner.classList.add('hidden');
                }
            };

            // Back button
            const btnBackToLanding = document.getElementById('btn-back-to-landing');
            if (btnBackToLanding) btnBackToLanding.addEventListener('click', window.showLanding);

            // "Start Fresh" button
            const btnEntryFresh = document.getElementById('btn-entry-fresh');
            if (btnEntryFresh) {
                btnEntryFresh.addEventListener('click', () => {
                    window.showSetup(null);
                });
            }

            // "I Have My Excel" button
            const btnEntryExcel = document.getElementById('btn-entry-excel');
            const entryExcelUpload = document.getElementById('entry-excel-upload');
            if (btnEntryExcel && entryExcelUpload) {
                btnEntryExcel.addEventListener('click', () => entryExcelUpload.click());
                entryExcelUpload.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    btnEntryExcel.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-400"></i><span class="font-bold">Loading...</span>';
                    btnEntryExcel.disabled = true;

                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const response = await fetch('/api/upload-excel-scorelist', { method: 'POST', body: formData });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'Failed to parse file');

                        const tc = document.getElementById('target-class');
                        if (result.detected_class && tc) {
                            let found = false;
                            for (let opt of tc.options) {
                                if (opt.value.toLowerCase() === result.detected_class.toLowerCase()) {
                                    tc.value = opt.value; found = true; break;
                                }
                            }
                            if (!found) tc.add(new Option(result.detected_class, result.detected_class, true, true));
                        }

                        if (result.detected_subject) {
                            const sj = document.getElementById('subject-name');
                            const csj = document.getElementById('custom-subject');
                            const csjw = document.getElementById('custom-subject-wrapper');
                            if (sj) { sj.value = 'custom'; if (csjw) csjw.classList.remove('hidden'); if (csj) csj.value = result.detected_subject; }
                        }

                        if (result.detected_assessments && result.detected_assessments.length > 0) {
                            const order = ['1st CA', '2nd CA', 'Exam'];
                            let next = 'Score';
                            for (const a of order) { if (!result.detected_assessments.includes(a)) { next = a; break; } }
                            const at = document.getElementById('assessment-type');
                            if (at) at.value = next;
                            const hint = document.getElementById('assessment-hint');
                            if (hint) {
                                hint.classList.remove('hidden');
                                hint.querySelector('span').textContent = `You have ${result.detected_assessments.join(', ')} scores. Suggesting ${next}.`;
                            }
                        }

                        const studentCount = result.records ? result.records.length : 0;
                        const className = result.detected_class || 'your class';
                        const existingAssessments = result.detected_assessments ? result.detected_assessments.join(', ') : '';
                        const ctxSub = existingAssessments ? `Existing scores: ${existingAssessments}` : '';
                        window.showSetup(`Found ${studentCount} students in ${className}.`, ctxSub);
                        showToast(`Loaded ${studentCount} students from Excel.`, 'success');
                        window._excelRecords = result.records;

                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    } finally {
                        btnEntryExcel.innerHTML = '<div class="w-14 h-14 rounded-2xl bg-emerald-500/15 flex items-center justify-center mb-1 border border-emerald-500/20"><i class="fa-solid fa-file-excel text-emerald-400 text-2xl"></i></div><span class="font-bold text-[15px] tracking-wide">I Have My Excel</span><span class="text-[11px] text-muted-foreground font-medium leading-tight">Continue from where you left off.<br>Upload your previous score sheet.</span>';
                        btnEntryExcel.disabled = false;
                        entryExcelUpload.value = '';
                    }
                });
            }

            // Load recent sessions
            loadRecentSessions();
        });

        // Elements
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnCapture = document.getElementById('btn-capture');
        const btnSwitchCam = document.getElementById('btn-camera');
        const btnProcess = document.getElementById('btn-process');
        const loadingIndicator = document.getElementById('camera-loading');
        const batchCountEl = document.getElementById('batch-count');
        const thumbnailsContainer = document.getElementById('thumbnails-container');
        const processingIndicator = document.getElementById('processing-indicator');

        const captureSection = document.getElementById('capture-section');
        const reviewSection = document.getElementById('review-section');
        const analyticsSection = document.getElementById('analytics-section');
        const tbody = document.getElementById('results-tbody');
        const btnReset = document.getElementById('btn-reset');
        const btnExport = document.getElementById('btn-export');
        const exportMsg = document.getElementById('export-msg');
        const btnNewBatch = document.getElementById('btn-new-batch');

        // Auto-Capture Elements
        const autoCaptureToggle = document.getElementById('auto-capture-toggle');
        const autoCaptureStatus = document.getElementById('auto-capture-status');

        // Start Section Elements
        const startSection = document.getElementById('start-section');
        const btnStartCamera = document.getElementById('btn-start-camera');

        // Target Class validation before scanning
        btnStartCamera.addEventListener('click', () => {
            const classSelect = document.getElementById('target-class');
            if (!classSelect.value) {
                showToast('Please select a Target Class before starting.', 'warning');
                return;
            }
            const subjSelect = document.getElementById('subject-name');
            if (!subjSelect || !subjSelect.value || subjSelect.value === '') {
                showToast('Please select a Subject first.', 'warning');
                return;
            }
            const assessmentSelect = document.getElementById('assessment-type');
            if (!assessmentSelect || !assessmentSelect.value || assessmentSelect.value === '') {
                showToast('Please select an Assessment Type first.', 'warning');
                return;
            }

            // Apply a loading state
            btnStartCamera.disabled = true;
            btnStartCamera.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i><span>Initializing...</span>`;

            // Immediate UI transition
            startSection.classList.add('hidden');
            captureSection.classList.remove('hidden');

            // Start the actual Camera
            initCamera();
        });

        // Config Elements
        const targetClassSelect = document.getElementById('target-class');

        // Upload Scoresheet button handler
        const btnUploadSheet = document.getElementById('btn-upload-scoresheet');
        if (btnUploadSheet) {
            btnUploadSheet.addEventListener('click', () => {
                const classSelect = document.getElementById('target-class');
                if (!classSelect || !classSelect.value) {
                    showToast('Please select a Target Class first.', 'warning');
                    return;
                }
                const modal = document.getElementById('upload-scoresheet-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                }
            });
        }
        const subjectNameSelect = document.getElementById('subject-name');
        const customSubjectWrapper = document.getElementById('custom-subject-wrapper');
        const customSubjectInput = document.getElementById('custom-subject');

        const assessmentTypeSelect = document.getElementById('assessment-type');
        const customAssessmentWrapper = document.getElementById('custom-assessment-wrapper');
        const customAssessmentInput = document.getElementById('custom-assessment');
        const scoreTh = document.getElementById('score-th');

        // Analytics Elements
        const statAvg = document.getElementById('stat-avg');
        const statHigh = document.getElementById('stat-high');
        const statHighName = document.getElementById('stat-high-name');
        const statLow = document.getElementById('stat-low');
        const statLowName = document.getElementById('stat-low-name');

        // State
        let imagesBatch = [];
        let extractedData = [];
        let currentFacingMode = 'environment';
        let stream = null;
        let imageIdCounter = 0;
        let finalAssessmentType = '';


        async function initCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            loadingIndicator.classList.remove('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    loadingIndicator.classList.add('hidden');
                };
            } catch (err) {
                console.error("Camera error:", err);
                loadingIndicator.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-destructive text-3xl mb-3 block"></i><span class="text-sm font-bold text-destructive">Camera Access Denied</span>`;
            }
        }

        // Smart Image Compression: only downscale if > MAX_WIDTH, preserving quality for low-end cameras
        const COMPRESS_MAX_WIDTH = 1600;
        const COMPRESS_QUALITY = 0.85;
        function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // If image is already small enough, skip compression entirely
                    if (img.width <= COMPRESS_MAX_WIDTH) {
                        resolve(base64Str);
                        return;
                    }
                    const ratio = COMPRESS_MAX_WIDTH / img.width;
                    const newW = COMPRESS_MAX_WIDTH;
                    const newH = Math.round(img.height * ratio);
                    const offscreen = document.createElement('canvas');
                    offscreen.width = newW;
                    offscreen.height = newH;
                    const octx = offscreen.getContext('2d');
                    octx.drawImage(img, 0, 0, newW, newH);
                    resolve(offscreen.toDataURL('image/jpeg', COMPRESS_QUALITY));
                };
                img.src = base64Str;
            });
        }

        // Initialization
        async function initCamera() {
            loadingIndicator.classList.remove('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                // Define loader removal handler BEFORE assigning the stream
                video.onloadedmetadata = () => {
                    loadingIndicator.classList.add('hidden');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                video.srcObject = stream;

                // Fallback in case onloadedmetadata fails to fire
                setTimeout(() => {
                    if (!loadingIndicator.classList.contains('hidden')) {
                        // If video width > 0, it means it loaded but didn't fire
                        if (video.videoWidth > 0) {
                            loadingIndicator.classList.add('hidden');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        }
                    }
                }, 2000);

                // Torch/Flashlight Capability Check
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities && track.getCapabilities();
                const btnFlashlight = document.getElementById('btn-flashlight');
                if (capabilities && capabilities.torch) {
                    btnFlashlight.classList.remove('hidden');
                } else {
                    btnFlashlight.classList.add('hidden');
                }
            } catch (err) {
                console.error("Error accessing camera:", err);
                loadingIndicator.classList.add('hidden');

                // Show a visible error message on the screen instead of just text
                const vc = document.getElementById('video-container');
                vc.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-8 text-center bg-black/80 rounded-2xl border border-destructive/30 backdrop-blur-sm m-4">
                        <div class="w-20 h-20 rounded-full bg-destructive/20 flex items-center justify-center mb-4 border border-destructive/40 shadow-[0_0_30px_rgba(239,68,68,0.3)]">
                            <i class="fa-solid fa-camera-slash text-destructive text-3xl"></i>
                        </div>
                        <h3 class="text-white text-xl font-bold mb-2 tracking-wide">Camera Access Failed</h3>
                        <p class="text-sm text-destructive/90 mb-6 font-medium max-w-sm">We couldn't access your camera. Please check your browser permissions or ensure a camera is connected.</p>
                        
                        <div class="bg-black/50 rounded-lg p-3 w-full border border-white/5 mb-6 text-left">
                            <p class="text-[10px] text-muted-foreground uppercase font-bold tracking-widest mb-1">Technical Details</p>
                            <p class="text-xs text-white/70 font-mono">${err.name || 'Error'}: ${err.message}</p>
                        </div>
                        
                        <button onclick="location.reload()" class="magnetic w-full py-3.5 bg-destructive/20 text-destructive border border-destructive/30 rounded-xl hover:bg-destructive/30 transition-all font-bold tracking-widest text-sm uppercase shadow-inner">
                            <i class="fa-solid fa-rotate-right mr-2 group-hover:rotate-180 transition-transform duration-500"></i>Reload Page
                        </button>
                    </div>
                `;
                showToast("Camera access denied or unavailable.", "error", 6000);
            }
        }

        // Flashlight Toggle Logic
        let flashEnabled = false;
        const btnFlashlight = document.getElementById('btn-flashlight');
        btnFlashlight.addEventListener('click', async () => {
            if (!stream) return;
            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities && track.getCapabilities();
            if (capabilities && capabilities.torch) {
                flashEnabled = !flashEnabled;
                try {
                    await track.applyConstraints({
                        advanced: [{ torch: flashEnabled }]
                    });
                    if (flashEnabled) {
                        btnFlashlight.classList.remove('bg-black/60', 'text-white');
                        btnFlashlight.classList.add('bg-yellow-500', 'text-black');
                        btnFlashlight.innerHTML = '<i class="fa-solid fa-bolt text-black"></i>';
                    } else {
                        btnFlashlight.classList.remove('bg-yellow-500', 'text-black');
                        btnFlashlight.classList.add('bg-black/60', 'text-white');
                        btnFlashlight.innerHTML = '<i class="fa-solid fa-bolt"></i>';
                    }
                } catch (e) {
                    console.error("Could not toggle flashlight:", e);
                }
            }
        });

        // Capture Image
        function compressImage(base64Str, maxWidth = 1200, quality = 0.85) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.floor(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        }

        function captureFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const rawBase64 = canvas.toDataURL('image/jpeg', 0.9); // Capture at high quality first
            const imageId = imageIdCounter++;
            const base64ForPreview = canvas.toDataURL('image/jpeg', 0.5); // Fast low res preview

            // Compress asynchronously (won't block the UI)
            compressImage(rawBase64).then(compressedBase64 => {
                imagesBatch.push({ id: imageId, base64: compressedBase64 });
                batchCountEl.innerText = imagesBatch.length;
                btnProcess.disabled = false;
            });

            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'relative flex-shrink-0 group mt-2';
            thumbDiv.dataset.id = imageId;

            const img = document.createElement('img');
            img.src = base64ForPreview;
            img.className = 'captured-thumb shadow-sm group-hover:border-primary/50 transition-colors';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'absolute -top-2 -right-2 bg-black backdrop-blur-md hover:bg-destructive text-white border border-white/20 rounded-full w-6 h-6 flex items-center justify-center text-[10px] shadow-lg z-10 transition-all transform hover:scale-110';
            cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
            cancelBtn.title = 'Remove image';
            cancelBtn.onclick = function () {
                imagesBatch = imagesBatch.filter(item => item.id !== imageId);
                batchCountEl.innerText = imagesBatch.length;
                thumbDiv.remove();
                if (imagesBatch.length === 0) {
                    btnProcess.disabled = true;
                }
            };

            thumbDiv.appendChild(img);
            thumbDiv.appendChild(cancelBtn);
            thumbnailsContainer.appendChild(thumbDiv);

            if (navigator.vibrate) navigator.vibrate(50);

            // Shutter flash effect
            const container = document.getElementById('video-container');
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white z-50 mix-blend-overlay';
            container.appendChild(flash);
            setTimeout(() => {
                flash.style.transition = 'opacity 0.2s';
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 200);
            }, 50);
        }

        btnCapture.addEventListener('click', captureFrame);

        // 
        //  AUTO-CAPTURE v3: Document-Presence-First Architecture
        //  Instead of waiting for "stillness" (which fails with hand tremor),
        //  we continuously scan for a document and trigger after N consecutive
        //  detections. This is how CamScanner/Google Lens work.
        // 
        let scanIntervalId = null;
        let consecutiveDetections = 0;
        const SCAN_INTERVAL_MS = 160;        // ~6 FPS OpenCV scans
        const DETECTIONS_TO_SNAP = 8;        // 8 consecutive = ~1.3s of seeing paper
        const COOLDOWN_AFTER_SNAP_MS = 3000; // 3s pause after snap to swap paper

        function scanForDocument() {
            const hudCanvas = document.getElementById('cv-visualizer');
            if (!hudCanvas) return false;

            const vw = video.videoWidth || 640;
            const vh = video.videoHeight || 480;
            hudCanvas.width = vw;
            hudCanvas.height = vh;
            const hudCtx = hudCanvas.getContext('2d');
            hudCtx.clearRect(0, 0, vw, vh);

            if (!video.videoWidth) return false;

            // Use a small canvas for fast pixel analysis
            const aw = 160, ah = 120;
            const ac = document.createElement('canvas');
            ac.width = aw; ac.height = ah;
            const actx = ac.getContext('2d', { willReadFrequently: true });

            try {
                actx.drawImage(video, 0, 0, aw, ah);
                const imgData = actx.getImageData(0, 0, aw, ah).data;

                //  CENTER vs EDGE BRIGHTNESS 
                // When holding paper: center is BRIGHT (white paper), edges are DARK (background)
                // When pointing at floor/wall: brightness is UNIFORM everywhere
                // We measure the ratio to distinguish them.

                const margin = 0.2; // 20% border ring
                let centerSum = 0, centerCount = 0;
                let edgeSum = 0, edgeCount = 0;
                let centerR = 0, centerG = 0, centerB = 0;

                for (let y = 0; y < ah; y++) {
                    for (let x = 0; x < aw; x++) {
                        const idx = (y * aw + x) * 4;
                        const r = imgData[idx], g = imgData[idx + 1], b = imgData[idx + 2];
                        const brightness = (r + g + b) / 3;

                        const inCenterX = x > aw * margin && x < aw * (1 - margin);
                        const inCenterY = y > ah * margin && y < ah * (1 - margin);

                        if (inCenterX && inCenterY) {
                            centerSum += brightness;
                            centerR += r; centerG += g; centerB += b;
                            centerCount++;
                        } else {
                            edgeSum += brightness;
                            edgeCount++;
                        }
                    }
                }

                if (centerCount === 0 || edgeCount === 0) return false;

                const centerBright = centerSum / centerCount;
                const edgeBright = edgeSum / edgeCount;
                const avgR = centerR / centerCount;
                const avgG = centerG / centerCount;
                const avgB = centerB / centerCount;

                //  GATE 1: Center must be reasonably bright (paper is white/cream) 
                // This rejects dark scenes entirely
                if (centerBright < 130) return false;

                //  GATE 2: Center-to-Edge Brightness Ratio 
                // Paper held by hand: center ~180, edge ~90 = ratio 2.0
                // Floor tiles: center ~140, edge ~140 = ratio 1.0
                // We want ratio > 1.2
                const ratio = edgeBright > 0 ? centerBright / edgeBright : 0;
                if (ratio < 1.2) return false;

                //  GATE 3: Skin-tone rejection 
                // Paper center: R - B < 30 (neutral white/gray)
                // Skin center: R - B > 30 (warm tones)
                const warmth = avgR - avgB;
                if (warmth > 30) return false;

                //  GATE 4: Center must have texture (not a blank white wall) 
                // Count how many center pixels deviate significantly from the mean
                let textureCount = 0;
                for (let y = Math.floor(ah * margin); y < Math.floor(ah * (1 - margin)); y++) {
                    for (let x = Math.floor(aw * margin); x < Math.floor(aw * (1 - margin)); x++) {
                        const idx = (y * aw + x) * 4;
                        const brightness = (imgData[idx] + imgData[idx + 1] + imgData[idx + 2]) / 3;
                        if (Math.abs(brightness - centerBright) > 25) textureCount++;
                    }
                }
                const textureRatio = textureCount / centerCount;
                // Paper with ink: ~15-40% pixels deviate. Blank wall: <5%
                if (textureRatio < 0.08) return false;

                //  ALL GATES PASSED: Draw targeting HUD 
                const pad = 0.18; // 18% inset for the targeting box
                const bx = vw * pad, by = vh * pad;
                const bw = vw * (1 - 2 * pad), bh = vh * (1 - 2 * pad);

                // Dashed green rectangle
                hudCtx.strokeStyle = '#10b981';
                hudCtx.lineWidth = 2;
                hudCtx.shadowColor = '#10b981';
                hudCtx.shadowBlur = 10;
                hudCtx.setLineDash([10, 6]);
                hudCtx.strokeRect(bx, by, bw, bh);

                // Solid corner brackets
                hudCtx.setLineDash([]);
                hudCtx.lineWidth = 4;
                const cLen = 25;
                // Top-left
                hudCtx.beginPath(); hudCtx.moveTo(bx, by + cLen); hudCtx.lineTo(bx, by); hudCtx.lineTo(bx + cLen, by); hudCtx.stroke();
                // Top-right
                hudCtx.beginPath(); hudCtx.moveTo(bx + bw - cLen, by); hudCtx.lineTo(bx + bw, by); hudCtx.lineTo(bx + bw, by + cLen); hudCtx.stroke();
                // Bottom-left
                hudCtx.beginPath(); hudCtx.moveTo(bx, by + bh - cLen); hudCtx.lineTo(bx, by + bh); hudCtx.lineTo(bx + cLen, by + bh); hudCtx.stroke();
                // Bottom-right
                hudCtx.beginPath(); hudCtx.moveTo(bx + bw - cLen, by + bh); hudCtx.lineTo(bx + bw, by + bh); hudCtx.lineTo(bx + bw, by + bh - cLen); hudCtx.stroke();

                return true;

            } catch (e) {
                console.error("Scan error:", e);
                return false;
            }
        }

        function autoCaptureLoop() {
            if (!autoCaptureToggle.checked) return;

            const found = scanForDocument();

            if (found) {
                consecutiveDetections++;
                // Show progress: yellow  orange  green as we approach snap
                const progress = consecutiveDetections / DETECTIONS_TO_SNAP;
                if (progress < 0.5) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-yellow-500 transition-colors shadow-glow';
                } else if (progress < 1) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-orange-500 transition-colors shadow-glow animate-pulse';
                }

                if (consecutiveDetections >= DETECTIONS_TO_SNAP) {
                    // SNAP!
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-emerald-500 transition-colors shadow-glow ring-2 ring-emerald-500/50';
                    captureFrame();
                    consecutiveDetections = 0;

                    // Cooldown: pause scanning to let user swap paper
                    if (scanIntervalId) clearInterval(scanIntervalId);
                    setTimeout(() => {
                        if (autoCaptureToggle.checked) {
                            consecutiveDetections = 0;
                            scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
                        }
                    }, COOLDOWN_AFTER_SNAP_MS);
                    return;
                }
            } else {
                // Reset streak  paper left the frame or no document detected
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-blue-500/50 transition-colors shadow-glow';
            }
        }

        autoCaptureToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                consecutiveDetections = 0;
                scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
            } else {
                if (scanIntervalId) clearInterval(scanIntervalId);
                scanIntervalId = null;
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow';
                const hudCanvas = document.getElementById('cv-visualizer');
                if (hudCanvas) {
                    const hudCtx = hudCanvas.getContext('2d');
                    hudCtx.clearRect(0, 0, hudCanvas.width, hudCanvas.height);
                }
            }
        });

        // Switch Camera
        btnSwitchCam.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera();
        });

        // Process Batch (Send to Backend)
        btnProcess.addEventListener('click', async () => {
            if (imagesBatch.length === 0) return;

            // Turn off camera and flashlight to indicate scanning is done
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            const originalHtml = btnProcess.innerHTML;
            btnProcess.disabled = true;
            btnCapture.disabled = true;
            btnProcess.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Grading Scanned Scripts...`;

            // Show new fun loading overlay
            const loadingOverlay = document.getElementById('grading-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('flex');
            }

            try {
                const base64List = imagesBatch.map(item => item.base64);
                const targetClassVal = document.getElementById('target-class').value.trim();

                finalAssessmentType = assessmentTypeSelect.value === 'custom'
                    ? (customAssessmentInput.value.trim() || 'Score')
                    : assessmentTypeSelect.value;
                scoreTh.innerText = finalAssessmentType;

                captureSection.classList.add('hidden');
                reviewSection.classList.remove('hidden');

                // Initialize empty table and array OR prepare for appending
                const isAppending = extractedData && extractedData.length > 0;

                if (!isAppending) {
                    tbody.innerHTML = '';
                    extractedData = new Array(base64List.length).fill({});
                } else {
                    // We are appending/merging to an existing roster
                    // Keep the names, clear out old scores if they exist (or keep them?)
                    // Usually we want to just overwrite the newly scanned ones.
                }

                // Check Smart Mode
                const smartSwitchBg = document.getElementById('smart-mode-switch-bg');
                const isSmartMode = smartSwitchBg && smartSwitchBg.classList.contains('bg-indigo-500');
                const smartInstruction = isSmartMode ? document.getElementById('smart-instruction-input').value.trim() : "";

                const response = await fetch('/upload-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: base64List,
                        targetClass: targetClassVal,
                        smartInstruction: smartInstruction
                    })
                });

                if (!response.ok) {
                    let errStr = "Server error";
                    try {
                        const errData = await response.json();
                        errStr = errData.error || errStr;
                    } catch (e) { }
                    throw new Error(errStr);
                }

                // Hide overlay once connection is established and data stream starts
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }

                // Read SSE Stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        // All chunks received, show "What's Next"
                        const nextBlock = document.getElementById('whats-next-block');
                        if (nextBlock) nextBlock.classList.remove('hidden');
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep the last incomplete chunk in the buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') {
                                const nextBlock = document.getElementById('whats-next-block');
                                if (nextBlock) nextBlock.classList.remove('hidden');
                                continue;
                            }
                            try {
                                const parsed = JSON.parse(dataStr);
                                const idx = parsed.index;
                                const item = parsed.result;

                                if (isAppending) {
                                    // Fuzzy match this scanned 'item' against the existing extractedData array
                                    let bestMatchIdx = -1;
                                    let highestScore = 0;
                                    const scannedName = (item.name || "").toLowerCase();

                                    for (let i = 0; i < extractedData.length; i++) {
                                        const existingName = (extractedData[i].name || "").toLowerCase();
                                        // Simple inclusion fuzzy match for demo
                                        if (existingName && scannedName && (existingName.includes(scannedName) || scannedName.includes(existingName))) {
                                            bestMatchIdx = i;
                                            break;
                                        }
                                    }

                                    if (bestMatchIdx !== -1) {
                                        // Update the score of the existing student
                                        extractedData[bestMatchIdx].score = item.score;
                                        extractedData[bestMatchIdx].confidence = item.confidence; // Optional
                                        // Update the DOM for that specific row
                                        const rowInputs = tbody.querySelectorAll(`input[data-index="${bestMatchIdx}"][data-field="score"]`);
                                        if (rowInputs && rowInputs.length > 0) {
                                            rowInputs[0].value = item.score;
                                            // Add a brief glow effect
                                            rowInputs[0].classList.add('ring-2', 'ring-emerald-500', 'bg-emerald-500/20');
                                            setTimeout(() => {
                                                rowInputs[0].classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-500/20');
                                            }, 1500);
                                        }
                                    } else {
                                        // If no match found, append as a new row at the bottom
                                        const newIdx = extractedData.length;
                                        extractedData.push(item);
                                        renderSingleRow(item, newIdx);
                                    }

                                } else {
                                    extractedData[idx] = item;
                                    renderSingleRow(item, idx);
                                }
                            } catch (e) {
                                console.error("Error parsing SSE data:", e, dataStr);
                            }
                        }
                    }
                }

            } catch (err) {
                console.error("Processing error:", err);
                showToast(`Error processing images: ${err.message}`, 'error');
                btnProcess.innerHTML = originalHtml;
                btnProcess.disabled = false;
                btnCapture.disabled = false;
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }
                reviewSection.classList.add('hidden');
                captureSection.classList.remove('hidden');
                // Restart camera if it failed to process so they aren't stuck on a black screen
                initCamera();
            }
        });

        function renderSingleRow(item, index) {
            const tr = document.createElement('tr');

            // Confidence-based styling
            const confidence = (item.confidence || 'high').toLowerCase();
            const isLow = confidence === 'low';
            const isMedium = confidence === 'medium';

            let borderClass = 'border-white/5';
            let confidenceBadge = '';
            if (isLow) {
                borderClass = 'border-destructive/40 ring-1 ring-destructive/20';
                confidenceBadge = `<span class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-destructive bg-destructive/10 border border-destructive/20 px-2 py-0.5 rounded-full ml-2"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> Low</span>`;
            } else if (isMedium) {
                borderClass = 'border-yellow-500/30 ring-1 ring-yellow-500/10';
                confidenceBadge = `<span class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-yellow-400 bg-yellow-500/10 border border-yellow-500/20 px-2 py-0.5 rounded-full ml-2"><i class="fa-solid fa-circle-exclamation text-[8px]"></i> Med</span>`;
            }

            tr.className = `reveal light-beam-card flex flex-col md:table-row bg-background md:bg-transparent rounded-xl md:rounded-none border ${borderClass} md:border-none md:border-b md:border-white/5 transition-colors group overflow-hidden md:hover:bg-white/[0.02] p-4 md:p-0 my-3 md:my-0 shadow-lg md:shadow-none translate-y-4 opacity-0 transition-all duration-500 hidden`;

            const nameStr = item.name || '';
            const classStr = item.class || '';
            const scoreStr = item.score || '';

            tr.innerHTML = `
            <td class="flex justify-between items-center md:table-cell px-2 md:px-5 py-2 md:py-4 border-b border-white/5 md:border-none text-muted-foreground/50 font-mono text-xs"><span class="md:hidden font-bold text-white/40 uppercase tracking-widest text-[10px]">ID</span> ${index + 1}${confidenceBadge}</td>
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold">Student Identity <span class="text-primary">*</span></span><input type="text" data-index="${index}" data-field="name" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm font-semibold transition-colors outline-none placeholder:text-muted-foreground/30" value="${nameStr}" placeholder="Enter Name"></td>
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold">Class</span><input type="text" data-index="${index}" data-field="class" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm transition-colors outline-none placeholder:text-muted-foreground/30 font-medium" value="${classStr}" placeholder="Class"></td>
            <td class="flex justify-between items-center md:table-cell px-2 md:px-5 py-4 bg-black/40 md:bg-transparent -mx-4 px-6 md:mx-0 mt-2 md:mt-0 rounded-b-xl md:rounded-none md:border-l md:border-white/5"><span class="md:hidden text-[11px] text-primary uppercase tracking-widest font-extrabold">Final Score</span><input type="text" data-index="${index}" data-field="score" class="w-24 md:w-full md:min-w-[70px] bg-white/[0.04] md:bg-transparent border border-white/10 md:border-none md:border-b md:border-transparent focus:border-primary/50 focus:bg-primary/5 focus:ring-0 md:px-2 py-2 text-primary md:text-foreground text-right font-bold text-lg md:text-sm rounded-lg md:rounded-none transition-colors outline-none placeholder:text-muted-foreground/30 shadow-inner md:shadow-none" value="${scoreStr}" placeholder="Score"></td>
            `;

            // Insert in order
            const rows = Array.from(tbody.children);
            let inserted = false;
            for (let i = 0; i < rows.length; i++) {
                const rowInput = rows[i].querySelector('input[data-index]');
                if (rowInput) {
                    const rowIndex = parseInt(rowInput.getAttribute('data-index'), 10);
                    if (index < rowIndex) {
                        tbody.insertBefore(tr, rows[i]);
                        inserted = true;
                        break;
                    }
                }
            }
            if (!inserted) {
                tbody.appendChild(tr);
            }

            // Bind events
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'), 10);
                    const field = e.target.getAttribute('data-field');
                    extractedData[idx][field] = e.target.value;
                });
            });

            // Animate in progressively
            requestAnimationFrame(() => {
                tr.classList.remove('hidden');
                requestAnimationFrame(() => {
                    tr.classList.remove('translate-y-4', 'opacity-0');
                    tr.classList.add('visible');
                });
            });
        }

        // Analytics Calculation
        function calculateAnalytics(data) {
            let validScores = [];
            let high = { score: -1, name: '' };
            let low = { score: 999999, name: '' };

            data.forEach(item => {
                const s = parseFloat(item.score);
                if (!isNaN(s)) {
                    validScores.push(s);
                    if (s > high.score) { high.score = s; high.name = item.name || ''; }
                    if (s < low.score) { low.score = s; low.name = item.name || ''; }
                }
            });

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                const avg = (sum / validScores.length).toFixed(1);
                statAvg.innerText = avg;

                statHigh.innerText = high.score;
                statHighName.innerText = high.name;

                statLow.innerText = low.score;
                statLowName.innerText = low.name;

                // Trigger Confetti for Perfect Scores
                const rawHasPerfect = data.some(item => {
                    if (!item.score) return false;
                    const str = String(item.score).trim();
                    return str === '100' || str.startsWith('100/') || str === '10/10' || str === '20/20';
                });

                if (rawHasPerfect && typeof confetti === 'function') {
                    const duration = 2500;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({
                            particleCount: 5,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24'] // brand colors
                        });
                        confetti({
                            particleCount: 5,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24']
                        });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                }

            } else {
                statAvg.innerText = '--';
                statHigh.innerText = '--';
                statHighName.innerText = '--';
                statLow.innerText = '--';
                statLowName.innerText = '--';
            }
        }

        // Export to Excel / Sheets
        btnExport.addEventListener('click', async () => {
            btnExport.disabled = true;
            btnExport.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> APPENDING...`;
            exportMsg.classList.add('hidden');

            try {
                const response = await fetch('/export-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        results: extractedData,
                        assessmentType: finalAssessmentType
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Export failed");

                exportMsg.classList.remove('hidden', 'text-destructive');
                exportMsg.classList.add('text-primary');
                exportMsg.innerHTML = `<i class="fa-solid fa-circle-check mr-2"></i> ${data.message}`;

                // Show Analytics Dashboard
                calculateAnalytics(extractedData);
                reviewSection.classList.add('hidden');
                analyticsSection.classList.remove('hidden');

            } catch (err) {
                console.error("Export error:", err);
                exportMsg.classList.remove('hidden', 'text-primary');
                exportMsg.classList.add('text-destructive');
                exportMsg.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> Error: ${err.message}`;
            } finally {
                btnExport.disabled = false;
                btnExport.innerHTML = `<i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Compile To Dashboard`;
            }
        });

        // Start Next Batch
        btnNewBatch.addEventListener('click', () => {
            imagesBatch = [];
            extractedData = [];
            batchCountEl.innerText = '0';
            thumbnailsContainer.innerHTML = '';
            exportMsg.classList.add('hidden');

            const nextBlock = document.getElementById('whats-next-block');
            if (nextBlock) nextBlock.classList.add('hidden');

            btnProcess.disabled = true;
            btnCapture.disabled = false;

            analyticsSection.classList.add('hidden');
            reviewSection.classList.add('hidden');
            captureSection.classList.remove('hidden');

            if (autoCaptureToggle.checked) {
                stillTimeStart = null;
                previousFrameData = null;
                detectMotion();
            }
        });

        // Reset Flow
        btnReset.addEventListener('click', () => {
            if (confirm("Are you sure? This will discard the current batch.")) {
                imagesBatch = [];
                extractedData = [];
                batchCountEl.innerText = '0';
                thumbnailsContainer.innerHTML = '';

                btnProcess.disabled = true;
                btnCapture.disabled = false;

                reviewSection.classList.remove('visible');
                setTimeout(() => {
                    reviewSection.classList.add('hidden');
                    captureSection.classList.remove('hidden');
                    setTimeout(() => {
                        captureSection.classList.add('visible');
                    }, 50);
                }, 300);

                exportMsg.classList.add('hidden');
            }
        });

        window.addEventListener('load', () => {
            fetchClasses();
            loadRecentSessions();
            initMagneticButtons();
            initTouchRipples();
            initScrollProgress();
        });

        // 21st.dev Premium Animations

        function triggerRevealObserver() {
            // Initially hide elements so they can be revealed
            document.querySelectorAll('.reveal').forEach(el => {
                if (!el.classList.contains('visible')) {
                    el.classList.add('reveal-initial');
                }
            });

            const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('reveal-initial');
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
            setTimeout(() => {
                document.querySelectorAll('.reveal:not(.hidden)').forEach(el => {
                    el.classList.remove('reveal-initial');
                    el.classList.add('visible');
                });
            }, 100);
        }

        function initMagneticButtons() {
            const magnetics = document.querySelectorAll('.magnetic');
            magnetics.forEach(btn => {
                btn.addEventListener('mousemove', (e) => {
                    if (window.innerWidth < 768) return;
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const xc = rect.width / 2;
                    const yc = rect.height / 2;
                    const dx = x - xc;
                    const dy = y - yc;
                    const maxTranslate = 15;
                    const tx = (dx / xc) * maxTranslate;
                    const ty = (dy / yc) * maxTranslate;
                    btn.style.transform = `translate(${tx}px, ${ty}px) scale(1.02)`;
                });

                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translate(0px, 0px) scale(1)';
                });

                btn.addEventListener('mousedown', () => {
                    const span = btn.querySelector('span.absolute');
                    if (span) {
                        span.style.transform = 'scale(1)';
                        span.style.opacity = '1';
                        setTimeout(() => {
                            span.style.transform = 'scale(0)';
                            span.style.opacity = '0';
                        }, 500);
                    }
                });
            });
        }

        function initTouchRipples() {
            const buttons = document.querySelectorAll('button:not(#btn-capture)');
            buttons.forEach(btn => {
                btn.style.position = 'relative';
                btn.style.overflow = 'hidden';

                const createRipple = (e) => {
                    const circle = document.createElement('span');
                    const diameter = Math.max(btn.clientWidth, btn.clientHeight);
                    const radius = diameter / 2;

                    let clientX, clientY;
                    if (e.touches && e.touches.length > 0) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    const rect = btn.getBoundingClientRect();

                    circle.style.width = circle.style.height = `${diameter}px`;
                    circle.style.left = `${clientX - rect.left - radius}px`;
                    circle.style.top = `${clientY - rect.top - radius}px`;
                    circle.classList.add('ripple');

                    const ripple = btn.querySelector('.ripple');
                    if (ripple) ripple.remove();

                    btn.appendChild(circle);
                };

                btn.addEventListener('mousedown', createRipple);
                btn.addEventListener('touchstart', createRipple, { passive: true });
            });
        }

        // Roster Management Event Listeners
        const rosterUpload = document.getElementById('roster-upload');
        const btnClearRoster = document.getElementById('btn-clear-roster');

        // Paste Modal Elements
        const btnOpenPaste = document.getElementById('btn-open-paste-modal');
        const pasteModal = document.getElementById('paste-modal');
        const btnClosePaste = document.getElementById('btn-close-paste');
        const btnSubmitPaste = document.getElementById('btn-submit-paste');
        const pasteTargetClass = document.getElementById('paste-target-class');
        const pasteRawText = document.getElementById('paste-raw-text');

        // Enrollment logic handled at the bottom of the file where loadSelectiveStudents is defined.
        if (btnOpenPaste && pasteModal) {
            btnOpenPaste.addEventListener('click', () => {
                // By default, start with an empty class name so the user can type a new one
                pasteTargetClass.value = '';

                // Only pre-fill if the user actually clicked a valid class name in the dropdown (not the placeholder)
                if (targetClassSelect && targetClassSelect.value && targetClassSelect.value !== '') {
                    pasteTargetClass.value = targetClassSelect.value;
                }

                pasteModal.classList.remove('hidden');
                pasteModal.classList.add('flex');

                // Animate in
                setTimeout(() => {
                    pasteModal.classList.remove('opacity-0');
                    pasteModal.querySelector('div').classList.remove('scale-95');
                    pasteModal.querySelector('div').classList.add('scale-100');

                    // Show helpful instruction
                    setTimeout(() => {
                        showToast('Tip: For 100% handwriting accuracy, please provide the COMPLETE comprehensive student list for this class.', 'info', 6000);
                    }, 500);
                }, 10);

                pasteRawText.focus();
            });

            const closePasteModal = () => {
                pasteModal.classList.add('opacity-0');
                pasteModal.querySelector('div').classList.add('scale-95');
                pasteModal.querySelector('div').classList.remove('scale-100');
                setTimeout(() => {
                    pasteModal.classList.add('hidden');
                    pasteModal.classList.remove('flex');
                }, 300);
            };

            btnClosePaste.addEventListener('click', closePasteModal);
            pasteModal.addEventListener('click', (e) => {
                if (e.target === pasteModal) closePasteModal();
            });

            btnSubmitPaste.addEventListener('click', async () => {
                const targetClass = pasteTargetClass.value.trim();
                const rawText = pasteRawText.value.trim();

                if (!targetClass) {
                    showToast('Please enter a Target Class.', 'warning');
                    pasteTargetClass.focus();
                    return;
                }

                // Smart validation: Enforce section letters, e.g., "SS1" is bad, "SS1 A" is good.
                // It should have at least one letter and one number, and more than 3 characters usually,
                // or just explicitly check if it ends with a number.
                const hasLetters = /[a-zA-Z]/.test(targetClass);
                const hasNumbers = /[0-9]/.test(targetClass);

                if (hasLetters && hasNumbers) {
                    // If it ends with a number, usually it's missing a section, e.g., "SS 1"
                    if (/\d$/.test(targetClass)) {
                        showToast('Please specify the class section (e.g. use "SS1 A" or "JSS3 B" instead of just "SS1")', 'warning', 6000);
                        pasteTargetClass.focus();
                        return;
                    }
                }

                if (!rawText) {
                    showToast('Please paste the complete list of student names.', 'warning');
                    pasteRawText.focus();
                    return;
                }

                const originalBtnText = btnSubmitPaste.innerHTML;
                btnSubmitPaste.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Processing...';

                try {
                    const response = await fetch('/api/classes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: targetClass, names_text: rawText })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showToast(`${result.message}`, 'success');

                        // Keep UI in sync
                        if (targetClassSelect) {
                            // Let's add the new class to the dropdown list if it doesn't already exist
                            let exists = false;
                            for (let i = 0; i < targetClassSelect.options.length; i++) {
                                if (targetClassSelect.options[i].text === targetClass) {
                                    exists = true;
                                    targetClassSelect.selectedIndex = i;
                                    break;
                                }
                            }
                            if (!exists) {
                                const newOption = new Option(targetClass, targetClass, false, true);
                                newOption.className = "bg-card";
                                targetClassSelect.add(newOption);
                            }
                        }

                        // Clear textarea
                        pasteRawText.value = '';
                        closePasteModal();
                    } else {
                        showToast(`Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error pasting roster:', error);
                    showToast('An error occurred. Please try again.', 'error');
                } finally {
                    btnSubmitPaste.innerHTML = originalBtnText;
                }
            });
        }

        if (rosterUpload) {
            rosterUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload-sheet', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showToast(`${result.message}`, 'success');
                        // Auto-fill target class if it was a text file
                        if (file.name.toLowerCase().endsWith('.txt') || file.name.toLowerCase().endsWith('.md')) {
                            let baseName = file.name.replace(/\.[^/.]+$/, "");
                            let clean = baseName.toUpperCase().replace(/[^A-Z0-9]/g, '');
                            let match = clean.match(/([A-Z]+)(\d+.*)/);
                            if (match && document.getElementById('target-class')) {
                                document.getElementById('target-class').value = `${match[1]} ${match[2]}`;
                            }
                        }
                    } else {
                        showToast(`Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error uploading roster:', error);
                    showToast('An error occurred while uploading.', 'error');
                }

                // Reset file input so the same file can be uploaded again if needed
                e.target.value = '';
            });
        }

        // ------ Added UI Hooks & Processing Logic ------
        if (subjectNameSelect && customSubjectWrapper) {
            subjectNameSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customSubjectWrapper.classList.remove('hidden');
                    customSubjectInput.focus();
                } else {
                    customSubjectWrapper.classList.add('hidden');
                }
            });
        }

        if (assessmentTypeSelect && customAssessmentWrapper) {
            assessmentTypeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customAssessmentWrapper.classList.remove('hidden');
                    customAssessmentInput.focus();
                } else {
                    customAssessmentWrapper.classList.add('hidden');
                }

                // Show enrollment section once assessment is selected
                if (e.target.value) {
                    const enrollmentSection = document.getElementById('enrollment-section');
                    if (enrollmentSection) {
                        enrollmentSection.classList.remove('hidden');
                    }
                }
            });
        }

        async function fetchClasses() {
            try {
                const response = await fetch('/api/classes');
                if (response.ok) {
                    const classes = await response.json();
                    if (targetClassSelect) {
                        targetClassSelect.innerHTML = '<option value="" disabled selected class="bg-card">-- Select a Class --</option>';
                        classes.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.name;
                            opt.textContent = c.name;
                            opt.className = 'bg-card text-white font-medium';
                            targetClassSelect.appendChild(opt);
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching classes:', error);
            }
        }

        // (Duplicate window.load and btnStartCamera removed  handled earlier)

        const btnEnrollGeneral = document.getElementById('btn-enroll-general');
        const btnEnrollSelective = document.getElementById('btn-enroll-selective');
        const btnToggleSmartMode = document.getElementById('btn-toggle-smart-mode');
        const smartSwitchBg = document.getElementById('smart-mode-switch-bg');
        const smartSwitchKnob = document.getElementById('smart-mode-switch-knob');
        const smartInstructionWrapper = document.getElementById('smart-instruction-wrapper');
        const selectiveModal = document.getElementById('selective-enrollment-modal');
        const btnCloseSelective = document.getElementById('btn-close-selective-modal');

        if (btnEnrollGeneral && btnEnrollSelective) {
            btnEnrollGeneral.addEventListener('click', () => {
                btnEnrollGeneral.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 border-r border-white/10 text-white bg-primary/20 shadow-[0_0_10px_rgba(16,185,129,0.2)]";
                btnEnrollSelective.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 text-muted-foreground hover:text-white";
                document.getElementById('enrollment-desc').textContent = "All students take this subject";

                const inlineContainer = document.getElementById('selective-inline-container');
                if (inlineContainer) {
                    inlineContainer.classList.add('hidden');
                }
            });
            btnEnrollSelective.addEventListener('click', () => {
                btnEnrollSelective.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 text-yellow-500 bg-yellow-500/20 shadow-[0_0_10px_rgba(234,179,8,0.2)]";
                btnEnrollGeneral.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 border-r border-white/10 text-muted-foreground hover:text-white";
                document.getElementById('enrollment-desc').textContent = "Only selected students take this";

                const inlineContainer = document.getElementById('selective-inline-container');
                if (inlineContainer) {
                    inlineContainer.classList.remove('hidden');
                    loadSelectiveStudents();
                }
            });
        }

        if (btnToggleSmartMode && smartSwitchBg && smartSwitchKnob && smartInstructionWrapper) {
            btnToggleSmartMode.addEventListener('click', () => {
                const isSmartOn = smartSwitchBg.classList.contains('bg-indigo-500');
                if (isSmartOn) {
                    // Turn off
                    smartSwitchBg.className = 'w-10 h-5 bg-black/50 rounded-full relative shadow-inner border border-white/10 transition-colors';
                    smartSwitchKnob.className = 'w-3 h-3 bg-muted-foreground rounded-full absolute top-1 left-1 transition-all';
                    smartInstructionWrapper.classList.add('hidden');
                } else {
                    // Turn on
                    smartSwitchBg.className = 'w-10 h-5 bg-indigo-500 rounded-full relative shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-colors border border-indigo-400';
                    smartSwitchKnob.className = 'w-3 h-3 bg-white rounded-full absolute top-1 left-6 shadow-md transition-all';
                    smartInstructionWrapper.classList.remove('hidden');
                    document.getElementById('smart-instruction-input').focus();
                }
            });
        }

        async function loadSelectiveStudents() {
            const tc = document.getElementById('target-class').value;
            const sn = document.getElementById('subject-name').value === 'custom'
                ? document.getElementById('custom-subject').value.trim()
                : document.getElementById('subject-name').value;

            const listContainer = document.getElementById('selective-students-list');

            if (!tc || !sn) {
                listContainer.innerHTML = '<div class="p-4 text-center text-sm text-muted-foreground">Please select a Target Class and Subject first.</div>';
                return;
            }

            listContainer.innerHTML = '<div class="p-4 text-center text-sm text-primary"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Loading students...</div>';

            try {
                const classesRes = await fetch('/api/classes');
                const classes = await classesRes.json();
                const cls = classes.find(c => c.name === tc);
                if (!cls) {
                    listContainer.innerHTML = '<div class="p-4 text-center text-sm text-destructive">Class not found in database.</div>';
                    return;
                }

                const studentsRes = await fetch(`/api/students?class_id=${cls.id}`);
                const students = await studentsRes.json();

                const enrollRes = await fetch(`/api/enrollments?class_id=${cls.id}&subject_name=${encodeURIComponent(sn)}`);
                const enrollData = await enrollRes.json();
                const enrolledIds = enrollData.enrolled || [];

                if (students.length === 0) {
                    listContainer.innerHTML = '<div class="p-4 text-center text-sm text-muted-foreground">No students found in this class.</div>';
                    return;
                }

                let html = '';
                students.forEach(student => {
                    const isChecked = enrolledIds.includes(student.id) ? 'checked' : '';
                    html += `
                        <label class="flex items-center gap-3 p-3 hover:bg-white/5 rounded-lg cursor-pointer transition-colors border-b border-white/5 last:border-0 border-yellow-500/10">
                            <input type="checkbox" class="selective-student-checkbox h-5 w-5 rounded border-yellow-500/30 bg-black/40 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-background" value="${student.id}" data-name="${student.name}" ${isChecked} onchange="saveSelectiveEnrollment(this)">
                            <span class="text-sm font-medium text-white">${student.name}</span>
                        </label>
                     `;
                });
                listContainer.innerHTML = html;
                listContainer.dataset.classId = cls.id;
            } catch (err) {
                console.error(err);
                listContainer.innerHTML = '<div class="p-4 text-center text-sm text-destructive">Failed to load students.</div>';
            }
        }

        async function saveSelectiveEnrollment(checkboxElement) {
            const listContainer = document.getElementById('selective-students-list');
            const classId = listContainer.dataset.classId;
            const sn = document.getElementById('subject-name').value === 'custom'
                ? document.getElementById('custom-subject').value.trim()
                : document.getElementById('subject-name').value;

            if (!classId || !sn) return;

            const checkboxes = document.querySelectorAll('.selective-student-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            try {
                const res = await fetch('/api/enrollments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        class_id: parseInt(classId),
                        subject_name: sn,
                        student_ids: selectedIds
                    })
                });
                if (!res.ok) {
                    showToast('Failed to auto-save enrollment', 'error');
                }
            } catch (err) {
                console.error("Save selective error:", err);
            }
        }

        const enrollmentListFile = document.getElementById('enrollment-list-file');
        const enrollmentFileLabel = document.getElementById('enrollment-file-label');
        if (enrollmentListFile) {
            enrollmentListFile.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const tc = document.getElementById('target-class').value;
                if (!tc) {
                    showToast('Please select a Target Class first.', 'warning');
                    return;
                }

                enrollmentFileLabel.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-primary"></i> Extracting names...';

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64Data = event.target.result.split(',')[1];
                    try {
                        const response = await fetch('/api/extract-names', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: base64Data,
                                targetClass: tc
                            })
                        });

                        const result = await response.json();
                        if (response.ok && result.names) {
                            enrollmentFileLabel.innerHTML = `<span class="text-emerald-400"><i class="fa-solid fa-check"></i> Found ${result.names.length} names. Updating checklist...</span>`;

                            const listContainer = document.getElementById('selective-students-list');
                            const checkboxes = listContainer.querySelectorAll('.selective-student-checkbox');

                            checkboxes.forEach(cb => {
                                cb.checked = false;
                                const studentName = cb.dataset.name.toLowerCase();
                                if (result.names.some(n => studentName === String(n).toLowerCase())) {
                                    cb.checked = true;
                                }
                            });

                            setTimeout(() => {
                                enrollmentFileLabel.innerText = 'Snap a photo of the handwritten list.';
                                enrollmentListFile.value = '';
                            }, 3000);
                        } else {
                            throw new Error(result.error || "Failed to extract names");
                        }
                    } catch (err) {
                        console.error('Extraction error:', err);
                        enrollmentFileLabel.innerHTML = `<span class="text-destructive"><i class="fa-solid fa-triangle-exclamation"></i> Error extracting. Try again.</span>`;
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        if (btnCloseSelective) {
            btnCloseSelective.addEventListener('click', () => {
                if (selectiveModal) {
                    selectiveModal.classList.remove('flex');
                    selectiveModal.classList.add('hidden');
                }
            });
        }

        const btnCloseScoresheetModal = document.getElementById('btn-close-scoresheet-modal');
        if (btnCloseScoresheetModal) {
            btnCloseScoresheetModal.addEventListener('click', () => {
                const uModal = document.getElementById('upload-scoresheet-modal');
                if (uModal) {
                    uModal.classList.remove('flex');
                    uModal.classList.add('hidden');
                }
            });
        }

        const btnSubmitScoresheet = document.getElementById('btn-submit-scoresheet');
        const scoresheetFile = document.getElementById('scoresheet-file');
        const scoresheetMsg = document.getElementById('scoresheet-msg');

        if (btnSubmitScoresheet) {
            btnSubmitScoresheet.addEventListener('click', async () => {
                if (!scoresheetFile || !scoresheetFile.files || scoresheetFile.files.length === 0) {
                    if (scoresheetMsg) {
                        scoresheetMsg.textContent = "Please select an image file first.";
                        scoresheetMsg.className = "text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 text-yellow-400";
                    }
                    return;
                }

                const file = scoresheetFile.files[0];
                const targetClass = document.getElementById('target-class').value;

                if (!targetClass) {
                    showToast("Please select a target class before uploading.", "warning");
                    return;
                }

                // UI Loading State
                const originalHtml = btnSubmitScoresheet.innerHTML;
                btnSubmitScoresheet.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing Image...`;
                btnSubmitScoresheet.disabled = true;

                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(file);
                    });

                    const response = await fetch('/upload-scoresheet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: base64Data,
                            targetClass: targetClass
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || "Upload failed");
                    }

                    // Success
                    showToast(`Successfully extracted ${result.records ? result.records.length : 0} student records.`, "success");

                    // Add records to extractedData state for review
                    result.records.forEach(r => {
                        // Formatting the data to match the expected structure
                        if (r.scores) {
                            // If multiple assessments were found, we might want to just grab the first one for the standard flow,
                            // or ideally map them if the UI supports it. Let's map the first score found to the default.
                            const subjectKeys = Object.keys(r.scores);
                            let primaryScore = "";
                            if (subjectKeys.length > 0) {
                                primaryScore = r.scores[subjectKeys[0]];
                            }
                            extractedData.push({
                                name: r.name || "Name not recognized",
                                class: targetClass,
                                score: primaryScore || "0",
                                confidence: r.confidence || "High",
                                // keep raw scores attached for advanced saving
                                _rawScores: r.scores
                            });
                        } else {
                            extractedData.push({
                                name: r.name || "Name not recognized",
                                class: targetClass,
                                score: r.score || "0",
                                confidence: r.confidence || "High"
                            });
                        }
                    });

                    // Update UI analytics
                    if (typeof updateAnalytics === 'function') {
                        updateAnalytics();
                    }

                    // Close modal
                    const uModal = document.getElementById('upload-scoresheet-modal');
                    if (uModal) {
                        uModal.classList.remove('flex');
                        uModal.classList.add('hidden');
                    }

                    // Show Review UI
                    document.getElementById('landing-section').classList.add('hidden');
                    document.getElementById('capture-section').classList.remove('hidden');
                    openReviewModal(extractedData.length - 1); // Open the last item to review

                } catch (err) {
                    console.error("Upload scoresheet error:", err);
                    showToast(err.message || "Failed to process score list.", "error");
                } finally {
                    btnSubmitScoresheet.innerHTML = originalHtml;
                    btnSubmitScoresheet.disabled = false;
                }
            });
        }

        const btnSubmitXlsx = document.getElementById('btn-submit-xlsx');
        if (btnSubmitXlsx) {
            btnSubmitXlsx.addEventListener('click', async () => {
                const xlsxFile = document.getElementById('xlsx-file');
                if (!xlsxFile || !xlsxFile.files || xlsxFile.files.length === 0) {
                    showToast("Please select an Excel or CSV file first.", "warning");
                    return;
                }

                // UI Loading State
                const originalHtml = btnSubmitXlsx.innerHTML;
                btnSubmitXlsx.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Parsing...`;
                btnSubmitXlsx.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('file', xlsxFile.files[0]);

                    const response = await fetch('/api/upload-excel-scorelist', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || "Excel upload failed");
                    }

                    // Success
                    showToast(`Successfully extracted ${result.records ? result.records.length : 0} student records.`, "success");

                    // Set target class drop-down if detected
                    if (result.detected_class) {
                        const tcDropdown = document.getElementById('target-class');
                        if (tcDropdown) {
                            // try to select it if it exists
                            let optionExists = Array.from(tcDropdown.options).some(opt => opt.value === result.detected_class);
                            if (optionExists) {
                                tcDropdown.value = result.detected_class;
                            } else {
                                // Add and select it temporarily
                                const newOpt = new Option(result.detected_class, result.detected_class);
                                tcDropdown.add(newOpt);
                                tcDropdown.value = result.detected_class;
                            }
                        }
                    }

                    // Map result to the review table exactly like the camera scans do
                    result.records.forEach(r => {
                        let primaryScore = "0";
                        if (r.scores) {
                            const subjectKeys = Object.keys(r.scores);
                            if (subjectKeys.length > 0) primaryScore = r.scores[subjectKeys[0]];
                        }

                        extractedData.push({
                            name: r.name || "Name not recognized",
                            class: r.class || result.detected_class || "Unknown",
                            score: primaryScore || "0",
                            confidence: "Verified", // Came from typed excel so it's 100%
                            _rawScores: r.scores
                        });
                    });

                    // Update UI analytics
                    if (typeof updateAnalytics === 'function') {
                        updateAnalytics();
                    }

                    // Close modal
                    const xModal = document.getElementById('upload-xlsx-modal');
                    if (xModal) {
                        xModal.classList.remove('flex');
                        xModal.classList.add('opacity-0');
                        setTimeout(() => xModal.classList.add('hidden'), 300);
                    }

                    // Show Review UI
                    document.getElementById('landing-section').classList.add('hidden');
                    document.getElementById('capture-section').classList.remove('hidden');
                    openReviewModal(extractedData.length - 1 || 0);

                } catch (err) {
                    console.error("Excel upload error:", err);
                    showToast(err.message || "Failed to parse Excel list.", "error");
                } finally {
                    btnSubmitXlsx.innerHTML = originalHtml;
                    btnSubmitXlsx.disabled = false;
                }
            });
        }

        function initScrollProgress() {
            const progressBar = document.getElementById('scroll-progress');
            if (!progressBar) return;

            window.addEventListener('scroll', () => {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                if (height <= 0) return;
                const scrolled = (winScroll / height) * 100;
                progressBar.style.width = scrolled + '%';
            }, { passive: true });
        }

        function showWhatsNext(context) {
            const nextBlock = document.getElementById('whats-next-block');
            const msgEl = document.getElementById('whats-next-message');
            const actionsEl = document.getElementById('whats-next-actions');

            if (!nextBlock || !msgEl || !actionsEl) return;

            actionsEl.innerHTML = ''; // clear

            if (context === 'scanned_papers') {
                msgEl.innerText = "Scores from the physical test papers have been matched and appended to your roster.";
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('btn-new-batch').click()"
                        class="bg-black/40 hover:bg-primary/20 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner hover:border-primary/50 text-left h-full">
                        <i class="fa-solid fa-camera text-primary group-hover:scale-110 transition-transform text-lg"></i>
                        <span>Scan more scripts</span>
                    </button>
                    <button onclick="window.location.reload()"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner h-full text-left">
                        <i class="fa-solid fa-house-chimney text-emerald-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>Done grading. Return Home</span>
                    </button>
                `;
            } else if (context === 'excel_upload') {
                msgEl.innerHTML = `Welcome back. I see students from your previous session.<br/><span class="text-white">Are we grading their next test?</span>`;
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('start-section').classList.add('hidden'); document.getElementById('review-section').classList.add('hidden'); document.getElementById('capture-section').classList.remove('hidden'); if(typeof initCamera === 'function') initCamera();"
                        class="bg-primary/20 hover:bg-primary/40 p-4 rounded-xl border border-primary/30 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-glow text-white text-left h-full">
                        <i class="fa-solid fa-camera-retro text-primary group-hover:-translate-y-1 transition-transform text-xl block"></i>
                        <span>Yes, let's scan their new papers!</span>
                    </button>
                    <button onclick="document.getElementById('review-section').querySelector('.table').scrollIntoView({behavior: 'smooth'})"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner text-left h-full">
                        <i class="fa-solid fa-pen-to-square text-indigo-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>No, I just want to edit some grades.</span>
                    </button>
                `;
            } else if (context === 'photo_scorelist') {
                msgEl.innerHTML = `Great! I've extracted the handwritten scores.`;
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('btn-export').click()"
                        class="bg-emerald-500 hover:bg-emerald-400 text-black p-4 rounded-xl border border-emerald-400 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-glow text-left h-full">
                        <i class="fa-solid fa-file-excel group-hover:-translate-y-1 transition-transform text-xl block"></i>
                        <span>Awesome. Compile to Excel Dashboard!</span>
                    </button>
                    <button onclick="document.getElementById('upload-scoresheet-modal').classList.remove('hidden'); document.getElementById('upload-scoresheet-modal').classList.add('flex'); setTimeout(() => document.getElementById('upload-scoresheet-modal').classList.remove('opacity-0'), 10);"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner text-left h-full">
                        <i class="fa-solid fa-file-invoice text-indigo-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>I have another score list page</span>
                    </button>
                `;
            }

            nextBlock.classList.remove('hidden');
        }

    </script>
</body>

</html>