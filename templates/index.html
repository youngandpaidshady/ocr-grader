<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="QSI Smart Grader ‚Äî AI-powered school grading assistant. Capture handwritten exam scripts with your camera and let AI automatically extract, match, and rank student scores directly to Excel.">
    <meta name="theme-color" content="#0a0a0c">
    <title>QSI Smart Grader ‚Äî AI Exam Script Grading Assistant</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>"
        type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(215, 10%, 4%)',    /* Deep midnight blue layer 0 */
                        foreground: 'hsl(215, 5%, 98%)',
                        card: 'hsl(215, 10%, 6%)',          /* Elevated surface */
                        'card-foreground': 'hsl(215, 5%, 98%)',
                        muted: 'hsl(215, 10%, 15%)',
                        'muted-foreground': 'hsl(215, 10%, 65%)',
                        primary: 'hsl(215, 90%, 55%)',      /* QSI Blue */
                        'primary-foreground': 'hsl(0, 0%, 98%)',
                        accent: 'hsl(215, 80%, 70%)',
                        destructive: 'hsl(0, 72%, 51%)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: 0.2 },
                            '50%': { opacity: 0.4 },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Enhancement Styles -->
    <link rel="stylesheet" href="/static/enhancements.css">

    <!-- Three.js for 3D Background Scene -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>



    <style>
        :root {
            --brand-rgb: 33, 150, 243;
            /* Matches primary HSL 215, 90%, 55% */
        }

        body {
            background-color: theme('colors.background');
            color: theme('colors.foreground');
        }

        /* 21st.dev Premium Depth & Textures */
        .dot-matrix {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .shadow-glow {
            box-shadow: 0 0 20px rgba(var(--brand-rgb), 0.3);
        }

        .shadow-glow-lg {
            box-shadow: 0 0 40px rgba(var(--brand-rgb), 0.4);
        }

        .shadow-bloom {
            box-shadow: 0 0 60px 20px rgba(var(--brand-rgb), 0.15);
        }

        .noise {
            position: relative;
        }

        .noise::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Input Animations */
        .input-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }

        .input-focus-anim {
            position: absolute;
            inset: -1px;
            background: linear-gradient(90deg, transparent, rgba(var(--brand-rgb), 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border-radius: 0.75rem;
        }

        select:focus~.input-focus-anim,
        input[type="text"]:focus~.input-focus-anim {
            opacity: 1;
        }

        /* Animation Base */
        .reveal {
            opacity: 1;
            /* Fallback to visible if observer fails */
            transform: translateY(0) scale(1);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: opacity, transform;
        }

        /* We'll use JS to add a class to hide them initially if JS loads */
        .reveal-initial {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
        }

        .reveal.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .reveal-delay-1 {
            transition-delay: 100ms;
        }

        .reveal-delay-2 {
            transition-delay: 200ms;
        }

        /* Card Light Beam (Active Card Effect) */
        .light-beam-card {
            position: relative;
        }

        .light-beam-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .light-beam-card:hover::before {
            opacity: 1;
        }

        /* Holographic Sheen */
        .holographic {
            background-image: linear-gradient(75deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            background-size: 200% 100%;
            background-position: 100% 0;
            transition: background-position 0.6s ease;
        }

        .holographic:hover {
            background-position: -100% 0;
        }

        /* 3D Button Effects */
        .btn-3d {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            position: relative;
            transform-style: preserve-3d;
        }

        .btn-3d:active {
            transform: translateY(4px) scale(0.98);
        }

        /* Float Animation */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .floating {
            animation: float 6s ease-in-out infinite;
        }

        /* Mobile Touch Ripples */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 600ms linear;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        @keyframes ripple-anim {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Magnetic Button Transition */
        .magnetic {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s;
            will-change: transform;
        }

        /* Component Overrides */
        #video-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 3/4;
            /* Optimized for portrait document scanning */
            margin: 0 auto;
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            background-color: #000;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        @media (min-width: 768px) {
            #video-container {
                /* Larger screens can handle wider or taller boxes nicely */
                aspect-ratio: 4/5;
            }
        }

        #camera-feed {
            width: 100%;
            height: auto;
            object-fit: cover;
            display: block;
        }

        .captured-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Toast Notification System */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            max-width: 380px;
            width: calc(100% - 2rem);
        }

        .toast {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            font-size: 0.8125rem;
            font-weight: 600;
            line-height: 1.4;
            color: white;
        }

        .toast.toast-exit {
            animation: toastSlideOut 0.3s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards;
        }

        .toast-success {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .toast-error {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .toast-info {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .toast-icon {
            font-size: 1.1rem;
            margin-top: 1px;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            color: #10b981;
        }

        .toast-warning .toast-icon {
            color: #f59e0b;
        }

        .toast-error .toast-icon {
            color: #ef4444;
        }

        .toast-info .toast-icon {
            color: #3b82f6;
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            padding: 2px;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 1px;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: white;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(40px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0) scale(1);
            }

            to {
                opacity: 0;
                transform: translateX(40px) scale(0.9);
            }
        }

        /* Recent Session Cards */
        .session-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px -8px rgba(var(--brand-rgb), 0.3);
        }

        .session-card:active {
            transform: scale(0.98);
        }

        /* Landing entry cards */
        .entry-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .entry-card:hover {
            transform: translateY(-4px);
        }

        .entry-card:active {
            transform: scale(0.97);
        }

        /* Section transitions */
        .section-transition {
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .section-hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            visibility: hidden;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           PHASE 3: 3D PREMIUM ANIMATIONS
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Three.js Background Canvas */
        #three-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
        }

        /* 3D Card Tilt Container */
        .tilt-card {
            perspective: 800px;
            transform-style: preserve-3d;
        }

        .tilt-card-inner {
            transition: transform 0.15s ease-out;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .tilt-card-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(circle at var(--glow-x, 50%) var(--glow-y, 50%), rgba(var(--brand-rgb), 0.15) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1;
        }

        .tilt-card:hover .tilt-card-inner::after {
            opacity: 1;
        }

        /* 3D Floating Icon Wobble */
        @keyframes wobble3D {

            0%,
            100% {
                transform: rotateY(0deg) rotateX(0deg) translateZ(0);
            }

            25% {
                transform: rotateY(12deg) rotateX(-5deg) translateZ(5px);
            }

            50% {
                transform: rotateY(-8deg) rotateX(3deg) translateZ(8px);
            }

            75% {
                transform: rotateY(6deg) rotateX(-2deg) translateZ(3px);
            }
        }

        .wobble-3d {
            animation: wobble3D 6s ease-in-out infinite;
            transform-style: preserve-3d;
        }

        .wobble-3d-delay-1 {
            animation-delay: 0.5s;
        }

        .wobble-3d-delay-2 {
            animation-delay: 1s;
        }

        /* 3D Modal Flip */
        .modal-3d-container {
            perspective: 1200px;
        }

        .modal-3d-flip {
            transform: rotateY(-15deg) scale(0.85);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            transform-style: preserve-3d;
        }

        .modal-3d-flip.modal-active {
            transform: rotateY(0deg) scale(1);
            opacity: 1;
        }

        /* Step Progress Indicator */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0;
            position: relative;
        }

        .step-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 2;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: hsl(215, 10%, 8%);
            color: rgba(255, 255, 255, 0.3);
        }

        .step-dot.step-active {
            background: hsl(215, 90%, 55%);
            border-color: hsl(215, 90%, 65%);
            color: white;
            transform: scale(1.15) translateZ(10px);
            box-shadow: 0 0 20px rgba(var(--brand-rgb), 0.5), 0 0 40px rgba(var(--brand-rgb), 0.2);
        }

        .step-dot.step-done {
            background: hsl(160, 84%, 39%);
            border-color: hsl(160, 84%, 49%);
            color: white;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .step-line-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, hsl(160, 84%, 39%), hsl(215, 90%, 55%));
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 1px;
        }

        /* Stat Counter Pulse */
        @keyframes countPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
            }
        }

        .stat-counted {
            animation: countPulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9998;
        }

        /* 3D Section Entrance */
        @keyframes sectionEnter3D {
            from {
                opacity: 0;
                transform: perspective(800px) rotateY(8deg) translateZ(-60px) translateX(30px);
            }

            to {
                opacity: 1;
                transform: perspective(800px) rotateY(0deg) translateZ(0) translateX(0);
            }
        }

        @keyframes sectionExit3D {
            from {
                opacity: 1;
                transform: perspective(800px) rotateY(0deg) translateZ(0) translateX(0);
            }

            to {
                opacity: 0;
                transform: perspective(800px) rotateY(-8deg) translateZ(-60px) translateX(-30px);
            }
        }

        .section-enter-3d {
            animation: sectionEnter3D 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .section-exit-3d {
            animation: sectionExit3D 0.4s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards;
        }

        /* Performance: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {

            .wobble-3d,
            .floating,
            .animate-pulse-glow,
            .animate-spin-slow {
                animation: none !important;
            }

            .tilt-card-inner {
                transition: none !important;
            }

            .modal-3d-flip {
                transition: opacity 0.2s ease !important;
                transform: none !important;
            }

            .modal-3d-flip.modal-active {
                transform: none !important;
            }

            .section-enter-3d,
            .section-exit-3d {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
            }

            #three-bg {
                display: none !important;
            }
        }
    </style>
</head>

<body class="min-h-screen font-sans antialiased overflow-x-hidden selection:bg-primary/30 relative bg-background">

    <!-- Three.js 3D Background -->
    <canvas id="three-bg"></canvas>

    <!-- Particle Sparkle Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scroll Progress Indicator -->
    <div id="scroll-progress"
        class="fixed top-0 left-0 h-1 bg-gradient-to-r from-primary to-accent z-50 transition-all duration-100 origin-left shadow-glow border-b border-primary"
        style="width: 0%;"></div>

    <!-- Fun Full-Screen Loading Overlay -->
    <div id="grading-loading-overlay"
        class="fixed inset-0 z-[100] bg-background/95 backdrop-blur-xl hidden flex-col items-center justify-center transition-all duration-500">
        <div class="relative w-40 h-40 mb-8 flex items-center justify-center">
            <!-- Outer spinning ring -->
            <div
                class="absolute inset-0 border-4 border-primary/20 border-t-primary rounded-full animate-[spin_2s_linear_infinite]">
            </div>
            <!-- Inner spinning ring -->
            <div
                class="absolute inset-4 border-4 border-emerald-500/20 border-b-emerald-500 rounded-full animate-[spin_1.5s_linear_infinite_reverse]">
            </div>
            <!-- Center pulsing icon -->
            <div class="absolute inset-0 flex items-center justify-center text-5xl">
                <i
                    class="fa-solid fa-wand-magic-sparkles text-primary animate-pulse filter drop-shadow-[0_0_15px_rgba(33,150,243,0.8)]"></i>
            </div>
            <!-- Floating math symbols for fun -->
            <i class="fa-solid fa-plus absolute top-0 left-0 text-emerald-400 text-sm animate-bounce"></i>
            <i class="fa-solid fa-divide absolute bottom-2 right-4 text-purple-400 text-sm animate-pulse"></i>
            <i class="fa-solid fa-minus absolute top-4 right-2 text-yellow-400 text-sm animate-bounce"
                style="animation-delay: 0.2s;"></i>
        </div>
        <h3 class="text-3xl font-heading font-black text-white mb-3 tracking-tight animate-pulse-glow">AI is Grading
            Papers...</h3>
        <p class="text-muted-foreground font-medium text-center max-w-sm px-4">
            Extracting handwriting, matching student names, and calculating final scores.
        </p>
        <div class="mt-8 w-64 h-2 bg-white/10 rounded-full overflow-hidden">
            <div
                class="h-full bg-gradient-to-r from-primary via-emerald-400 to-primary w-[200%] animate-[scan_2s_linear_infinite]">
            </div>
        </div>
    </div>
    <style>
        @keyframes scan {
            0% {
                transform: translateX(-50%);
            }

            100% {
                transform: translateX(0%);
            }
        }
    </style>

    <!-- Depth Layer 1: Atmosphere (Dot Matrix + Single Spotlight Glow) -->
    <div class="fixed inset-0 z-0 noise pointer-events-none"></div>
    <div class="fixed inset-0 z-0 dot-matrix pointer-events-none opacity-50"></div>
    <div
        class="fixed top-[-20%] left-[-10%] w-[60vw] h-[60vw] rounded-full bg-primary/10 blur-[120px] pointer-events-none z-0">
    </div>

    <!-- Depth Layer 3: Foreground Content -->
    <div class="max-w-4xl mx-auto p-4 md:p-8 relative z-10 w-full animate-fade-in-up">

        <!-- Step Progress Indicator (hidden ‚Äî replaced by How It Works strip in landing card) -->
        <div id="step-progress" class="mb-8 pt-6 max-w-md mx-auto px-4 hidden">
            <div class="step-indicator">
                <div class="step-dot step-active" data-step="start" title="Start">
                    <i class="fa-solid fa-play text-[10px]"></i>
                </div>
                <div class="step-line">
                    <div class="step-line-fill" data-line="1"></div>
                </div>
                <div class="step-dot" data-step="capture" title="Capture">
                    <i class="fa-solid fa-camera text-[10px]"></i>
                </div>
                <div class="step-line">
                    <div class="step-line-fill" data-line="2"></div>
                </div>
                <div class="step-dot" data-step="review" title="Review">
                    <i class="fa-solid fa-list-check text-[10px]"></i>
                </div>
                <div class="step-line">
                    <div class="step-line-fill" data-line="3"></div>
                </div>
                <div class="step-dot" data-step="results" title="Results">
                    <i class="fa-solid fa-trophy text-[10px]"></i>
                </div>
            </div>
            <div
                class="flex justify-between mt-2 text-[9px] font-bold uppercase tracking-widest text-muted-foreground/50">
                <span class="w-9 text-center">Start</span>
                <span class="w-9 text-center">Scan</span>
                <span class="w-9 text-center">Review</span>
                <span class="w-9 text-center">Results</span>
            </div>
        </div>

        <!-- Header -->
        <header id="app-hero" class="text-center mb-16 pt-6 reveal visible relative">
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-primary/20 blur-[60px] rounded-full -z-10">
            </div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-extrabold text-white mb-4 tracking-tight">
                <i
                    class="fa-solid fa-graduation-cap mr-3 text-primary drop-shadow-[0_0_15px_rgba(var(--brand-rgb),0.5)]"></i>QSI
                Smart Grader
            </h1>
            <p class="text-muted-foreground text-lg max-w-xl mx-auto font-medium">Capture handwritten exam scripts and
                let the AI automatically extract, format, and rank the results directly to Excel.</p>
        </header>

        <main>
            <!-- Step 1: Start Screen / Assessment Details -->
            <section id="start-section" class="mb-12">

                <!-- PHASE 1: LANDING (3 Options) -->
                <div id="landing-phase"
                    class="relative rounded-[1.25rem] border border-white/[0.08] p-6 md:p-10 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.7)] overflow-hidden"
                    style="background: linear-gradient(135deg, rgba(30,32,44,0.95) 0%, rgba(20,22,34,0.98) 50%, rgba(25,28,42,0.95) 100%); backdrop-filter: blur(20px);">

                    <!-- Subtle corner glow accents -->
                    <div
                        class="absolute top-0 left-0 w-40 h-40 bg-primary/10 blur-[80px] rounded-full -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                    </div>
                    <div
                        class="absolute bottom-0 right-0 w-48 h-48 bg-indigo-500/[0.08] blur-[80px] rounded-full translate-x-1/4 translate-y-1/4 pointer-events-none">
                    </div>

                    <!-- Heading -->
                    <div class="text-center mb-8 relative">
                        <h2 class="text-2xl md:text-3xl font-heading font-black text-white mb-2 tracking-tight">
                            What are we grading today?
                        </h2>
                        <p class="text-muted-foreground/70 text-sm font-medium">Pick up where you left off, or start
                            fresh.</p>
                    </div>

                    <!-- How It Works Strip -->
                    <div class="flex items-center justify-center gap-2 md:gap-4 mb-10 px-2">
                        <div class="flex flex-col items-center gap-2 group">
                            <div
                                class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-600/10 border border-blue-500/20 flex items-center justify-center group-hover:scale-110 group-hover:border-blue-400/40 transition-all duration-300 shadow-[0_4px_15px_rgba(59,130,246,0.15)]">
                                <i class="fa-solid fa-camera-retro text-blue-400 text-lg md:text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] md:text-[11px] font-bold text-blue-300/80 uppercase tracking-wider">Scan</span>
                        </div>
                        <div class="flex items-center pb-5">
                            <div
                                class="w-8 md:w-12 h-[2px] bg-gradient-to-r from-blue-500/40 to-emerald-500/40 rounded-full relative">
                                <div
                                    class="absolute inset-0 bg-gradient-to-r from-blue-400 to-emerald-400 rounded-full animate-pulse opacity-50">
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-[8px] text-emerald-400/50 -ml-1"></i>
                        </div>
                        <div class="flex flex-col items-center gap-2 group">
                            <div
                                class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 border border-emerald-500/20 flex items-center justify-center group-hover:scale-110 group-hover:border-emerald-400/40 transition-all duration-300 shadow-[0_4px_15px_rgba(16,185,129,0.15)]">
                                <i class="fa-solid fa-brain text-emerald-400 text-lg md:text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] md:text-[11px] font-bold text-emerald-300/80 uppercase tracking-wider">AI
                                Grades</span>
                        </div>
                        <div class="flex items-center pb-5">
                            <div
                                class="w-8 md:w-12 h-[2px] bg-gradient-to-r from-emerald-500/40 to-violet-500/40 rounded-full relative">
                                <div class="absolute inset-0 bg-gradient-to-r from-emerald-400 to-violet-400 rounded-full animate-pulse opacity-50"
                                    style="animation-delay: 0.5s;"></div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-[8px] text-violet-400/50 -ml-1"></i>
                        </div>
                        <div class="flex flex-col items-center gap-2 group">
                            <div
                                class="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-gradient-to-br from-violet-500/20 to-violet-600/10 border border-violet-500/20 flex items-center justify-center group-hover:scale-110 group-hover:border-violet-400/40 transition-all duration-300 shadow-[0_4px_15px_rgba(139,92,246,0.15)]">
                                <i class="fa-solid fa-file-excel text-violet-400 text-lg md:text-xl"></i>
                            </div>
                            <span
                                class="text-[10px] md:text-[11px] font-bold text-violet-300/80 uppercase tracking-wider">Get
                                Excel</span>
                        </div>
                    </div>

                    <!-- Important Notice Banner (Dismissible) -->
                    <div id="notice-banner"
                        class="mb-8 border border-amber-500/20 bg-amber-500/[0.07] rounded-xl p-4 flex items-start gap-3 relative transition-opacity duration-300">
                        <i class="fa-solid fa-lightbulb text-amber-500 mt-1"></i>
                        <div class="flex-1 pr-6">
                            <h4 class="text-amber-500 font-bold text-sm tracking-wide mb-1">Quick Heads Up üëã</h4>
                            <p class="text-amber-200/70 text-xs font-medium leading-relaxed">
                                When you're done scanning, hit <strong class="text-amber-400">"Save"</strong> to
                                lock in your grades, then <strong class="text-amber-400">"Download"</strong> to
                                grab your updated Excel file. Don't close the page before saving ‚Äî your scans
                                live here until you do!
                            </p>
                        </div>
                        <button
                            onclick="document.getElementById('notice-banner').classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => document.getElementById('notice-banner').classList.add('hidden'), 300)"
                            class="absolute top-3 right-3 text-amber-500/40 hover:text-amber-500 transition-colors p-1">
                            <i class="fa-solid fa-xmark text-sm"></i>
                        </button>
                    </div>

                    <!-- Recent Sessions -->
                    <div id="recent-sessions-container" class="mb-6 hidden">
                        <label
                            class="block text-[10px] font-bold text-muted-foreground uppercase tracking-widest pl-1 mb-3">
                            <i class="fa-solid fa-clock-rotate-left mr-1.5"></i>Continue a Recent Session
                        </label>
                        <div id="recent-sessions-list" class="space-y-2"></div>
                    </div>

                    <!-- Two Entry Buttons ‚Äî Big and Bold -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 max-w-2xl mx-auto">
                        <button id="btn-entry-excel" type="button"
                            class="entry-card holographic btn-3d magnetic relative group overflow-hidden rounded-2xl p-8 flex flex-col items-center justify-center gap-4 text-center transition-all duration-300 hover:scale-[1.02] active:scale-[0.98]"
                            style="background: linear-gradient(160deg, rgba(16,185,129,0.08) 0%, rgba(0,0,0,0.4) 50%, rgba(16,185,129,0.05) 100%); border: 1.5px solid rgba(16,185,129,0.2);">
                            <div
                                class="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                            </div>
                            <div
                                class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-3/4 h-8 bg-emerald-500/20 blur-[20px] opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                            </div>
                            <div
                                class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500/25 to-emerald-600/10 flex items-center justify-center border border-emerald-500/25 group-hover:border-emerald-400/40 transition-all duration-300 shadow-[0_4px_20px_rgba(16,185,129,0.15)] floating">
                                <i class="fa-solid fa-file-excel text-emerald-400 text-3xl"></i>
                            </div>
                            <div class="relative">
                                <span class="block font-bold text-lg tracking-wide text-white mb-1">I Have My
                                    Excel</span>
                                <span class="text-xs text-emerald-300/70 font-medium">Pick up exactly where you left
                                    off</span>
                            </div>
                        </button>
                        <input type="file" id="entry-excel-upload" accept=".xlsx,.xls,.csv" class="hidden">

                        <button id="btn-entry-fresh" type="button" onclick="window.showSetup && window.showSetup(null)"
                            class="entry-card holographic btn-3d magnetic relative group overflow-hidden rounded-2xl p-8 flex flex-col items-center justify-center gap-4 text-center transition-all duration-300 hover:scale-[1.02] active:scale-[0.98]"
                            style="background: linear-gradient(160deg, rgba(99,102,241,0.08) 0%, rgba(0,0,0,0.4) 50%, rgba(99,102,241,0.05) 100%); border: 1.5px solid rgba(99,102,241,0.2);">
                            <div
                                class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                            </div>
                            <div
                                class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-3/4 h-8 bg-indigo-500/20 blur-[20px] opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                            </div>
                            <div
                                class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/25 to-indigo-600/10 flex items-center justify-center border border-indigo-500/25 group-hover:border-indigo-400/40 transition-all duration-300 shadow-[0_4px_20px_rgba(99,102,241,0.15)] floating">
                                <i class="fa-solid fa-wand-magic-sparkles text-indigo-400 text-3xl"></i>
                            </div>
                            <div class="relative">
                                <span class="block font-bold text-lg tracking-wide text-white mb-1">Start Fresh</span>
                                <span class="text-xs text-indigo-300/50 font-medium">Set up your class and start
                                    grading</span>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- PHASE 2: SETUP (shown after entry choice) -->
                <div id="setup-phase"
                    class="hidden bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">

                    <!-- Back button -->
                    <button id="btn-back-to-landing" type="button" onclick="window.showLanding && window.showLanding()"
                        class="text-muted-foreground hover:text-white text-sm font-bold mb-4 flex items-center gap-2 transition-colors">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>

                    <!-- Context banner (shown for returning teachers) -->
                    <div id="setup-context-banner"
                        class="hidden bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-circle-check text-emerald-400 text-lg mt-0.5"></i>
                            <div>
                                <p id="setup-context-text" class="text-sm font-bold text-white"></p>
                                <p id="setup-context-sub" class="text-xs text-emerald-300/70 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-black/20 rounded-xl border border-white/5 p-4 md:p-6 relative z-10 shadow-inner max-w-2xl mx-auto">

                        <!-- Class & Subject -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <!-- Target Classes (Multi-select chip picker) -->
                            <div class="space-y-2 group md:col-span-2">
                                <label
                                    class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1"><i
                                        class="fa-solid fa-school mr-1.5"></i>Your
                                    Classes</label>
                                <div id="class-picker-container"
                                    class="bg-black/30 rounded-xl border border-white/5 p-4">
                                    <div class="chip-grid flex flex-wrap gap-2 items-center">
                                        <!-- Chips populated dynamically by app-enhancements.js -->
                                        <button type="button" id="btn-add-class-chip"
                                            onclick="document.getElementById('btn-open-paste-modal').click()">
                                            <i class="fa-solid fa-plus mr-1.5"></i> Add Class
                                        </button>
                                    </div>
                                </div>
                                <!-- Hidden: old dropdown kept for backward compatibility -->
                                <select id="target-class" class="hidden">
                                    <option value="" disabled selected>-- Select a Class --</option>
                                </select>
                                <button type="button" id="btn-open-paste-modal" class="hidden" title="Add New Class">
                                </button>
                            </div>

                            <!-- Subject Select -->
                            <div class="space-y-2 focus-within:z-20 relative">
                                <label
                                    class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Subject
                                    Name</label>
                                <div class="flex gap-2 relative">
                                    <div
                                        class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors flex-1 relative rounded-xl">
                                        <select id="subject-name"
                                            class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-bold">
                                            <option value="" disabled selected class="bg-card">-- Select a Subject
                                                --
                                            </option>
                                            <option value="Mathematics" class="bg-card">Mathematics</option>
                                            <option value="English" class="bg-card">English</option>
                                            <option value="Basic Science" class="bg-card">Basic Science</option>
                                            <option value="Biology" class="bg-card">Biology</option>
                                            <option value="Chemistry" class="bg-card">Chemistry</option>
                                            <option value="Physics" class="bg-card">Physics</option>
                                            <option value="custom" class="bg-card">-- Custom Subject --</option>
                                        </select>
                                        <i
                                            class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                        <div class="input-focus-anim rounded-xl"></div>
                                    </div>
                                </div>
                                <div class="input-wrapper border border-white/10 bg-black/40 mt-2 hidden rounded-xl"
                                    id="custom-subject-wrapper">
                                    <input type="text" id="custom-subject"
                                        class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-bold tracking-wide"
                                        placeholder="e.g., History">
                                    <div class="input-focus-anim rounded-xl"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Assessment Type -->
                        <div id="assessment-type-container"
                            class="space-y-2 focus-within:z-20 relative mb-5 pt-4 border-t border-white/5 border-dashed">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Assessment
                                Type</label>
                            <div class="flex gap-2 relative">
                                <div
                                    class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors flex-[2] relative rounded-xl">
                                    <select id="assessment-type"
                                        class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-bold tracking-wide">
                                        <option value="" disabled selected class="bg-card">-- Select Assessment Type
                                            --
                                        </option>
                                        <option value="1st CA" class="bg-card">1st CA</option>
                                        <option value="2nd CA" class="bg-card">2nd CA</option>
                                        <option value="Exam" class="bg-card">Exam</option>
                                        <option value="Open Day" class="bg-card">Open Day</option>
                                        <option value="Assignment" class="bg-card">Assignment</option>
                                        <option value="custom" class="bg-card">-- Custom --</option>
                                    </select>
                                    <i
                                        class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                    <div class="input-focus-anim rounded-xl"></div>
                                </div>
                            </div>
                            <p id="assessment-hint" class="text-[10px] text-primary/70 pl-1 hidden"><i
                                    class="fa-solid fa-wand-magic-sparkles mr-1"></i><span></span></p>
                            <div class="input-wrapper border border-white/10 bg-black/40 mt-2 hidden rounded-xl"
                                id="custom-assessment-wrapper">
                                <input type="text" id="custom-assessment"
                                    class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-bold tracking-wide"
                                    placeholder="e.g., Final Project">
                                <div class="input-focus-anim rounded-xl"></div>
                            </div>
                        </div>

                        <!-- Subject Type: General or Elective -->
                        <div id="subject-type-section" class="pt-4 border-t border-white/5 border-dashed mb-5 hidden">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1 mb-3">
                                <i class="fa-solid fa-bookmark mr-1.5"></i>Subject Type
                            </label>
                            <div class="flex rounded-xl overflow-hidden border border-white/10 bg-black/30">
                                <button type="button" id="btn-subject-general"
                                    class="flex-1 py-3 px-4 text-xs font-bold transition-all text-white bg-primary/20 border-r border-white/10 flex items-center justify-center gap-2 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                                    <i class="fa-solid fa-users text-primary"></i> General
                                </button>
                                <button type="button" id="btn-subject-elective"
                                    class="flex-1 py-3 px-4 text-xs font-bold transition-all text-muted-foreground hover:text-white flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-user-check text-yellow-400/50"></i> Elective
                                </button>
                            </div>
                            <p id="subject-type-desc" class="text-[10px] text-muted-foreground/70 pl-1 mt-2">
                                <i class="fa-solid fa-circle-info mr-1 text-primary/50"></i>Every student in the class
                                takes this subject. We'll let you know if anyone is missing after grading.
                            </p>
                        </div>

                        <!-- Smart Mode Toggle -->
                        <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-3 mb-6">
                            <div class="flex items-center justify-between w-full cursor-pointer group"
                                id="btn-toggle-smart-mode">
                                <div>
                                    <label
                                        class="text-[11px] font-bold text-indigo-300 uppercase tracking-widest pl-1 block cursor-pointer flex items-center gap-2 group-hover:text-indigo-200 transition-colors">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI Smart Mode
                                    </label>
                                    <p class="text-[10px] text-indigo-200/50 pl-1 mt-0.5 max-w-[200px] leading-tight">
                                        Give the AI custom instructions.</p>
                                </div>
                                <div class="w-10 h-5 bg-black/50 rounded-full relative shadow-inner border border-white/10 transition-colors"
                                    id="smart-mode-switch-bg">
                                    <div class="w-3 h-3 bg-muted-foreground rounded-full absolute top-1 left-1 transition-all"
                                        id="smart-mode-switch-knob"></div>
                                </div>
                            </div>
                            <div id="smart-instruction-wrapper" class="hidden mt-3 animation-fade-in relative w-full">
                                <textarea id="smart-instruction-input" rows="2"
                                    class="w-full p-3 bg-black/40 border border-indigo-500/30 rounded-lg text-white text-xs outline-none placeholder:text-muted-foreground/50 focus:border-indigo-400 focus:bg-black/60 transition-all font-bold tracking-wide resize-none"
                                    placeholder="e.g., 'The final score is circled in red ink at the top of the page'"></textarea>
                            </div>
                        </div>

                        <!-- How to add scores -->
                        <div class="pt-6 border-t border-white/5">
                            <h3 class="text-lg font-heading font-bold text-white mb-4 tracking-tight text-center">
                                How
                                would you like to add scores?</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button id="btn-start-camera" type="button"
                                    class="entry-card holographic btn-3d magnetic bg-black/40 hover:bg-primary/10 border border-white/10 hover:border-primary/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-glow relative overflow-hidden h-full">
                                    <div
                                        class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-camera text-primary text-xl"></i>
                                    </div>
                                    <span class="font-bold text-[15px] tracking-wide">I Have the Scripts</span>
                                    <span class="text-[11px] text-muted-foreground font-medium">Scan test papers one
                                        by
                                        line.<br>The AI reads name & score.</span>
                                </button>

                                <button id="btn-upload-scoresheet" type="button"
                                    class="entry-card holographic btn-3d bg-black/40 hover:bg-indigo-500/10 border border-white/10 hover:border-indigo-500/50 text-white p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group text-center shadow-inner hover:shadow-[0_0_20px_rgba(99,102,241,0.2)] relative overflow-hidden h-full">
                                    <div
                                        class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fa-solid fa-file-invoice text-indigo-400 text-xl"></i>
                                    </div>
                                    <span class="font-bold text-[15px] tracking-wide">I Have a Score List</span>
                                    <span class="text-[11px] text-muted-foreground font-medium">Upload a photo of
                                        your<br>recorded grades.</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

            </section>

            <!-- Step 1: Capture Area -->
            <section id="capture-section"
                class="hidden reveal reveal-delay-1 bg-card rounded-[1.5rem] border border-white/5 p-2 md:p-6 mb-12 relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <!-- Inner subtle gradient for volume -->
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <!-- Header (Compact) -->
                <div class="flex flex-col mb-4 relative z-10">
                    <div class="flex items-center mb-1">
                        <button
                            onclick="document.getElementById('capture-section').classList.add('hidden'); document.getElementById('start-section').classList.remove('hidden'); document.getElementById('app-hero').classList.remove('hidden'); if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}"
                            class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center mr-3 text-white/50 hover:text-white hover:bg-white/10 transition-all"
                            title="Back">
                            <i class="fa-solid fa-arrow-left text-sm"></i>
                        </button>
                        <h2 class="text-xl font-heading font-bold text-white tracking-tight flex items-center">
                            <span
                                class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center mr-3 border border-primary/20 shadow-glow"><i
                                    class="fa-solid fa-camera text-primary text-sm"></i></span>
                            Capture Scripts
                        </h2>
                    </div>
                    <p class="text-muted-foreground text-sm font-medium ml-11">Point your phone at each student's paper
                        and press Capture.</p>
                </div>

                <!-- Video Feed with Overlays -->
                <div id="video-container"
                    class="mb-6 border-2 border-primary/20 flex items-center justify-center bg-black shadow-inner overflow-hidden relative group z-10 rounded-2xl">
                    <video id="camera-feed" class="w-full h-full object-cover relative z-0" autoplay
                        playsinline></video>

                    <!-- OpenCV Canvas Visualizer -->
                    <canvas id="cv-visualizer"
                        class="absolute inset-0 w-full h-full z-10 pointer-events-none opacity-80 mix-blend-screen"></canvas>

                    <div id="camera-loading"
                        class="absolute z-20 text-muted-foreground text-sm flex flex-col items-center gap-3 bg-black/70 backdrop-blur-xl p-5 rounded-2xl border border-white/5">
                        <i class="fa-solid fa-circle-notch fa-spin text-primary text-3xl"></i>
                        <span class="font-medium tracking-wide">Initializing Camera...</span>
                    </div>

                    <!-- Top Overlays -->
                    <div
                        class="absolute top-3 left-3 right-3 flex justify-between items-start z-20 pointer-events-none">
                        <!-- Queue Count -->
                        <div
                            class="pointer-events-auto bg-black/60 backdrop-blur-md border border-white/10 text-[10px] font-semibold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm text-white uppercase tracking-widest hidden">
                            Queue
                            <span id="batch-count"
                                class="bg-primary text-white px-2 py-0.5 rounded-md text-[10px] font-bold shadow-glow border border-primary/30">0/10</span>
                        </div>

                        <div class="flex gap-2">
                            <!-- Flashlight Toggle -->
                            <button id="btn-flashlight"
                                class="pointer-events-auto w-10 h-10 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-white transition-all hover:scale-105 active:scale-95 shadow-sm flex items-center justify-center hidden">
                                <i class="fa-solid fa-bolt"></i>
                            </button>

                            <!-- Flip Camera -->
                            <button id="btn-camera"
                                class="pointer-events-auto w-10 h-10 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-white transition-all hover:scale-105 active:scale-95 shadow-sm flex items-center justify-center">
                                <i class="fa-solid fa-camera-rotate"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Bottom Overlays -->
                    <div class="absolute bottom-3 inset-x-3 flex justify-center z-20 pointer-events-none">
                        <!-- Auto-Capture Toggle -->
                        <div
                            class="pointer-events-auto flex flex-col items-center gap-1 bg-black/80 backdrop-blur-xl px-5 py-3 rounded-2xl border border-white/10 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.8)] max-w-[280px]">
                            <div class="flex items-center gap-3 w-full justify-center mb-1">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auto-capture-toggle" class="sr-only peer">
                                    <div
                                        class="w-9 h-5 bg-muted-foreground/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary shadow-inner">
                                    </div>
                                </label>
                                <span
                                    class="text-[11px] font-bold text-white tracking-widest uppercase leading-tight drop-shadow-md">AI
                                    Auto-Capture</span>
                                <div id="auto-capture-status"
                                    class="w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow">
                                </div>
                            </div>
                            <span class="text-[9px] text-muted-foreground/80 font-medium text-center leading-tight">When
                                turned on, the camera will snap automatically when it sees a paper in frame.</span>
                        </div>
                    </div>
                </div>

                <!-- Capture Controls (SNAP button full width) -->
                <div class="mb-6 relative z-10 px-2 lg:px-0">
                    <button id="btn-capture"
                        class="magnetic shadow-glow bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl w-full mx-auto transition-all active:scale-95 flex items-center justify-center tracking-wide overflow-hidden relative group">
                        <span
                            class="absolute inset-0 w-full h-full bg-white opacity-0 active:opacity-40 transition-opacity duration-100 mix-blend-overlay"></span>
                        <i class="fa-solid fa-camera mr-2 group-hover:scale-110 transition-transform"></i> <span
                            class="tracking-widest uppercase text-sm">Capture Script</span>
                    </button>
                </div>

                <!-- Captured Thumbnails -->
                <div id="thumbnails-container"
                    class="flex overflow-x-auto space-x-3 py-2 mb-32 min-h-[80px] relative z-10 scrollbar-hide pointer-events-auto">
                </div>

                <!-- Action Area / Sticky Bottom Bar -->
                <div id="grading-action-bar"
                    class="fixed bottom-0 left-0 right-0 p-4 z-50 transform translate-y-full transition-transform duration-300 bg-black/80 backdrop-blur-xl border-t border-white/10 flex justify-center hidden">
                    <button id="btn-process" disabled
                        class="w-full max-w-md magnetic holographic shadow-glow-lg bg-primary border border-primary/50 text-white font-extrabold text-sm uppercase px-10 py-4 rounded-xl transition-all active:scale-95 flex items-center justify-center tracking-widest group shadow-[0_0_20px_rgba(var(--brand-rgb),0.5)]">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2 group-hover:scale-110 transition-transform"></i>
                        <span id="btn-process-text">Grade 0 papers now ‚Üí</span>
                    </button>
                </div>

                <div id="processing-indicator"
                    class="hidden text-center mt-8 mb-4 text-primary font-medium flex flex-col items-center justify-center gap-3">
                    <div class="relative flex items-center justify-center p-2">
                        <div
                            class="absolute inset-0 border-2 border-primary/20 border-t-primary rounded-full animate-spin">
                        </div>
                        <i class="fa-solid fa-microchip text-primary"></i>
                    </div>
                    <span
                        class="text-xs font-bold tracking-widest uppercase border border-primary/20 bg-primary/10 px-5 py-2 rounded-full shadow-glow">AI
                        is Grading Papers...</span>
                </div>

            </section>

            <!-- Step 2: Review Area -->
            <section id="review-section"
                class="reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mt-16 mb-8 hidden relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <div
                    class="flex flex-col md:flex-row md:justify-between items-start md:items-center mb-10 gap-4 relative z-10">
                    <div class="flex flex-col">
                        <div class="flex items-center mb-1">
                            <button
                                onclick="document.getElementById('review-section').classList.add('hidden'); document.getElementById('capture-section').classList.remove('hidden'); document.getElementById('app-hero').classList.add('hidden'); if(typeof initCamera === 'function') initCamera();"
                                class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center mr-3 text-white/50 hover:text-white hover:bg-white/10 transition-all"
                                title="Back to capture">
                                <i class="fa-solid fa-arrow-left text-sm"></i>
                            </button>
                            <h2
                                class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight flex items-center">
                                <span
                                    class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center mr-3 border border-white/10 shadow-sm"><i
                                        class="fa-solid fa-list-check text-white text-sm"></i></span>
                                Review Grades
                            </h2>
                        </div>
                        <p class="text-muted-foreground text-sm font-medium ml-11">Check the AI's work. Fix any
                            mistakes, then
                            Save.</p>
                    </div>
                    <button id="btn-reset"
                        class="text-xs font-bold tracking-widest uppercase text-muted-foreground hover:text-white transition-colors px-4 py-2 rounded-lg border border-white/5 hover:border-white/20 bg-black/40 hover:bg-black/60 flex items-center shadow-sm">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Delete these & Start Over
                    </button>
                </div>

                <div class="overflow-x-visible md:overflow-x-auto mb-10 relative z-10">
                    <table class="w-full text-sm text-left block md:table">
                        <thead
                            class="hidden md:table-header-group text-[11px] uppercase bg-black/60 border-b border-white/5 tracking-widest font-bold text-muted-foreground/80">
                            <tr>
                                <th scope="col" class="px-5 py-4 rounded-tl-xl border-r border-white/5">Student Name
                                    <span class="text-primary">*</span>
                                </th>
                                <th scope="col" class="px-5 py-4 border-r border-white/5">Class</th>
                                <th scope="col" class="px-5 py-4 text-right rounded-tr-xl" id="score-th">Score</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="block md:table-row-group space-y-4 md:space-y-0">
                            <!-- Results go here via JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Help Tip: Missing a student? -->
                <div id="missing-score-tip"
                    class="hidden mb-6 relative z-10 bg-amber-500/5 border border-amber-500/20 rounded-xl p-4 flex items-start gap-3 animate-fade-in-up">
                    <i class="fa-solid fa-lightbulb text-amber-400 mt-0.5 text-lg"></i>
                    <div class="flex-1">
                        <h4 class="text-amber-400 font-bold text-xs tracking-wide uppercase mb-1">Missing a student's
                            score?
                        </h4>
                        <p class="text-amber-200/70 text-[11px] font-medium leading-relaxed">Click <strong
                                class="text-amber-300">"+ Add Student"</strong> below to type it in manually, or go back
                            and
                            re-scan just that student's paper ‚Äî it will be matched and merged automatically.</p>
                    </div>
                    <button onclick="this.parentElement.classList.add('hidden')"
                        class="text-amber-500/40 hover:text-amber-400 transition-colors p-1 shrink-0"><i
                            class="fa-solid fa-xmark text-sm"></i></button>
                </div>

                <!-- Add Student Manually Button -->
                <button id="btn-add-manual-row" type="button" onclick="addManualRow()"
                    class="mb-6 w-full py-3 rounded-xl border-2 border-dashed border-white/10 hover:border-primary/40 text-muted-foreground hover:text-white bg-transparent hover:bg-primary/5 transition-all flex items-center justify-center gap-2 text-sm font-bold tracking-wide group relative z-10">
                    <i class="fa-solid fa-plus text-primary group-hover:scale-110 transition-transform"></i>
                    <span>Add Student Manually</span>
                </button>


                <button id="btn-export"
                    class="magnetic holographic shadow-glow w-full bg-primary hover:bg-primary/90 text-white font-extrabold text-sm uppercase tracking-widest py-5 px-6 rounded-xl transition-all active:scale-95 flex justify-center items-center group relative z-10 border border-t-white/30 border-primary shadow-[0_4px_14px_0_rgba(var(--brand-rgb),0.39)]">
                    <i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Save
                    Grades to Active Roster
                </button>
                <div id="export-msg" class="text-center mt-5 text-sm font-bold hidden relative z-10"></div>

                <!-- Feedback / What's Next block -->
                <div id="whats-next-block"
                    class="hidden mt-8 pt-8 border-t border-white/5 animate-fade-in-up relative z-10">
                    <h3
                        class="text-white font-bold text-[11px] uppercase tracking-widest mb-2 flex items-center gap-2 text-indigo-400">
                        <i class="fa-solid fa-lightbulb"></i> What would you like to do next?
                    </h3>

                    <!-- Dynamic state messages will go here -->
                    <p id="whats-next-message" class="text-sm text-muted-foreground mb-4 font-medium leading-relaxed">
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="whats-next-actions">
                        <!-- Actions injected via JS based on context -->
                    </div>
                </div>
            </section>
            <!-- Step 3: Analytics Dashboard (Appears after export) -->
            <section id="analytics-section"
                class="hidden reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mb-12 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">
                <div class="flex flex-col mb-8">
                    <div class="flex items-center gap-3 mb-1">
                        <span
                            class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shadow-glow"><i
                                class="fa-solid fa-chart-pie text-emerald-400 text-sm"></i></span>
                        <h2 class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight">Results Summary
                        </h2>
                    </div>
                    <p class="text-muted-foreground text-sm font-medium ml-11">Here's how the class performed. Download
                        the
                        spreadsheet below.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Average Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-chart-line text-4xl text-primary"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Class Average
                        </p>
                        <p id="stat-avg" class="text-4xl font-extrabold text-white">--</p>
                    </div>
                    <!-- Highest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-up text-4xl text-emerald-400"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Highest Score
                        </p>
                        <p id="stat-high" class="text-4xl font-extrabold text-emerald-400">--</p>
                        <p id="stat-high-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                    <!-- Lowest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-down text-4xl text-destructive"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Lowest Score
                        </p>
                        <p id="stat-low" class="text-4xl font-extrabold text-destructive">--</p>
                        <p id="stat-low-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="btn-download-sheet" onclick="window.location.href='/download-sheet'"
                        class="w-full md:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-glow flex items-center justify-center group mb-2 md:mb-0">
                        <i class="fa-solid fa-download mr-2 group-hover:translate-y-1 transition-transform"></i>
                        Download Excel
                    </button>
                    <button id="btn-share-sheet"
                        class="w-full md:w-auto bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-300 font-bold py-4 px-8 rounded-xl transition-all shadow-sm border border-indigo-500/20 flex items-center justify-center group mb-2 md:mb-0"
                        onclick="if(navigator.share){navigator.share({title:'Scoresheet',text:'Here is the scoresheet backup',url:window.location.href}).catch(()=>{})}else{navigator.clipboard.writeText(window.location.origin+'/download-sheet').then(()=>{if(typeof showToast==='function')showToast('Link copied!','success')})}">
                        <i class="fa-solid fa-share-nodes mr-2 group-hover:scale-110 transition-transform"></i>
                        Share to Colleague
                    </button>
                    <button id="btn-new-batch"
                        class="w-full md:w-auto bg-white/5 hover:bg-white/10 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-sm border border-white/10 flex items-center justify-center group">
                        <i
                            class="fa-solid fa-rotate-right mr-2 group-hover:-rotate-90 transition-transform duration-500"></i>
                        Scan More Papers
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer
            class="mt-20 mb-10 text-center text-muted-foreground/40 text-[10px] uppercase font-bold tracking-widest animate-fade-in-up flex items-center justify-center gap-2"
            style="animation-delay: 0.5s;">
            <div class="w-8 h-px bg-white/10"></div>
            <p>Made with <span class="text-destructive mx-1 animate-pulse inline-block opacity-80">‚ù§Ô∏è</span> for <span
                    class="text-white/80">QSI</span></p>
            <div class="w-8 h-px bg-white/10"></div>
        </footer>
    </div>

    <!-- Modal: Upload Score List Photo -->
    <div id="upload-scoresheet-modal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm items-center justify-center p-4 transition-all duration-300 opacity-0 font-sans"
        onclick="if(event.target===this){this.classList.remove('flex');this.classList.add('hidden');}">
        <div
            class="bg-card w-full max-w-md rounded-2xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div
                class="px-6 py-4 border-b border-indigo-500/20 flex justify-between items-center bg-black/40 relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-transparent pointer-events-none">
                </div>
                <h3 class="text-lg font-heading font-bold text-white tracking-tight flex items-center relative z-10">
                    <i
                        class="fa-solid fa-file-invoice text-indigo-400 mr-3 text-xl drop-shadow-[0_0_10px_rgba(99,102,241,0.5)]"></i>
                    Upload Score List
                </h3>
                <button id="btn-close-scoresheet-modal"
                    class="text-muted-foreground hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5 relative z-10">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <p class="text-sm text-muted-foreground mb-6 text-center leading-relaxed">
                    Upload a clear photo of your handwritten score list. The AI will read all student names and scores
                    from the page.
                </p>
                <div class="border-2 border-dashed border-white/10 hover:border-indigo-500/30 rounded-xl p-6 text-center transition-colors cursor-pointer group"
                    onclick="document.getElementById('scoresheet-file').click()">
                    <i
                        class="fa-solid fa-cloud-arrow-up text-3xl text-indigo-400/50 group-hover:text-indigo-400 transition-colors mb-3 block"></i>
                    <p class="text-sm font-bold text-white/80">Tap to select photo</p>
                    <p class="text-[10px] text-muted-foreground mt-1">JPG, PNG, or HEIC</p>
                </div>
                <input type="file" id="scoresheet-file" accept="image/*" class="hidden">
                <p id="scoresheet-msg"
                    class="text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 hidden"></p>
            </div>
            <div class="p-6 border-t border-white/5 bg-black/20 shrink-0">
                <button type="button" id="btn-submit-scoresheet"
                    class="bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-4 rounded-xl w-full transition-all shadow-[0_0_20px_rgba(99,102,241,0.3)] flex items-center justify-center gap-2 group text-sm tracking-widest uppercase">
                    <i class="fa-solid fa-wand-magic-sparkles group-hover:scale-110 transition-transform"></i> Scan
                    Score List
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Upload Excel Score Sheet (Resume Grading) -->
    <div id="upload-xlsx-modal"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm items-center justify-center p-4 transition-all duration-300 opacity-0 font-sans">
        <div
            class="bg-card w-full max-w-md rounded-2xl border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div
                class="px-6 py-4 border-b border-emerald-500/20 flex justify-between items-center bg-black/40 relative overflow-hidden shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-transparent pointer-events-none">
                </div>
                <h3 class="text-lg font-heading font-bold text-white tracking-tight flex items-center relative z-10"><i
                        class="fa-solid fa-file-excel text-emerald-400 mr-3 text-xl drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]"></i>
                    Update Score List</h3>
                <button id="btn-close-xlsx-modal"
                    class="text-muted-foreground hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5 relative z-10"><i
                        class="fa-solid fa-xmark text-lg"></i></button>
            </div>

            <div class="p-6 md:p-8 overflow-y-auto flex-1">
                <p class="text-sm text-muted-foreground mb-6 text-center leading-relaxed">Select an existing Excel sheet
                    (e.g., from a previous session) to continue grading or bulk update scores. The system will
                    auto-detect columns.
                </p>
                <div class="space-y-1.5 focus-within:z-20 relative border border-emerald-500/30 bg-emerald-500/5 hover:bg-emerald-500/10 transition-colors rounded-xl p-6 border-dashed cursor-pointer shadow-[0_0_15px_rgba(16,185,129,0.05)] group flex flex-col items-center justify-center"
                    onclick="document.getElementById('xlsx-file').click()">
                    <i
                        class="fa-solid fa-file-arrow-up text-4xl text-emerald-400/80 mb-3 group-hover:-translate-y-1 transition-transform"></i>
                    <p class="text-[11px] font-bold text-white uppercase tracking-widest text-center">Select Excel
                        (.xlsx) / CSV</p>
                    <p class="text-xs text-muted-foreground mt-1 truncate px-2 text-center" id="xlsx-file-label">
                        Tap to choose file</p>
                    <input type="file" id="xlsx-file" accept=".xlsx, .xls, .csv" class="hidden"
                        onchange="document.getElementById('xlsx-file-label').innerText = this.files[0] ? this.files[0].name : 'Tap to choose file';">
                </div>
            </div>

            <div class="p-6 border-t border-white/5 bg-black/20 shrink-0">
                <button type="button" id="btn-submit-xlsx"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl w-full transition-all shadow-[0_0_15px_rgba(16,185,129,0.4)] flex items-center justify-center gap-2 group text-sm tracking-widest uppercase"><i
                        class="fa-solid fa-magnifying-glass-chart group-hover:scale-110 transition-transform"></i>
                    Update
                    Score List</button>
                <div id="xlsx-msg"
                    class="text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 text-white">
                </div>
            </div>
        </div>
    </div>

    <!-- Invisible Canvas for capturing image frames -->
    <canvas id="canvas" class="hidden"></canvas>

    <!-- Paste Roster Modal -->
    <div id="paste-modal"
        class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div
            class="bg-card w-full max-w-md mx-4 rounded-2xl border border-white/10 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.8)] p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-white font-bold text-lg tracking-wide"><i
                        class="fa-solid fa-paste text-primary mr-2"></i>Type or Paste Student Names</h3>
                <button id="btn-close-paste"
                    class="text-white/50 hover:text-white transition-colors w-8 h-8 flex justify-center items-center rounded-full hover:bg-white/10">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="space-y-2 group">
                    <label
                        class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Class
                        Name
                    </label>
                    <div class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                        <input type="text" id="paste-target-class"
                            class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide"
                            placeholder="e.g., JSS 1, SS 2A" autocomplete="off" required>
                        <div class="input-focus-anim"></div>
                    </div>
                </div>

                <div class="space-y-2 group">
                    <label
                        class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1 flex justify-between">
                        <span>Student Names</span>
                        <span class="text-primary/70">One per line</span>
                    </label>
                    <p class="text-[10px] text-yellow-500/80 px-1 mb-2 leading-tight">Must upload the <b>COMPLETE class
                            list</b> so the AI has 100% handwriting recognition accuracy.</p>
                    <div class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                        <textarea id="paste-raw-text" rows="8"
                            class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide resize-none"
                            placeholder="Ajayi Elizabeth&#x0a;Oluwatoyin Jewel&#x0a;..."></textarea>
                        <div class="input-focus-anim"></div>
                    </div>
                </div>

                <button id="btn-submit-paste"
                    class="magnetic w-full bg-primary hover:bg-primary/90 text-white font-bold py-3.5 rounded-xl transition-all shadow-glow mt-2 flex justify-center items-center">
                    Save Student Names
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  TOAST NOTIFICATION SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const icons = { success: 'fa-circle-check', warning: 'fa-triangle-exclamation', error: 'fa-circle-xmark', info: 'fa-circle-info' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${icons[type] || icons.info} toast-icon"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.remove(), 300)">
                    <i class="fa-solid fa-xmark"></i>
                </button>`;
            container.appendChild(toast);
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('toast-exit');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  LANDING PAGE LOGIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', function () {
            const landingPhase = document.getElementById('landing-phase');
            const setupPhase = document.getElementById('setup-phase');

            window.showLanding = function () {
                if (landingPhase) landingPhase.classList.remove('hidden');
                if (setupPhase) setupPhase.classList.add('hidden');
            };

            window.showSetup = function (contextText, contextSub) {
                if (landingPhase) landingPhase.classList.add('hidden');
                if (setupPhase) {
                    setupPhase.classList.remove('hidden');
                    setupPhase.style.opacity = '0';
                    setupPhase.style.transform = 'translateY(20px)';
                    requestAnimationFrame(() => {
                        setupPhase.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                        setupPhase.style.opacity = '1';
                        setupPhase.style.transform = 'translateY(0)';
                    });
                }
                // Refresh class chip picker so existing classes show up
                if (typeof window.initClassPicker === 'function') {
                    window.initClassPicker();
                }
                const banner = document.getElementById('setup-context-banner');
                if (contextText && banner) {
                    document.getElementById('setup-context-text').textContent = contextText;
                    document.getElementById('setup-context-sub').textContent = contextSub || '';
                    banner.classList.remove('hidden');
                } else if (banner) {
                    banner.classList.add('hidden');
                }
            };

            // Back button
            const btnBackToLanding = document.getElementById('btn-back-to-landing');
            if (btnBackToLanding) btnBackToLanding.addEventListener('click', window.showLanding);

            // "Start Fresh" button ‚Äî wipe all caches
            const btnEntryFresh = document.getElementById('btn-entry-fresh');
            if (btnEntryFresh) {
                btnEntryFresh.addEventListener('click', () => {
                    // Clear all cached session data
                    if (typeof clearSessionData === 'function') clearSessionData();
                    extractedData = [];
                    imagesBatch = [];
                    if (typeof window._excelRecords !== 'undefined') window._excelRecords = null;
                    // Reset form fields
                    const tc = document.getElementById('target-class');
                    if (tc) tc.selectedIndex = 0;
                    const sj = document.getElementById('subject-name');
                    if (sj) sj.selectedIndex = 0;
                    const at = document.getElementById('assessment-type');
                    if (at) at.selectedIndex = 0;
                    currentSubjectName = '';
                    finalAssessmentType = '';
                    window.showSetup(null);
                });
            }

            // "I Have My Excel" button
            const btnEntryExcel = document.getElementById('btn-entry-excel');
            const entryExcelUpload = document.getElementById('entry-excel-upload');
            if (btnEntryExcel && entryExcelUpload) {
                btnEntryExcel.addEventListener('click', () => entryExcelUpload.click());
                entryExcelUpload.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    btnEntryExcel.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-400"></i><span class="font-bold">Loading...</span>';
                    btnEntryExcel.disabled = true;

                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const response = await fetch('/api/upload-excel-scorelist', { method: 'POST', body: formData });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'Failed to parse file');

                        const tc = document.getElementById('target-class');
                        if (result.detected_class && tc) {
                            let found = false;
                            for (let opt of tc.options) {
                                if (opt.value.toLowerCase() === result.detected_class.toLowerCase()) {
                                    tc.value = opt.value; found = true; break;
                                }
                            }
                            if (!found) tc.add(new Option(result.detected_class, result.detected_class, true, true));
                        }

                        if (result.detected_subject) {
                            const sj = document.getElementById('subject-name');
                            const csj = document.getElementById('custom-subject');
                            const csjw = document.getElementById('custom-subject-wrapper');
                            if (sj) { sj.value = 'custom'; if (csjw) csjw.classList.remove('hidden'); if (csj) csj.value = result.detected_subject; }
                        }

                        if (result.detected_assessments && result.detected_assessments.length > 0) {
                            const order = ['1st CA', '2nd CA', 'Exam'];
                            let next = 'Score';
                            for (const a of order) { if (!result.detected_assessments.includes(a)) { next = a; break; } }
                            const at = document.getElementById('assessment-type');
                            if (at) at.value = next;
                            const hint = document.getElementById('assessment-hint');
                            if (hint) {
                                hint.classList.remove('hidden');
                                hint.querySelector('span').textContent = `You have ${result.detected_assessments.join(', ')} scores. Suggesting ${next}.`;
                            }
                        }

                        const studentCount = result.records ? result.records.length : 0;
                        const className = result.detected_class || 'your class';
                        const existingAssessments = result.detected_assessments ? result.detected_assessments.join(', ') : '';
                        const ctxSub = existingAssessments ? `Existing scores: ${existingAssessments}` : '';
                        window.showSetup(`Found ${studentCount} students in ${className}.`, ctxSub);
                        showToast(`Loaded ${studentCount} students from Excel.`, 'success');
                        window._excelRecords = result.records;

                        // Track detected class in session
                        if (typeof addToSessionClasses === 'function' && result.detected_class) {
                            addToSessionClasses(result.detected_class);
                        }
                        // Track selected class in chip picker
                        if (typeof selectedClasses !== 'undefined' && result.detected_class) {
                            if (!selectedClasses.includes(result.detected_class)) {
                                selectedClasses.push(result.detected_class);
                            }
                        }

                        // Open Smart Assistant with parsed data
                        if (typeof openSmartAssistant === 'function') {
                            openSmartAssistant({
                                classes: result.detected_class ? [result.detected_class] : [],
                                subjects: result.detected_subject ? [result.detected_subject] : [],
                                studentCount: studentCount,
                                assessments: result.detected_assessments || []
                            });
                        }

                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                        // Try AI error explanation
                        if (typeof handleErrorWithAI === 'function') {
                            handleErrorWithAI(err, 'uploading Excel file');
                        }
                    } finally {
                        btnEntryExcel.innerHTML = '<div class="w-14 h-14 rounded-2xl bg-emerald-500/15 flex items-center justify-center mb-1 border border-emerald-500/20"><i class="fa-solid fa-file-excel text-emerald-400 text-2xl"></i></div><span class="font-bold text-[15px] tracking-wide">I Have My Excel</span><span class="text-[11px] text-muted-foreground font-medium leading-tight">Continue from where you left off.<br>Upload your previous score sheet.</span>';
                        btnEntryExcel.disabled = false;
                        entryExcelUpload.value = '';
                    }
                });
            }

            // Load recent sessions
            loadRecentSessions();
        });

        // Elements
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnCapture = document.getElementById('btn-capture');
        const btnSwitchCam = document.getElementById('btn-camera');
        const btnProcess = document.getElementById('btn-process');
        const loadingIndicator = document.getElementById('camera-loading');
        const batchCountEl = document.getElementById('batch-count');
        const thumbnailsContainer = document.getElementById('thumbnails-container');
        const processingIndicator = document.getElementById('processing-indicator');

        const captureSection = document.getElementById('capture-section');
        const reviewSection = document.getElementById('review-section');
        const analyticsSection = document.getElementById('analytics-section');
        const tbody = document.getElementById('results-tbody');
        const btnReset = document.getElementById('btn-reset');
        const btnExport = document.getElementById('btn-export');
        const exportMsg = document.getElementById('export-msg');
        const btnNewBatch = document.getElementById('btn-new-batch');

        // Auto-Capture Elements
        const autoCaptureToggle = document.getElementById('auto-capture-toggle');
        const autoCaptureStatus = document.getElementById('auto-capture-status');

        // Show a helpful tip when auto-capture is turned on
        if (autoCaptureToggle) {
            autoCaptureToggle.addEventListener('change', () => {
                if (autoCaptureToggle.checked && typeof showToast === 'function') {
                    showToast('Auto-capture is on! If it snaps too quickly or feels unstable, turn it off and use the manual capture button instead.', 'info');
                }
            });
        }

        // Start Section Elements
        const startSection = document.getElementById('start-section');
        const btnStartCamera = document.getElementById('btn-start-camera');

        // Target Class validation before scanning
        btnStartCamera.addEventListener('click', () => {
            const classSelect = document.getElementById('target-class');
            if (!classSelect.value) {
                showToast('Please select a Target Class before starting.', 'warning');
                return;
            }
            const subjSelect = document.getElementById('subject-name');
            if (!subjSelect || !subjSelect.value || subjSelect.value === '') {
                showToast('Please select a Subject first.', 'warning');
                return;
            }
            const assessmentSelect = document.getElementById('assessment-type');
            if (!assessmentSelect || !assessmentSelect.value || assessmentSelect.value === '') {
                showToast('Please select an Assessment Type first.', 'warning');
                return;
            }

            // Apply a loading state
            btnStartCamera.disabled = true;
            btnStartCamera.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i><span>Initializing...</span>`;

            // Immediate UI transition
            startSection.classList.add('hidden');
            captureSection.classList.remove('hidden');

            // Start the actual Camera
            initCamera();
        });

        // Config Elements
        const targetClassSelect = document.getElementById('target-class');

        // Upload Scoresheet button handler
        const btnUploadSheet = document.getElementById('btn-upload-scoresheet');
        if (btnUploadSheet) {
            btnUploadSheet.addEventListener('click', () => {
                const classSelect = document.getElementById('target-class');
                if (!classSelect || !classSelect.value) {
                    showToast('Please select a Target Class first.', 'warning');
                    return;
                }
                const modal = document.getElementById('upload-scoresheet-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                }
            });
        }
        const subjectNameSelect = document.getElementById('subject-name');
        const customSubjectWrapper = document.getElementById('custom-subject-wrapper');
        const customSubjectInput = document.getElementById('custom-subject');

        const assessmentTypeSelect = document.getElementById('assessment-type');
        const customAssessmentWrapper = document.getElementById('custom-assessment-wrapper');
        const customAssessmentInput = document.getElementById('custom-assessment');
        const scoreTh = document.getElementById('score-th');

        // Analytics Elements
        const statAvg = document.getElementById('stat-avg');
        const statHigh = document.getElementById('stat-high');
        const statHighName = document.getElementById('stat-high-name');
        const statLow = document.getElementById('stat-low');
        const statLowName = document.getElementById('stat-low-name');

        let imagesBatch = [];
        let extractedData = [];
        let currentFacingMode = 'environment';
        let stream = null;
        let imageIdCounter = 0;
        let finalAssessmentType = '';
        let currentSubjectName = '';

        function updateActionBar() {
            const actionBar = document.getElementById('grading-action-bar');
            const btnText = document.getElementById('btn-process-text');
            if (imagesBatch.length > 0) {
                actionBar.classList.remove('translate-y-full', 'hidden');
                btnProcess.disabled = false;
                btnText.innerText = `Grade ${imagesBatch.length} papers now ‚Üí`;
            } else {
                actionBar.classList.add('translate-y-full');
                btnProcess.disabled = true;
                setTimeout(() => actionBar.classList.add('hidden'), 300); // Wait for transition
            }
        }


        async function initCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            loadingIndicator.classList.remove('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    loadingIndicator.classList.add('hidden');
                };
            } catch (err) {
                console.error("Camera error:", err);
                loadingIndicator.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-destructive text-3xl mb-3 block"></i><span class="text-sm font-bold text-destructive">Camera Access Denied</span>`;
            }
        }

        // Smart Image Compression: only downscale if > MAX_WIDTH, preserving quality for low-end cameras
        const COMPRESS_MAX_WIDTH = 1600;
        const COMPRESS_QUALITY = 0.85;
        function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // If image is already small enough, skip compression entirely
                    if (img.width <= COMPRESS_MAX_WIDTH) {
                        resolve(base64Str);
                        return;
                    }
                    const ratio = COMPRESS_MAX_WIDTH / img.width;
                    const newW = COMPRESS_MAX_WIDTH;
                    const newH = Math.round(img.height * ratio);
                    const offscreen = document.createElement('canvas');
                    offscreen.width = newW;
                    offscreen.height = newH;
                    const octx = offscreen.getContext('2d');
                    octx.drawImage(img, 0, 0, newW, newH);
                    resolve(offscreen.toDataURL('image/jpeg', COMPRESS_QUALITY));
                };
                img.src = base64Str;
            });
        }

        // Initialization
        async function initCamera() {
            loadingIndicator.classList.remove('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                // Define loader removal handler BEFORE assigning the stream
                video.onloadedmetadata = () => {
                    loadingIndicator.classList.add('hidden');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                video.srcObject = stream;

                // Fallback in case onloadedmetadata fails to fire
                setTimeout(() => {
                    if (!loadingIndicator.classList.contains('hidden')) {
                        // If video width > 0, it means it loaded but didn't fire
                        if (video.videoWidth > 0) {
                            loadingIndicator.classList.add('hidden');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        }
                    }
                }, 2000);

                // Torch/Flashlight Capability Check
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities && track.getCapabilities();
                const btnFlashlight = document.getElementById('btn-flashlight');
                if (capabilities && capabilities.torch) {
                    btnFlashlight.classList.remove('hidden');
                } else {
                    btnFlashlight.classList.add('hidden');
                }
            } catch (err) {
                console.error("Error accessing camera:", err);
                loadingIndicator.classList.add('hidden');

                // Show a visible error message on the screen instead of just text
                const vc = document.getElementById('video-container');
                vc.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-8 text-center bg-black/80 rounded-2xl border border-destructive/30 backdrop-blur-sm m-4">
                        <div class="w-20 h-20 rounded-full bg-destructive/20 flex items-center justify-center mb-4 border border-destructive/40 shadow-[0_0_30px_rgba(239,68,68,0.3)]">
                            <i class="fa-solid fa-camera-slash text-destructive text-3xl"></i>
                        </div>
                        <h3 class="text-white text-xl font-bold mb-2 tracking-wide">Camera Access Failed</h3>
                        <p class="text-sm text-destructive/90 mb-6 font-medium max-w-sm">We couldn't access your camera. Please check your browser permissions or ensure a camera is connected.</p>
                        
                        <div class="bg-black/50 rounded-lg p-3 w-full border border-white/5 mb-6 text-left">
                            <p class="text-[10px] text-muted-foreground uppercase font-bold tracking-widest mb-1">Technical Details</p>
                            <p class="text-xs text-white/70 font-mono">${err.name || 'Error'}: ${err.message}</p>
                        </div>
                        
                        <button onclick="location.reload()" class="magnetic w-full py-3.5 bg-destructive/20 text-destructive border border-destructive/30 rounded-xl hover:bg-destructive/30 transition-all font-bold tracking-widest text-sm uppercase shadow-inner">
                            <i class="fa-solid fa-rotate-right mr-2 group-hover:rotate-180 transition-transform duration-500"></i>Reload Page
                        </button>
                    </div>
                `;
                showToast("Camera access denied or unavailable.", "error", 6000);
            }
        }

        // Flashlight Toggle Logic
        let flashEnabled = false;
        const btnFlashlight = document.getElementById('btn-flashlight');
        btnFlashlight.addEventListener('click', async () => {
            if (!stream) return;
            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities && track.getCapabilities();
            if (capabilities && capabilities.torch) {
                flashEnabled = !flashEnabled;
                try {
                    await track.applyConstraints({
                        advanced: [{ torch: flashEnabled }]
                    });
                    if (flashEnabled) {
                        btnFlashlight.classList.remove('bg-black/60', 'text-white');
                        btnFlashlight.classList.add('bg-yellow-500', 'text-black');
                        btnFlashlight.innerHTML = '<i class="fa-solid fa-bolt text-black"></i>';
                    } else {
                        btnFlashlight.classList.remove('bg-yellow-500', 'text-black');
                        btnFlashlight.classList.add('bg-black/60', 'text-white');
                        btnFlashlight.innerHTML = '<i class="fa-solid fa-bolt"></i>';
                    }
                } catch (e) {
                    console.error("Could not toggle flashlight:", e);
                }
            }
        });

        // Capture Image
        function compressImage(base64Str, maxWidth = 1200, quality = 0.85) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.floor(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        }

        function captureFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const rawBase64 = canvas.toDataURL('image/jpeg', 0.9); // Capture at high quality first
            const imageId = imageIdCounter++;
            const base64ForPreview = canvas.toDataURL('image/jpeg', 0.5); // Fast low res preview

            // Compress asynchronously (won't block the UI)
            compressImage(rawBase64).then(compressedBase64 => {
                imagesBatch.push({ id: imageId, base64: compressedBase64 });
                batchCountEl.innerText = imagesBatch.length;
                updateActionBar();
            });

            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'relative flex-shrink-0 group mt-2';
            thumbDiv.dataset.id = imageId;

            const img = document.createElement('img');
            img.src = base64ForPreview;
            img.className = 'captured-thumb shadow-sm group-hover:border-primary/50 transition-colors';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'absolute -top-2 -right-2 bg-black backdrop-blur-md hover:bg-destructive text-white border border-white/20 rounded-full w-6 h-6 flex items-center justify-center text-[10px] shadow-lg z-10 transition-all transform hover:scale-110';
            cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
            cancelBtn.title = 'Remove image';
            cancelBtn.onclick = function () {
                imagesBatch = imagesBatch.filter(item => item.id !== imageId);
                batchCountEl.innerText = imagesBatch.length;
                thumbDiv.remove();
                updateActionBar();
            };

            thumbDiv.appendChild(img);
            thumbDiv.appendChild(cancelBtn);
            thumbnailsContainer.appendChild(thumbDiv);

            if (navigator.vibrate) navigator.vibrate(50);

            // Shutter flash effect
            const container = document.getElementById('video-container');
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white z-50 mix-blend-overlay';
            container.appendChild(flash);
            setTimeout(() => {
                flash.style.transition = 'opacity 0.2s';
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 200);
            }, 50);
        }

        btnCapture.addEventListener('click', captureFrame);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  AUTO-CAPTURE v3: Document-Presence-First Architecture
        //  Instead of waiting for "stillness" (which fails with hand tremor),
        //  we continuously scan for a document and trigger after N consecutive
        //  detections. This is how CamScanner/Google Lens work.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let scanIntervalId = null;
        let consecutiveDetections = 0;
        const SCAN_INTERVAL_MS = 160;        // ~6 FPS OpenCV scans
        const DETECTIONS_TO_SNAP = 8;        // 8 consecutive = ~1.3s of seeing paper
        const COOLDOWN_AFTER_SNAP_MS = 3000; // 3s pause after snap to swap paper

        function scanForDocument() {
            const hudCanvas = document.getElementById('cv-visualizer');
            if (!hudCanvas) return false;

            const vw = video.videoWidth || 640;
            const vh = video.videoHeight || 480;
            hudCanvas.width = vw;
            hudCanvas.height = vh;
            const hudCtx = hudCanvas.getContext('2d');
            hudCtx.clearRect(0, 0, vw, vh);

            if (!video.videoWidth) return false;

            // Use a small canvas for fast pixel analysis
            const aw = 160, ah = 120;
            const ac = document.createElement('canvas');
            ac.width = aw; ac.height = ah;
            const actx = ac.getContext('2d', { willReadFrequently: true });

            try {
                actx.drawImage(video, 0, 0, aw, ah);
                const imgData = actx.getImageData(0, 0, aw, ah).data;

                // ‚îÄ‚îÄ CENTER vs EDGE BRIGHTNESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // When holding paper: center is BRIGHT (white paper), edges are DARK (background)
                // When pointing at floor/wall: brightness is UNIFORM everywhere
                // We measure the ratio to distinguish them.

                const margin = 0.2; // 20% border ring
                let centerSum = 0, centerCount = 0;
                let edgeSum = 0, edgeCount = 0;
                let centerR = 0, centerG = 0, centerB = 0;

                for (let y = 0; y < ah; y++) {
                    for (let x = 0; x < aw; x++) {
                        const idx = (y * aw + x) * 4;
                        const r = imgData[idx], g = imgData[idx + 1], b = imgData[idx + 2];
                        const brightness = (r + g + b) / 3;

                        const inCenterX = x > aw * margin && x < aw * (1 - margin);
                        const inCenterY = y > ah * margin && y < ah * (1 - margin);

                        if (inCenterX && inCenterY) {
                            centerSum += brightness;
                            centerR += r; centerG += g; centerB += b;
                            centerCount++;
                        } else {
                            edgeSum += brightness;
                            edgeCount++;
                        }
                    }
                }

                if (centerCount === 0 || edgeCount === 0) return false;

                const centerBright = centerSum / centerCount;
                const edgeBright = edgeSum / edgeCount;
                const avgR = centerR / centerCount;
                const avgG = centerG / centerCount;
                const avgB = centerB / centerCount;

                // ‚îÄ‚îÄ GATE 1: Center must be reasonably bright (paper is white/cream) ‚îÄ‚îÄ
                // This rejects dark scenes entirely
                if (centerBright < 130) return false;

                // ‚îÄ‚îÄ GATE 2: Center-to-Edge Brightness Ratio ‚îÄ‚îÄ
                // Paper held by hand: center ~180, edge ~90 = ratio 2.0
                // Floor tiles: center ~140, edge ~140 = ratio 1.0
                // We want ratio > 1.2
                const ratio = edgeBright > 0 ? centerBright / edgeBright : 0;
                if (ratio < 1.2) return false;

                // ‚îÄ‚îÄ GATE 3: Skin-tone rejection ‚îÄ‚îÄ
                // Paper center: R - B < 30 (neutral white/gray)
                // Skin center: R - B > 30 (warm tones)
                const warmth = avgR - avgB;
                if (warmth > 30) return false;

                // ‚îÄ‚îÄ GATE 4: Center must have texture (not a blank white wall) ‚îÄ‚îÄ
                // Count how many center pixels deviate significantly from the mean
                let textureCount = 0;
                for (let y = Math.floor(ah * margin); y < Math.floor(ah * (1 - margin)); y++) {
                    for (let x = Math.floor(aw * margin); x < Math.floor(aw * (1 - margin)); x++) {
                        const idx = (y * aw + x) * 4;
                        const brightness = (imgData[idx] + imgData[idx + 1] + imgData[idx + 2]) / 3;
                        if (Math.abs(brightness - centerBright) > 25) textureCount++;
                    }
                }
                const textureRatio = textureCount / centerCount;
                // Paper with ink: ~15-40% pixels deviate. Blank wall: <5%
                if (textureRatio < 0.08) return false;

                // ‚îÄ‚îÄ ALL GATES PASSED: Draw targeting HUD ‚îÄ‚îÄ
                const pad = 0.18; // 18% inset for the targeting box
                const bx = vw * pad, by = vh * pad;
                const bw = vw * (1 - 2 * pad), bh = vh * (1 - 2 * pad);

                // Dashed green rectangle
                hudCtx.strokeStyle = '#10b981';
                hudCtx.lineWidth = 2;
                hudCtx.shadowColor = '#10b981';
                hudCtx.shadowBlur = 10;
                hudCtx.setLineDash([10, 6]);
                hudCtx.strokeRect(bx, by, bw, bh);

                // Solid corner brackets
                hudCtx.setLineDash([]);
                hudCtx.lineWidth = 4;
                const cLen = 25;
                // Top-left
                hudCtx.beginPath(); hudCtx.moveTo(bx, by + cLen); hudCtx.lineTo(bx, by); hudCtx.lineTo(bx + cLen, by); hudCtx.stroke();
                // Top-right
                hudCtx.beginPath(); hudCtx.moveTo(bx + bw - cLen, by); hudCtx.lineTo(bx + bw, by); hudCtx.lineTo(bx + bw, by + cLen); hudCtx.stroke();
                // Bottom-left
                hudCtx.beginPath(); hudCtx.moveTo(bx, by + bh - cLen); hudCtx.lineTo(bx, by + bh); hudCtx.lineTo(bx + cLen, by + bh); hudCtx.stroke();
                // Bottom-right
                hudCtx.beginPath(); hudCtx.moveTo(bx + bw - cLen, by + bh); hudCtx.lineTo(bx + bw, by + bh); hudCtx.lineTo(bx + bw, by + bh - cLen); hudCtx.stroke();

                return true;

            } catch (e) {
                console.error("Scan error:", e);
                return false;
            }
        }

        function autoCaptureLoop() {
            if (!autoCaptureToggle.checked) return;

            const found = scanForDocument();

            if (found) {
                consecutiveDetections++;
                // Show progress: yellow ‚Üí orange ‚Üí green as we approach snap
                const progress = consecutiveDetections / DETECTIONS_TO_SNAP;
                if (progress < 0.5) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-yellow-500 transition-colors shadow-glow';
                } else if (progress < 1) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-orange-500 transition-colors shadow-glow animate-pulse';
                }

                if (consecutiveDetections >= DETECTIONS_TO_SNAP) {
                    // SNAP!
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-emerald-500 transition-colors shadow-glow ring-2 ring-emerald-500/50';
                    captureFrame();
                    consecutiveDetections = 0;

                    // Cooldown: pause scanning to let user swap paper
                    if (scanIntervalId) clearInterval(scanIntervalId);
                    setTimeout(() => {
                        if (autoCaptureToggle.checked) {
                            consecutiveDetections = 0;
                            scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
                        }
                    }, COOLDOWN_AFTER_SNAP_MS);
                    return;
                }
            } else {
                // Reset streak ‚Äî paper left the frame or no document detected
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-blue-500/50 transition-colors shadow-glow';
            }
        }

        autoCaptureToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                consecutiveDetections = 0;
                scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
            } else {
                if (scanIntervalId) clearInterval(scanIntervalId);
                scanIntervalId = null;
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow';
                const hudCanvas = document.getElementById('cv-visualizer');
                if (hudCanvas) {
                    const hudCtx = hudCanvas.getContext('2d');
                    hudCtx.clearRect(0, 0, hudCanvas.width, hudCanvas.height);
                }
            }
        });

        // Switch Camera
        btnSwitchCam.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera();
        });

        // Process Batch (Send to Backend)
        btnProcess.addEventListener('click', async () => {
            if (imagesBatch.length === 0) return;

            // Turn off camera and flashlight to indicate scanning is done
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            const originalHtml = btnProcess.innerHTML;
            btnProcess.disabled = true;
            btnCapture.disabled = true;
            btnProcess.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Grading Scanned Scripts...`;

            // Show new fun loading overlay
            const loadingOverlay = document.getElementById('grading-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('flex');
            }

            try {
                let base64List = imagesBatch.map(item => item.base64);

                // Compress images for faster upload (Workstream 2)
                if (typeof compressBatch === 'function') {
                    try {
                        base64List = await compressBatch(base64List);
                    } catch (e) { console.warn('Compression skipped:', e); }
                }

                const targetClassVal = document.getElementById('target-class').value.trim();
                // Track class in session
                if (typeof addToSessionClasses === 'function' && targetClassVal) {
                    addToSessionClasses(targetClassVal);
                }

                finalAssessmentType = assessmentTypeSelect.value === 'custom'
                    ? (customAssessmentInput.value.trim() || 'Score')
                    : assessmentTypeSelect.value;
                scoreTh.innerText = finalAssessmentType;

                // Fix: Set currentSubjectName from the subject dropdown
                const subjSelect = document.getElementById('subject-name');
                if (subjSelect) {
                    currentSubjectName = subjSelect.value === 'custom'
                        ? (document.getElementById('custom-subject')?.value?.trim() || '')
                        : subjSelect.value;
                }

                captureSection.classList.add('hidden');
                reviewSection.classList.remove('hidden');
                // Hide hero on review page
                const appHero = document.getElementById('app-hero');
                if (appHero) appHero.classList.add('hidden');

                // Initialize empty table and array OR prepare for appending
                const isAppending = extractedData && extractedData.length > 0;

                if (!isAppending) {
                    tbody.innerHTML = '';
                    extractedData = Array.from({ length: base64List.length }, () => ({}));
                } else {
                    // We are appending/merging to an existing roster
                }

                // Check Smart Mode
                const smartSwitchBg = document.getElementById('smart-mode-switch-bg');
                const isSmartMode = smartSwitchBg && smartSwitchBg.classList.contains('bg-indigo-500');
                const smartInstruction = isSmartMode ? document.getElementById('smart-instruction-input').value.trim() : "";

                const response = await fetch('/upload-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: base64List,
                        targetClass: targetClassVal,
                        targetClasses: typeof selectedClasses !== 'undefined' ? selectedClasses : [targetClassVal],
                        smartInstruction: smartInstruction
                    })
                });

                if (!response.ok) {
                    let errStr = "Server error";
                    try {
                        const errData = await response.json();
                        errStr = errData.error || errStr;
                    } catch (e) { }
                    throw new Error(errStr);
                }

                // Hide overlay once connection is established and data stream starts
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }

                // Read SSE Stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        // All chunks received, show "What's Next"
                        const nextBlock = document.getElementById('whats-next-block');
                        if (nextBlock) nextBlock.classList.remove('hidden');
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep the last incomplete chunk in the buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') {
                                const nextBlock = document.getElementById('whats-next-block');
                                if (nextBlock) nextBlock.classList.remove('hidden');
                                continue;
                            }
                            try {
                                const parsed = JSON.parse(dataStr);
                                const idx = parsed.index;
                                const item = parsed.result;

                                if (isAppending) {
                                    // Fuzzy match this scanned 'item' against the existing extractedData array
                                    let bestMatchIdx = -1;
                                    let highestScore = 0;
                                    const scannedName = (item.name || "").toLowerCase();

                                    for (let i = 0; i < extractedData.length; i++) {
                                        const existingName = (extractedData[i].name || "").toLowerCase();
                                        // Simple inclusion fuzzy match for demo
                                        if (existingName && scannedName && (existingName.includes(scannedName) || scannedName.includes(existingName))) {
                                            bestMatchIdx = i;
                                            break;
                                        }
                                    }

                                    if (bestMatchIdx !== -1) {
                                        // Update the score of the existing student
                                        extractedData[bestMatchIdx].score = item.score;
                                        extractedData[bestMatchIdx].confidence = item.confidence; // Optional
                                        // Update the DOM for that specific row
                                        const rowInputs = tbody.querySelectorAll(`input[data-index="${bestMatchIdx}"][data-field="score"]`);
                                        if (rowInputs && rowInputs.length > 0) {
                                            rowInputs[0].value = item.score;
                                            // Add a brief glow effect
                                            rowInputs[0].classList.add('ring-2', 'ring-emerald-500', 'bg-emerald-500/20');
                                            setTimeout(() => {
                                                rowInputs[0].classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-500/20');
                                            }, 1500);
                                        }
                                    } else {
                                        // If no match found, append as a new row at the bottom
                                        const newIdx = extractedData.length;
                                        extractedData.push(item);
                                        renderSingleRow(item, newIdx);
                                    }

                                } else {
                                    extractedData[idx] = item;
                                    renderSingleRow(item, idx);
                                }
                            } catch (e) {
                                console.error("Error parsing SSE data:", e, dataStr);
                            }
                        }
                    }
                }

            } catch (err) {
                console.error("Processing error:", err);
                showToast(`Error processing images: ${err.message}`, 'error');
                btnProcess.innerHTML = originalHtml;
                btnProcess.disabled = false;
                btnCapture.disabled = false;
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                }
                reviewSection.classList.add('hidden');
                captureSection.classList.remove('hidden');
                // Restart camera if it failed to process so they aren't stuck on a black screen
                initCamera();
            }
        });

        function renderSingleRow(item, index) {
            const tr = document.createElement('tr');

            // Confidence-based styling
            const confidence = (item.confidence || 'high').toLowerCase();
            const isLow = confidence === 'low';
            const isMedium = confidence === 'medium';

            let borderClass = 'border-white/5';
            let confidenceBadge = '';
            if (isLow) {
                borderClass = 'border-destructive/40 ring-1 ring-destructive/20';
                confidenceBadge = `<span title="AI is not sure about this one. Please double-check." class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-destructive bg-destructive/10 border border-destructive/20 px-2 py-0.5 rounded-full ml-2 cursor-help"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> Low</span>`;
            } else if (isMedium) {
                borderClass = 'border-yellow-500/30 ring-1 ring-yellow-500/10';
                confidenceBadge = `<span title="AI is fairly sure but the handwriting was tricky." class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-yellow-400 bg-yellow-500/10 border border-yellow-500/20 px-2 py-0.5 rounded-full ml-2 cursor-help"><i class="fa-solid fa-circle-exclamation text-[8px]"></i> Med</span>`;
            }

            const nameStr = item.name || '';
            const classStr = item.class || '';
            const scoreStr = item.score || '';

            // Explicitly highlight missing names
            if (!nameStr || nameStr.trim() === '') {
                borderClass = 'border-red-500 ring-2 ring-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.2)] bg-red-500/5';
                confidenceBadge = `<span class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-white bg-red-500 border border-red-600 px-2 py-0.5 rounded-full ml-2 shadow-glow animate-pulse"><i class="fa-solid fa-circle-exclamation text-[8px]"></i> MISSING NAME</span>`;
            }

            tr.className = `reveal light-beam-card flex flex-col md:table-row bg-background md:bg-transparent rounded-xl md:rounded-none border ${borderClass} md:border-none md:border-b md:border-white/5 transition-colors group overflow-hidden md:hover:bg-white/[0.02] p-4 md:p-0 my-3 md:my-0 shadow-lg md:shadow-none translate-y-4 opacity-0 transition-all duration-500 hidden`;

            const isManual = confidence === 'manual';
            const deleteBtn = isManual ? `<button onclick="deleteManualRow(${index}, this)" class="ml-2 w-7 h-7 flex items-center justify-center rounded-full bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-all text-xs border border-red-500/20" title="Remove row"><i class="fa-solid fa-xmark"></i></button>` : '';

            tr.innerHTML = `
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold flex items-center">Student Name <span class="text-primary ml-1">*</span> ${confidenceBadge}</span><div class="flex items-center w-full"><input type="text" data-index="${index}" data-field="name" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm font-semibold transition-colors outline-none placeholder:text-muted-foreground/30" value="${nameStr}" placeholder="Enter Name"><span class="hidden md:inline-flex">${confidenceBadge}</span>${deleteBtn}</div></td>
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold">Class</span><input type="text" data-index="${index}" data-field="class" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm transition-colors outline-none placeholder:text-muted-foreground/30 font-medium" value="${classStr}" placeholder="Class"></td>
            <td class="flex justify-between items-center md:table-cell px-2 md:px-5 py-4 bg-black/40 md:bg-transparent -mx-4 px-6 md:mx-0 mt-2 md:mt-0 rounded-b-xl md:rounded-none md:border-l md:border-white/5"><span class="md:hidden text-[11px] text-primary uppercase tracking-widest font-extrabold">Final Score</span><input type="text" data-index="${index}" data-field="score" class="w-24 md:w-full md:min-w-[70px] bg-white/[0.04] md:bg-transparent border border-white/10 md:border-none md:border-b md:border-transparent focus:border-primary/50 focus:bg-primary/5 focus:ring-0 md:px-2 py-2 text-primary md:text-foreground text-right font-bold text-lg md:text-sm rounded-lg md:rounded-none transition-colors outline-none placeholder:text-muted-foreground/30 shadow-inner md:shadow-none" value="${scoreStr}" placeholder="Score"></td>
            `;

            // Insert in order
            const rows = Array.from(tbody.children);
            let inserted = false;
            for (let i = 0; i < rows.length; i++) {
                const rowInput = rows[i].querySelector('input[data-index]');
                if (rowInput) {
                    const rowIndex = parseInt(rowInput.getAttribute('data-index'), 10);
                    if (index < rowIndex) {
                        tbody.insertBefore(tr, rows[i]);
                        inserted = true;
                        break;
                    }
                }
            }
            if (!inserted) {
                tbody.appendChild(tr);
            }

            // Bind events
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'), 10);
                    const field = e.target.getAttribute('data-field');
                    extractedData[idx][field] = e.target.value;
                });
            });

            // Animate in progressively
            requestAnimationFrame(() => {
                tr.classList.remove('hidden');
                requestAnimationFrame(() => {
                    tr.classList.remove('translate-y-4', 'opacity-0');
                    tr.classList.add('visible');
                });
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  MANUAL ROW ADDITION (Phase 2: Omitted Score Fix)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function addManualRow() {
            const targetClass = document.getElementById('target-class');
            const classVal = targetClass ? targetClass.value : '';
            const newIdx = extractedData.length;
            const newItem = {
                name: '',
                class: classVal,
                score: '',
                confidence: 'Manual'
            };
            extractedData.push(newItem);
            renderSingleRow(newItem, newIdx);

            // Focus the new name input after render
            requestAnimationFrame(() => {
                const newInput = document.querySelector(`input[data-index="${newIdx}"][data-field="name"]`);
                if (newInput) {
                    newInput.focus();
                    newInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });

            // Show tip on first use
            const tip = document.getElementById('missing-score-tip');
            if (tip) tip.classList.remove('hidden');

            showToast('New row added. Type the student name and score.', 'info', 3000);
        }

        function deleteManualRow(index, btn) {
            if (index >= 0 && index < extractedData.length) {
                extractedData.splice(index, 1);
                const row = btn.closest('tr');
                if (row) {
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(50px)';
                    setTimeout(() => row.remove(), 300);
                }
                // Re-index remaining rows
                setTimeout(() => {
                    const rows = document.querySelectorAll('#results-body tr, #review-section tbody tr');
                    rows.forEach((tr, i) => {
                        tr.querySelectorAll('input[data-index]').forEach(input => {
                            input.setAttribute('data-index', i);
                        });
                        tr.querySelectorAll('button[onclick*="deleteManualRow"]').forEach(btn => {
                            btn.setAttribute('onclick', `deleteManualRow(${i}, this)`);
                        });
                    });
                }, 350);
                showToast('Row removed.', 'info', 2000);
            }
        }

        // Analytics Calculation
        function calculateAnalytics(data) {
            let validScores = [];
            let high = { score: -1, name: '' };
            let low = { score: 999999, name: '' };

            data.forEach(item => {
                const s = parseFloat(item.score);
                if (!isNaN(s)) {
                    validScores.push(s);
                    if (s > high.score) { high.score = s; high.name = item.name || ''; }
                    if (s < low.score) { low.score = s; low.name = item.name || ''; }
                }
            });

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                const avg = (sum / validScores.length).toFixed(1);
                statAvg.innerText = avg;

                statHigh.innerText = high.score;
                statHighName.innerText = high.name;

                statLow.innerText = low.score;
                statLowName.innerText = low.name;

                // Trigger Confetti for Perfect Scores
                const rawHasPerfect = data.some(item => {
                    if (!item.score) return false;
                    const str = String(item.score).trim();
                    return str === '100' || str.startsWith('100/') || str === '10/10' || str === '20/20';
                });

                if (rawHasPerfect && typeof confetti === 'function') {
                    const duration = 2500;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({
                            particleCount: 5,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24'] // brand colors
                        });
                        confetti({
                            particleCount: 5,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24']
                        });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                }

            } else {
                statAvg.innerText = '--';
                statHigh.innerText = '--';
                statHighName.innerText = '--';
                statLow.innerText = '--';
                statLowName.innerText = '--';
            }
        }

        // Export to Excel / Sheets
        btnExport.addEventListener('click', async () => {
            const missingNames = extractedData.filter(item => !item.name || item.name.trim() === '');
            if (missingNames.length > 0) {
                const proceed = confirm(`Wait! You have ${missingNames.length} scanned score(s) missing a student name (highlighted in red). \n\nIf you save now, these scores will be ignored because we don't know whose they are.\n\nDo you want to continue saving anyway?`);
                if (!proceed) return;
            }

            btnExport.disabled = true;
            btnExport.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> SAVING...`;
            exportMsg.classList.add('hidden');

            try {
                const response = await fetch('/export-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        results: extractedData,
                        assessmentType: finalAssessmentType,
                        subjectType: currentSubjectName,
                        subjectMode: typeof currentSubjectMode !== 'undefined' ? currentSubjectMode : 'general',
                        classList: typeof sessionClasses !== 'undefined' ? Array.from(sessionClasses) : []
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Export failed");

                exportMsg.classList.remove('hidden', 'text-destructive');
                exportMsg.classList.add('text-primary');
                exportMsg.innerHTML = `<i class="fa-solid fa-circle-check mr-2"></i> ${data.message}`;

                // Show Analytics Dashboard
                calculateAnalytics(extractedData);
                reviewSection.classList.add('hidden');
                analyticsSection.classList.remove('hidden');

                // Render class-based tabs with level grouping + download links
                if (data.sheets && typeof renderResultsTabs === 'function') {
                    renderResultsTabs(data.sheets, data.downloads || []);
                }

                // Update download button with subject-aware URL
                const downloadBtn = document.getElementById('btn-download-sheet');
                if (downloadBtn && data.downloads && data.downloads.length > 0) {
                    const dl = data.downloads[0];
                    const subj = data.subject || currentSubjectName || '';
                    downloadBtn.onclick = () => window.location.href = dl.url + '&subject=' + encodeURIComponent(subj);
                }

                // Proactive assistant trigger ‚Äî nudge after save
                if (typeof sendAssistantMessage === 'function' && typeof sessionClasses !== 'undefined') {
                    const classesGraded = [...sessionClasses];
                    const subj = data.subject || currentSubjectName || '';
                    const proactiveMsg = `[SYSTEM] Teacher just saved grades for ${classesGraded.join(', ')} in ${subj} (${finalAssessmentType}). ${Object.keys(data.sheets || {}).length} class sheets generated. Proactively suggest what to do next ‚Äî download, grade another class/assessment, or review results. Be warm and brief.`;
                    // Show assistant with the proactive message after a short delay
                    setTimeout(() => {
                        const fab = document.getElementById('smart-assistant-fab');
                        if (fab) {
                            // Pulse the FAB to draw attention
                            fab.classList.add('animate-bounce');
                            setTimeout(() => fab.classList.remove('animate-bounce'), 2000);
                        }
                    }, 1500);
                }

                // Show absent-student banner for general subjects (blank scores, not 0)
                const subMode = typeof currentSubjectMode !== 'undefined' ? currentSubjectMode : 'general';
                if (subMode === 'general' && data.sheets) {
                    let absentNames = [];
                    Object.values(data.sheets).forEach(sheet => {
                        (sheet.rows || []).forEach(row => {
                            if (row['Total Score'] === '' || row['Total Score'] === 0 || row['Total Score'] === '0') {
                                absentNames.push(row['Name'] + ' (' + (sheet.class || '') + ')');
                            }
                        });
                    });
                    if (absentNames.length > 0) {
                        const showCount = 3;
                        const previewNames = absentNames.slice(0, showCount).join(', ');
                        const hasMore = absentNames.length > showCount;
                        const moreCount = absentNames.length - showCount;
                        const allNames = absentNames.join(', ');
                        const toggleId = 'absent-toggle-' + Date.now();

                        const absentBanner = document.createElement('div');
                        absentBanner.className = 'mb-4 p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl animate-fade-in-up';
                        absentBanner.innerHTML = `
                            <div class="flex items-start gap-3">
                                <i class="fa-solid fa-user-clock text-amber-400 text-lg mt-0.5 shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-amber-400 mb-1">${absentNames.length} student(s) had no scanned paper:</p>
                                    <p class="text-xs text-amber-300/70 leading-relaxed">
                                        ${previewNames}${hasMore ? `<span id="${toggleId}-dots">...</span><span id="${toggleId}-full" class="hidden">, ${absentNames.slice(showCount).join(', ')}</span>` : ''}
                                    </p>
                                    ${hasMore ? `<button onclick="document.getElementById('${toggleId}-full').classList.toggle('hidden'); document.getElementById('${toggleId}-dots').classList.toggle('hidden'); this.textContent = this.textContent.includes('Show') ? 'Show less' : 'Show all ${absentNames.length}';" class="text-[10px] text-amber-400 font-bold mt-1.5 hover:underline">Show all ${absentNames.length}</button>` : ''}
                                    <p class="text-[10px] text-amber-300/50 mt-2">They may have been absent. Their names appear in Excel with a blank score.</p>
                                </div>
                                <button onclick="this.closest('.mb-4').remove()" class="text-amber-500/40 hover:text-amber-400 transition-colors shrink-0"><i class="fa-solid fa-xmark text-sm"></i></button>
                            </div>
                        `;
                        const analyticsEl = document.getElementById('analytics-section');
                        if (analyticsEl) analyticsEl.prepend(absentBanner);
                    }
                }

            } catch (err) {
                console.error("Export error:", err);
                exportMsg.classList.remove('hidden', 'text-primary');
                exportMsg.classList.add('text-destructive');
                // Try AI-powered error explanation
                if (typeof handleErrorWithAI === 'function') {
                    handleErrorWithAI(err, 'saving grades');
                }
                exportMsg.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> Error: ${err.message}`;
            } finally {
                btnExport.disabled = false;
                btnExport.innerHTML = `<i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Save Grades`;
            }
        });

        // Start Next Batch ‚Äî with camera reset
        btnNewBatch.addEventListener('click', () => {
            imagesBatch = [];
            extractedData = [];
            batchCountEl.innerText = '0';
            thumbnailsContainer.innerHTML = '';
            exportMsg.classList.add('hidden');

            const nextBlock = document.getElementById('whats-next-block');
            if (nextBlock) nextBlock.classList.add('hidden');

            updateActionBar(); // Hide sticky bottom bar
            btnCapture.disabled = false;

            analyticsSection.classList.add('hidden');
            reviewSection.classList.add('hidden');
            captureSection.classList.remove('hidden');

            // Fix: Kill and reinitialize camera to avoid glitchy stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            initCamera();

            if (autoCaptureToggle.checked) {
                stillTimeStart = null;
                previousFrameData = null;
                detectMotion();
            }
        });

        // Reset Flow
        btnReset.addEventListener('click', () => {
            if (confirm("Are you sure? This will discard the current batch.")) {
                imagesBatch = [];
                extractedData = [];
                batchCountEl.innerText = '0';
                thumbnailsContainer.innerHTML = '';

                updateActionBar(); // Hide sticky bottom bar

                btnCapture.disabled = false;

                reviewSection.classList.remove('visible');
                setTimeout(() => {
                    reviewSection.classList.add('hidden');
                    captureSection.classList.remove('hidden');
                    setTimeout(() => {
                        captureSection.classList.add('visible');
                    }, 50);
                }, 300);

                exportMsg.classList.add('hidden');
            }
        });

        window.addEventListener('load', () => {
            fetchClasses();
            loadRecentSessions();
            initMagneticButtons();
            initTouchRipples();
            initScrollProgress();
        });

        // 21st.dev Premium Animations

        function triggerRevealObserver() {
            // Initially hide elements so they can be revealed
            document.querySelectorAll('.reveal').forEach(el => {
                if (!el.classList.contains('visible')) {
                    el.classList.add('reveal-initial');
                }
            });

            const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('reveal-initial');
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
            setTimeout(() => {
                document.querySelectorAll('.reveal:not(.hidden)').forEach(el => {
                    el.classList.remove('reveal-initial');
                    el.classList.add('visible');
                });
            }, 100);
        }

        function initMagneticButtons() {
            const magnetics = document.querySelectorAll('.magnetic');
            magnetics.forEach(btn => {
                btn.addEventListener('mousemove', (e) => {
                    if (window.innerWidth < 768) return;
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const xc = rect.width / 2;
                    const yc = rect.height / 2;
                    const dx = x - xc;
                    const dy = y - yc;
                    const maxTranslate = 15;
                    const tx = (dx / xc) * maxTranslate;
                    const ty = (dy / yc) * maxTranslate;
                    btn.style.transform = `translate(${tx}px, ${ty}px) scale(1.02)`;
                });

                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translate(0px, 0px) scale(1)';
                });

                btn.addEventListener('mousedown', () => {
                    const span = btn.querySelector('span.absolute');
                    if (span) {
                        span.style.transform = 'scale(1)';
                        span.style.opacity = '1';
                        setTimeout(() => {
                            span.style.transform = 'scale(0)';
                            span.style.opacity = '0';
                        }, 500);
                    }
                });
            });
        }

        function initTouchRipples() {
            const buttons = document.querySelectorAll('button:not(#btn-capture)');
            buttons.forEach(btn => {
                btn.style.position = 'relative';
                btn.style.overflow = 'hidden';

                const createRipple = (e) => {
                    const circle = document.createElement('span');
                    const diameter = Math.max(btn.clientWidth, btn.clientHeight);
                    const radius = diameter / 2;

                    let clientX, clientY;
                    if (e.touches && e.touches.length > 0) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    const rect = btn.getBoundingClientRect();

                    circle.style.width = circle.style.height = `${diameter}px`;
                    circle.style.left = `${clientX - rect.left - radius}px`;
                    circle.style.top = `${clientY - rect.top - radius}px`;
                    circle.classList.add('ripple');

                    const ripple = btn.querySelector('.ripple');
                    if (ripple) ripple.remove();

                    btn.appendChild(circle);
                };

                btn.addEventListener('mousedown', createRipple);
                btn.addEventListener('touchstart', createRipple, { passive: true });
            });
        }

        // Roster Management Event Listeners
        const rosterUpload = document.getElementById('roster-upload');
        const btnClearRoster = document.getElementById('btn-clear-roster');

        // Paste Modal Elements
        const btnOpenPaste = document.getElementById('btn-open-paste-modal');
        const pasteModal = document.getElementById('paste-modal');
        const btnClosePaste = document.getElementById('btn-close-paste');
        const btnSubmitPaste = document.getElementById('btn-submit-paste');
        const pasteTargetClass = document.getElementById('paste-target-class');
        const pasteRawText = document.getElementById('paste-raw-text');

        // Enrollment logic handled at the bottom of the file where loadSelectiveStudents is defined.
        if (btnOpenPaste && pasteModal) {
            btnOpenPaste.addEventListener('click', () => {
                // By default, start with an empty class name so the user can type a new one
                pasteTargetClass.value = '';

                pasteModal.classList.remove('hidden');
                pasteModal.classList.add('flex');

                // Animate in
                setTimeout(() => {
                    pasteModal.classList.remove('opacity-0');
                    pasteModal.querySelector('div').classList.remove('scale-95');
                    pasteModal.querySelector('div').classList.add('scale-100');

                    // Show helpful instruction
                    setTimeout(() => {
                        showToast('Tip: For 100% handwriting accuracy, please provide the COMPLETE comprehensive student list for this class.', 'info', 6000);
                    }, 500);
                }, 10);

                pasteRawText.focus();
            });

            const closePasteModal = () => {
                pasteModal.classList.add('opacity-0');
                pasteModal.querySelector('div').classList.add('scale-95');
                pasteModal.querySelector('div').classList.remove('scale-100');
                setTimeout(() => {
                    pasteModal.classList.add('hidden');
                    pasteModal.classList.remove('flex');
                }, 300);
            };

            btnClosePaste.addEventListener('click', closePasteModal);
            pasteModal.addEventListener('click', (e) => {
                if (e.target === pasteModal) closePasteModal();
            });

            btnSubmitPaste.addEventListener('click', async () => {
                const targetClass = pasteTargetClass.value.trim();
                const rawText = pasteRawText.value.trim();

                if (!targetClass) {
                    showToast('Please enter a Target Class.', 'warning');
                    pasteTargetClass.focus();
                    return;
                }

                // Smart validation: Enforce section letters, e.g., "SS1" is bad, "SS1 A" is good.
                // It should have at least one letter and one number, and more than 3 characters usually,
                // or just explicitly check if it ends with a number.
                const hasLetters = /[a-zA-Z]/.test(targetClass);
                const hasNumbers = /[0-9]/.test(targetClass);

                if (hasLetters && hasNumbers) {
                    // If it ends with a number, usually it's missing a section, e.g., "SS 1"
                    if (/\d$/.test(targetClass)) {
                        showToast('Please specify the class section (e.g. use "SS1 A" or "JSS3 B" instead of just "SS1")', 'warning', 6000);
                        pasteTargetClass.focus();
                        return;
                    }
                }

                if (!rawText) {
                    showToast('Please paste the complete list of student names.', 'warning');
                    pasteRawText.focus();
                    return;
                }

                const originalBtnText = btnSubmitPaste.innerHTML;
                btnSubmitPaste.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Processing...';

                try {
                    const response = await fetch('/api/classes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: targetClass, names_text: rawText })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showToast(`${result.message}`, 'success');

                        // Keep old dropdown UI in sync (if it exists)
                        if (targetClassSelect) {
                            let exists = false;
                            for (let i = 0; i < targetClassSelect.options.length; i++) {
                                if (targetClassSelect.options[i].text === targetClass) {
                                    exists = true;
                                    targetClassSelect.selectedIndex = i;
                                    break;
                                }
                            }
                            if (!exists) {
                                const newOption = new Option(targetClass, targetClass, false, true);
                                newOption.className = "bg-card";
                                targetClassSelect.add(newOption);
                            }
                            targetClassSelect.dispatchEvent(new Event('change'));
                        }

                        // Always sync the multi-select chip picker (even if targetClassSelect is missing)
                        if (typeof window.selectedClasses !== 'undefined') {
                            if (!window.selectedClasses.includes(targetClass)) {
                                window.selectedClasses.push(targetClass);
                            }
                            if (typeof window.addToSessionClasses === 'function') {
                                window.addToSessionClasses(targetClass);
                            }
                        }
                        // Refresh the class chip picker to show the new/updated class
                        if (typeof window.initClassPicker === 'function') {
                            window.initClassPicker();
                        }

                        // Clear textarea
                        pasteRawText.value = '';
                        closePasteModal();
                    } else {
                        showToast(`Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error pasting roster:', error);
                    showToast('An error occurred: ' + (error.message || 'Please try again.'), 'error');
                } finally {
                    btnSubmitPaste.innerHTML = originalBtnText;
                }
            });
        }

        if (rosterUpload) {
            rosterUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload-sheet', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showToast(`${result.message}`, 'success');
                        // Auto-fill target class if it was a text file
                        if (file.name.toLowerCase().endsWith('.txt') || file.name.toLowerCase().endsWith('.md')) {
                            let baseName = file.name.replace(/\.[^/.]+$/, "");
                            let clean = baseName.toUpperCase().replace(/[^A-Z0-9]/g, '');
                            let match = clean.match(/([A-Z]+)(\d+.*)/);
                            if (match && document.getElementById('target-class')) {
                                document.getElementById('target-class').value = `${match[1]} ${match[2]}`;
                            }
                        }
                    } else {
                        showToast(`Error: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error uploading roster:', error);
                    showToast('An error occurred while uploading.', 'error');
                }

                // Reset file input so the same file can be uploaded again if needed
                e.target.value = '';
            });
        }

        // ------ Added UI Hooks & Processing Logic ------
        if (subjectNameSelect && customSubjectWrapper) {
            subjectNameSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customSubjectWrapper.classList.remove('hidden');
                    customSubjectInput.focus();
                } else {
                    customSubjectWrapper.classList.add('hidden');
                }
            });
        }

        if (assessmentTypeSelect && customAssessmentWrapper) {
            assessmentTypeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customAssessmentWrapper.classList.remove('hidden');
                    customAssessmentInput.focus();
                } else {
                    customAssessmentWrapper.classList.add('hidden');
                }

                // Show subject type section once assessment is selected
                if (e.target.value) {
                    const subjectTypeSection = document.getElementById('subject-type-section');
                    if (subjectTypeSection) {
                        subjectTypeSection.classList.remove('hidden');
                    }
                }
            });
        }

        async function fetchClasses() {
            try {
                const response = await fetch('/api/classes');
                if (response.ok) {
                    const classes = await response.json();
                    if (targetClassSelect) {
                        targetClassSelect.innerHTML = '<option value="" disabled selected class="bg-card">-- Select a Class --</option>';
                        classes.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.name;
                            opt.textContent = c.name;
                            opt.className = 'bg-card text-white font-medium';
                            targetClassSelect.appendChild(opt);
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching classes:', error);
            }
        }

        // (Duplicate window.load and btnStartCamera removed ‚Äî handled earlier)

        const btnSubjectGeneral = document.getElementById('btn-subject-general');
        const btnSubjectElective = document.getElementById('btn-subject-elective');
        const btnToggleSmartMode = document.getElementById('btn-toggle-smart-mode');
        const smartSwitchBg = document.getElementById('smart-mode-switch-bg');
        const smartSwitchKnob = document.getElementById('smart-mode-switch-knob');
        const smartInstructionWrapper = document.getElementById('smart-instruction-wrapper');
        // Subject Type Toggle: General / Elective
        let currentSubjectMode = 'general'; // Default to general
        if (btnSubjectGeneral && btnSubjectElective) {
            btnSubjectGeneral.addEventListener('click', () => {
                currentSubjectMode = 'general';
                btnSubjectGeneral.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 border-r border-white/10 text-white bg-primary/20 shadow-[0_0_10px_rgba(16,185,129,0.2)]";
                btnSubjectElective.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 text-muted-foreground hover:text-white";
                document.getElementById('subject-type-desc').innerHTML = '<i class="fa-solid fa-circle-info mr-1 text-primary/50"></i>Every student in the class takes this subject. We\'ll let you know if anyone is missing after grading.';
            });
            btnSubjectElective.addEventListener('click', () => {
                currentSubjectMode = 'elective';
                btnSubjectElective.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 text-yellow-500 bg-yellow-500/20 shadow-[0_0_10px_rgba(234,179,8,0.2)]";
                btnSubjectGeneral.className = "flex-1 py-3 px-4 text-xs font-bold transition-all flex items-center justify-center gap-2 border-r border-white/10 text-muted-foreground hover:text-white";
                document.getElementById('subject-type-desc').innerHTML = '<i class="fa-solid fa-circle-info mr-1 text-yellow-400/50"></i>Not everyone takes this ‚Äî only scanned students will appear in results. Use <strong>Smart Mode</strong> if someone\'s name is missing.';
            });
        }

        if (btnToggleSmartMode && smartSwitchBg && smartSwitchKnob && smartInstructionWrapper) {
            btnToggleSmartMode.addEventListener('click', () => {
                const isSmartOn = smartSwitchBg.classList.contains('bg-indigo-500');
                if (isSmartOn) {
                    // Turn off
                    smartSwitchBg.className = 'w-10 h-5 bg-black/50 rounded-full relative shadow-inner border border-white/10 transition-colors';
                    smartSwitchKnob.className = 'w-3 h-3 bg-muted-foreground rounded-full absolute top-1 left-1 transition-all';
                    smartInstructionWrapper.classList.add('hidden');
                } else {
                    // Turn on
                    smartSwitchBg.className = 'w-10 h-5 bg-indigo-500 rounded-full relative shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-colors border border-indigo-400';
                    smartSwitchKnob.className = 'w-3 h-3 bg-white rounded-full absolute top-1 left-6 shadow-md transition-all';
                    smartInstructionWrapper.classList.remove('hidden');
                    document.getElementById('smart-instruction-input').focus();
                }
            });
        }


        const btnCloseScoresheetModal = document.getElementById('btn-close-scoresheet-modal');
        if (btnCloseScoresheetModal) {
            btnCloseScoresheetModal.addEventListener('click', () => {
                const uModal = document.getElementById('upload-scoresheet-modal');
                if (uModal) {
                    uModal.classList.remove('flex');
                    uModal.classList.add('hidden');
                }
            });
        }

        const btnSubmitScoresheet = document.getElementById('btn-submit-scoresheet');
        const scoresheetFile = document.getElementById('scoresheet-file');
        const scoresheetMsg = document.getElementById('scoresheet-msg');

        if (btnSubmitScoresheet) {
            btnSubmitScoresheet.addEventListener('click', async () => {
                if (!scoresheetFile || !scoresheetFile.files || scoresheetFile.files.length === 0) {
                    if (scoresheetMsg) {
                        scoresheetMsg.textContent = "Please select an image file first.";
                        scoresheetMsg.className = "text-xs text-center font-bold mt-4 tracking-wide w-full max-w-full truncate px-2 text-yellow-400";
                    }
                    return;
                }

                const file = scoresheetFile.files[0];
                const targetClass = document.getElementById('target-class').value;

                if (!targetClass) {
                    showToast("Please select a target class before uploading.", "warning");
                    return;
                }

                // UI Loading State
                const originalHtml = btnSubmitScoresheet.innerHTML;
                btnSubmitScoresheet.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing Image...`;
                btnSubmitScoresheet.disabled = true;

                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(file);
                    });

                    const response = await fetch('/upload-scoresheet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: base64Data,
                            targetClass: targetClass
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || "Upload failed");
                    }

                    // Success
                    showToast(`Successfully extracted ${result.records ? result.records.length : 0} student records.`, "success");

                    // Add records to extractedData state for review
                    result.records.forEach(r => {
                        // Formatting the data to match the expected structure
                        if (r.scores) {
                            // If multiple assessments were found, we might want to just grab the first one for the standard flow,
                            // or ideally map them if the UI supports it. Let's map the first score found to the default.
                            const subjectKeys = Object.keys(r.scores);
                            let primaryScore = "";
                            if (subjectKeys.length > 0) {
                                primaryScore = r.scores[subjectKeys[0]];
                            }
                            extractedData.push({
                                name: r.name || "Name not recognized",
                                class: targetClass,
                                score: primaryScore || "0",
                                confidence: r.confidence || "High",
                                // keep raw scores attached for advanced saving
                                _rawScores: r.scores
                            });
                        } else {
                            extractedData.push({
                                name: r.name || "Name not recognized",
                                class: targetClass,
                                score: r.score || "0",
                                confidence: r.confidence || "High"
                            });
                        }
                    });

                    // Update UI analytics
                    if (typeof updateAnalytics === 'function') {
                        updateAnalytics();
                    }

                    // Close modal
                    const uModal = document.getElementById('upload-scoresheet-modal');
                    if (uModal) {
                        uModal.classList.remove('flex');
                        uModal.classList.add('hidden');
                    }

                    // Show Review UI
                    document.getElementById('landing-section').classList.add('hidden');
                    document.getElementById('capture-section').classList.remove('hidden');
                    openReviewModal(extractedData.length - 1); // Open the last item to review

                } catch (err) {
                    console.error("Upload scoresheet error:", err);
                    showToast(err.message || "Failed to process score list.", "error");
                } finally {
                    btnSubmitScoresheet.innerHTML = originalHtml;
                    btnSubmitScoresheet.disabled = false;
                }
            });
        }

        const btnSubmitXlsx = document.getElementById('btn-submit-xlsx');
        if (btnSubmitXlsx) {
            btnSubmitXlsx.addEventListener('click', async () => {
                const xlsxFile = document.getElementById('xlsx-file');
                if (!xlsxFile || !xlsxFile.files || xlsxFile.files.length === 0) {
                    showToast("Please select an Excel or CSV file first.", "warning");
                    return;
                }

                // UI Loading State
                const originalHtml = btnSubmitXlsx.innerHTML;
                btnSubmitXlsx.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Parsing...`;
                btnSubmitXlsx.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('file', xlsxFile.files[0]);

                    const response = await fetch('/api/upload-excel-scorelist', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || "Excel upload failed");
                    }

                    // Success
                    showToast(`Successfully extracted ${result.records ? result.records.length : 0} student records.`, "success");

                    // Set target class drop-down if detected
                    if (result.detected_class) {
                        const tcDropdown = document.getElementById('target-class');
                        if (tcDropdown) {
                            // try to select it if it exists
                            let optionExists = Array.from(tcDropdown.options).some(opt => opt.value === result.detected_class);
                            if (optionExists) {
                                tcDropdown.value = result.detected_class;
                            } else {
                                // Add and select it temporarily
                                const newOpt = new Option(result.detected_class, result.detected_class);
                                tcDropdown.add(newOpt);
                                tcDropdown.value = result.detected_class;
                            }
                        }
                    }

                    // Map result to the review table exactly like the camera scans do
                    result.records.forEach(r => {
                        let primaryScore = "0";
                        if (r.scores) {
                            const subjectKeys = Object.keys(r.scores);
                            if (subjectKeys.length > 0) primaryScore = r.scores[subjectKeys[0]];
                        }

                        extractedData.push({
                            name: r.name || "Name not recognized",
                            class: r.class || result.detected_class || "Unknown",
                            score: primaryScore || "0",
                            confidence: "Verified", // Came from typed excel so it's 100%
                            _rawScores: r.scores
                        });
                    });

                    // Update UI analytics
                    if (typeof updateAnalytics === 'function') {
                        updateAnalytics();
                    }

                    // Close modal
                    const xModal = document.getElementById('upload-xlsx-modal');
                    if (xModal) {
                        xModal.classList.remove('flex');
                        xModal.classList.add('opacity-0');
                        setTimeout(() => xModal.classList.add('hidden'), 300);
                    }

                    // Show Review UI
                    document.getElementById('landing-section').classList.add('hidden');
                    document.getElementById('capture-section').classList.remove('hidden');
                    openReviewModal(extractedData.length - 1 || 0);

                } catch (err) {
                    console.error("Excel upload error:", err);
                    showToast(err.message || "Failed to parse Excel list.", "error");
                } finally {
                    btnSubmitXlsx.innerHTML = originalHtml;
                    btnSubmitXlsx.disabled = false;
                }
            });
        }

        function initScrollProgress() {
            const progressBar = document.getElementById('scroll-progress');
            if (!progressBar) return;

            window.addEventListener('scroll', () => {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                if (height <= 0) return;
                const scrolled = (winScroll / height) * 100;
                progressBar.style.width = scrolled + '%';
            }, { passive: true });
        }

        function showWhatsNext(context) {
            const nextBlock = document.getElementById('whats-next-block');
            const msgEl = document.getElementById('whats-next-message');
            const actionsEl = document.getElementById('whats-next-actions');

            if (!nextBlock || !msgEl || !actionsEl) return;

            actionsEl.innerHTML = ''; // clear

            if (context === 'scanned_papers') {
                msgEl.innerText = "Scores from the physical test papers have been matched and appended to your roster.";
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('btn-new-batch').click()"
                        class="bg-black/40 hover:bg-primary/20 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner hover:border-primary/50 text-left h-full">
                        <i class="fa-solid fa-camera text-primary group-hover:scale-110 transition-transform text-lg"></i>
                        <span>Scan more scripts</span>
                    </button>
                    <button onclick="window.location.reload()"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner h-full text-left">
                        <i class="fa-solid fa-house-chimney text-emerald-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>Done grading. Return Home</span>
                    </button>
                `;
            } else if (context === 'excel_upload') {
                msgEl.innerHTML = `Welcome back. I see students from your previous session.<br/><span class="text-white">Are we grading their next test?</span>`;
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('start-section').classList.add('hidden'); document.getElementById('review-section').classList.add('hidden'); document.getElementById('capture-section').classList.remove('hidden'); var hero=document.getElementById('app-hero'); if(hero)hero.classList.add('hidden'); if(typeof initCamera === 'function') initCamera();"
                        class="bg-primary/20 hover:bg-primary/40 p-4 rounded-xl border border-primary/30 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-glow text-white text-left h-full">
                        <i class="fa-solid fa-camera-retro text-primary group-hover:-translate-y-1 transition-transform text-xl block"></i>
                        <span>Yes, let's scan their new papers!</span>
                    </button>
                    <button onclick="document.getElementById('review-section').querySelector('.table').scrollIntoView({behavior: 'smooth'})"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner text-left h-full">
                        <i class="fa-solid fa-pen-to-square text-indigo-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>No, I just want to edit some grades.</span>
                    </button>
                `;
            } else if (context === 'photo_scorelist') {
                msgEl.innerHTML = `Great! I've extracted the handwritten scores.`;
                actionsEl.innerHTML = `
                    <button onclick="document.getElementById('btn-export').click()"
                        class="bg-emerald-500 hover:bg-emerald-400 text-black p-4 rounded-xl border border-emerald-400 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-glow text-left h-full">
                        <i class="fa-solid fa-file-excel group-hover:-translate-y-1 transition-transform text-xl block"></i>
                        <span>Awesome. Compile to Results Summary!</span>
                    </button>
                    <button onclick="document.getElementById('upload-scoresheet-modal').classList.remove('hidden'); document.getElementById('upload-scoresheet-modal').classList.add('flex'); setTimeout(() => document.getElementById('upload-scoresheet-modal').classList.remove('opacity-0'), 10);"
                        class="bg-black/40 hover:bg-white/10 text-white p-4 rounded-xl border border-white/10 transition-all flex items-center justify-center gap-3 text-sm font-bold tracking-wide group shadow-inner text-left h-full">
                        <i class="fa-solid fa-file-invoice text-indigo-400 group-hover:scale-110 transition-transform text-lg"></i>
                        <span>I have another score list page</span>
                    </button>
                `;
            }

            nextBlock.classList.remove('hidden');
        }


        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  PHASE 3: 3D PREMIUM ANIMATION ENGINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // ‚îÄ‚îÄ 3.1 THREE.JS FLOATING BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        (function initThreeBackground() {
            const canvas = document.getElementById('three-bg');
            if (!canvas || typeof THREE === 'undefined') {
                // Retry after Three.js loads (deferred)
                if (!canvas) return;
                window.addEventListener('load', initThreeBackground);
                return;
            }
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;

            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            renderer.setClearColor(0x000000, 0);

            // Lighting
            const ambient = new THREE.AmbientLight(0x334466, 0.6);
            scene.add(ambient);
            const pointLight = new THREE.PointLight(0x2196F3, 1.2, 100);
            pointLight.position.set(10, 15, 20);
            scene.add(pointLight);
            const pointLight2 = new THREE.PointLight(0x10b981, 0.6, 80);
            pointLight2.position.set(-15, -10, 15);
            scene.add(pointLight2);

            // School-themed 3D objects
            const objects = [];
            const brandColor = 0x2196F3;
            const accentColors = [0x10b981, 0x8b5cf6, 0xf59e0b, 0xef4444, 0x06b6d4];

            const geometries = [
                new THREE.BoxGeometry(1, 1.4, 0.15),     // Book
                new THREE.ConeGeometry(0.15, 2, 8),       // Pencil
                new THREE.OctahedronGeometry(0.6),         // Star/gem
                new THREE.TorusGeometry(0.5, 0.15, 8, 16), // Ring
                new THREE.TetrahedronGeometry(0.7),         // Math symbol
                new THREE.DodecahedronGeometry(0.5),        // Complex shape
                new THREE.BoxGeometry(0.8, 0.8, 0.8),      // Cube (dice)
                new THREE.SphereGeometry(0.4, 8, 8),        // Ball
            ];

            const NUM_OBJECTS = 18;
            for (let i = 0; i < NUM_OBJECTS; i++) {
                const geo = geometries[i % geometries.length];
                const color = i % 3 === 0 ? brandColor : accentColors[i % accentColors.length];
                const mat = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.15,
                    transparent: true,
                    opacity: 0.07 + Math.random() * 0.07,
                    shininess: 80,
                    wireframe: Math.random() > 0.6
                });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 35,
                    (Math.random() - 0.5) * 20 - 5
                );
                mesh.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                mesh.userData = {
                    rotSpeed: { x: (Math.random() - 0.5) * 0.008, y: (Math.random() - 0.5) * 0.008, z: (Math.random() - 0.5) * 0.005 },
                    floatSpeed: 0.3 + Math.random() * 0.5,
                    floatAmp: 0.5 + Math.random() * 1.5,
                    baseY: mesh.position.y,
                    phase: Math.random() * Math.PI * 2
                };
                scene.add(mesh);
                objects.push(mesh);
            }

            let animId;
            let isVisible = true;

            function animate() {
                if (!isVisible) return;
                animId = requestAnimationFrame(animate);
                const t = Date.now() * 0.001;

                objects.forEach(obj => {
                    obj.rotation.x += obj.userData.rotSpeed.x;
                    obj.rotation.y += obj.userData.rotSpeed.y;
                    obj.rotation.z += obj.userData.rotSpeed.z;
                    obj.position.y = obj.userData.baseY + Math.sin(t * obj.userData.floatSpeed + obj.userData.phase) * obj.userData.floatAmp;
                });

                renderer.render(scene, camera);
            }

            animate();

            // Pause when tab hidden
            document.addEventListener('visibilitychange', () => {
                isVisible = !document.hidden;
                if (isVisible) animate();
            });

            // Resize handler
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        })();

        // Retry Three.js init after load
        window.addEventListener('load', () => {
            if (typeof THREE !== 'undefined' && !document.getElementById('three-bg').__threeInit) {
                document.getElementById('three-bg').__threeInit = true;
                // Already initialized in IIFE above
            }
        });

        // ‚îÄ‚îÄ 3.2 CSS 3D CARD TILT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initCardTilt() {
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                const inner = card.querySelector('.tilt-card-inner') || card;
                let rafId = null;

                card.addEventListener('mousemove', (e) => {
                    if (window.innerWidth < 768) return;
                    if (rafId) return; // Throttle to rAF
                    rafId = requestAnimationFrame(() => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        const cx = rect.width / 2;
                        const cy = rect.height / 2;
                        const rotateX = ((y - cy) / cy) * -8;
                        const rotateY = ((x - cx) / cx) * 8;

                        inner.style.transform = `perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;

                        // Move glow
                        const glowX = (x / rect.width) * 100;
                        const glowY = (y / rect.height) * 100;
                        inner.style.setProperty('--glow-x', glowX + '%');
                        inner.style.setProperty('--glow-y', glowY + '%');

                        rafId = null;
                    });
                });

                card.addEventListener('mouseleave', () => {
                    inner.style.transform = 'perspective(800px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)';
                });
            });
        }

        // ‚îÄ‚îÄ 3.3 ANIMATED STAT COUNTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function animateCounter(element, endValue, duration = 1500) {
            const startTime = performance.now();
            const startValue = 0;

            function easeOutExpo(t) {
                return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
            }

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutExpo(progress);
                const current = startValue + (endValue - startValue) * easedProgress;

                if (Number.isInteger(endValue)) {
                    element.textContent = Math.round(current);
                } else {
                    element.textContent = current.toFixed(1);
                }

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.classList.add('stat-counted');
                    setTimeout(() => element.classList.remove('stat-counted'), 400);
                }
            }

            requestAnimationFrame(update);
        }

        // Override the original calculateAnalytics to add counter animation
        const _origCalculateAnalytics = typeof calculateAnalytics === 'function' ? calculateAnalytics : null;

        function calculateAnalyticsAnimated(data) {
            let validScores = [];
            let high = { score: -1, name: '' };
            let low = { score: 999999, name: '' };

            data.forEach(item => {
                const s = parseFloat(item.score);
                if (!isNaN(s)) {
                    validScores.push(s);
                    if (s > high.score) { high.score = s; high.name = item.name || ''; }
                    if (s < low.score) { low.score = s; low.name = item.name || ''; }
                }
            });

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                const avg = parseFloat((sum / validScores.length).toFixed(1));

                // Animate counters
                animateCounter(statAvg, avg);
                animateCounter(statHigh, high.score);
                animateCounter(statLow, low.score);

                statHighName.innerText = high.name;
                statLowName.innerText = low.name;

                // Confetti
                const rawHasPerfect = data.some(item => {
                    if (!item.score) return false;
                    const str = String(item.score).trim();
                    return str === '100' || str.startsWith('100/') || str === '10/10' || str === '20/20';
                });

                if (rawHasPerfect && typeof confetti === 'function') {
                    const duration = 2500;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#3b82f6', '#10b981', '#fbbf24'] });
                        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#3b82f6', '#10b981', '#fbbf24'] });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                }
            } else {
                statAvg.innerText = '--';
                statHigh.innerText = '--';
                statHighName.innerText = '--';
                statLow.innerText = '--';
                statLowName.innerText = '--';
            }
        }

        // Monkey-patch the calculateAnalytics calls
        window.calculateAnalytics = calculateAnalyticsAnimated;

        // ‚îÄ‚îÄ 3.8 PARTICLE SPARKLE ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const particleCanvas = document.getElementById('particle-canvas');
        const pCtx = particleCanvas ? particleCanvas.getContext('2d') : null;
        let particles = [];
        let particleAnimId = null;

        function resizeParticleCanvas() {
            if (!particleCanvas) return;
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
        }
        resizeParticleCanvas();
        window.addEventListener('resize', resizeParticleCanvas);

        function spawnParticles(x, y, count = 15, color = '33, 150, 243') {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count + (Math.random() - 0.5) * 0.5;
                const speed = 2 + Math.random() * 4;
                particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 1,
                    life: 1,
                    decay: 0.015 + Math.random() * 0.02,
                    size: 2 + Math.random() * 3,
                    color: color
                });
            }
            if (!particleAnimId) animateParticles();
        }

        function animateParticles() {
            if (!pCtx || particles.length === 0) {
                particleAnimId = null;
                if (pCtx) pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                return;
            }
            particleAnimId = requestAnimationFrame(animateParticles);
            pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.08; // gravity
                p.life -= p.decay;
                if (p.life <= 0) return false;

                pCtx.beginPath();
                pCtx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
                pCtx.fillStyle = `rgba(${p.color}, ${p.life})`;
                pCtx.shadowBlur = 8;
                pCtx.shadowColor = `rgba(${p.color}, ${p.life * 0.6})`;
                pCtx.fill();
                return true;
            });

            if (particles.length === 0) {
                pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                particleAnimId = null;
            }
        }

        // Attach sparkle to primary buttons
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#btn-export, #btn-process, #btn-download-sheet, #btn-capture, #btn-submit-paste');
            if (btn) {
                const rect = btn.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                const colors = ['33, 150, 243', '16, 185, 129', '139, 92, 246', '251, 191, 36'];
                spawnParticles(x, y, 15, colors[Math.floor(Math.random() * colors.length)]);
            }
        });

        // ‚îÄ‚îÄ 3.9 STEP PROGRESS INDICATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateStepIndicator(activeStep) {
            const steps = ['start', 'capture', 'review', 'results'];
            const activeIdx = steps.indexOf(activeStep);
            if (activeIdx === -1) return;

            document.querySelectorAll('.step-dot').forEach((dot, i) => {
                dot.classList.remove('step-active', 'step-done');
                if (i < activeIdx) dot.classList.add('step-done');
                else if (i === activeIdx) dot.classList.add('step-active');
            });

            document.querySelectorAll('.step-line-fill').forEach((fill, i) => {
                fill.style.width = i < activeIdx ? '100%' : '0%';
            });
        }

        // Hook into section visibility to update step indicator
        const _origStartCameraClick = btnStartCamera ? btnStartCamera.onclick : null;
        const _setupObs = new MutationObserver(() => {
            if (captureSection && !captureSection.classList.contains('hidden')) {
                updateStepIndicator('capture');
            }
            if (reviewSection && !reviewSection.classList.contains('hidden')) {
                updateStepIndicator('review');
            }
            if (analyticsSection && !analyticsSection.classList.contains('hidden')) {
                updateStepIndicator('results');
            }
            if (startSection && !startSection.classList.contains('hidden') &&
                captureSection && captureSection.classList.contains('hidden')) {
                updateStepIndicator('start');
            }
        });

        [captureSection, reviewSection, analyticsSection, startSection].forEach(el => {
            if (el) _setupObs.observe(el, { attributes: true, attributeFilter: ['class'] });
        });

        // ‚îÄ‚îÄ 3.7 3D MODAL ANIMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function open3DModal(modalEl) {
            if (!modalEl) return;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex', 'modal-3d-container');
            const inner = modalEl.querySelector('div > div') || modalEl.firstElementChild;
            if (inner) {
                inner.classList.add('modal-3d-flip');
                requestAnimationFrame(() => {
                    modalEl.classList.remove('opacity-0');
                    inner.classList.add('modal-active');
                });
            }
        }

        function close3DModal(modalEl) {
            if (!modalEl) return;
            const inner = modalEl.querySelector('.modal-3d-flip');
            if (inner) {
                inner.classList.remove('modal-active');
                modalEl.classList.add('opacity-0');
                setTimeout(() => {
                    modalEl.classList.remove('flex', 'modal-3d-container');
                    modalEl.classList.add('hidden');
                    if (inner) inner.classList.remove('modal-3d-flip');
                }, 400);
            } else {
                modalEl.classList.remove('flex');
                modalEl.classList.add('hidden');
            }
        }

        // Override the paste modal open to use 3D
        const _origPasteOpen = document.getElementById('btn-open-paste-modal');
        if (_origPasteOpen) {
            const existingListeners = _origPasteOpen.onclick;
            // We patch the showSetup open behavior for paste modal in the existing code
        }

        // ‚îÄ‚îÄ INIT ALL 3D SYSTEMS ON LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.addEventListener('load', () => {
            initCardTilt();
            updateStepIndicator('start');
        });

    </script>

    <!-- Smart Assistant FAB (always visible) -->
    <button id="smart-assistant-fab" onclick="openSmartAssistant()"
        class="fixed bottom-6 right-6 z-[999] w-14 h-14 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-[0_4px_20px_rgba(99,102,241,0.4)] hover:shadow-[0_6px_30px_rgba(99,102,241,0.6)] hover:scale-110 active:scale-95 transition-all duration-200 flex items-center justify-center group">
        <i class="fa-solid fa-wand-magic-sparkles text-lg group-hover:rotate-12 transition-transform"></i>
        <span
            class="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full animate-pulse border-2 border-background"></span>
    </button>

    <!-- Smart Assistant Modal -->
    <div id="smart-assistant-modal" class="hidden" onclick="if(event.target===this)closeSmartAssistant()">
        <div class="assistant-panel animate-fade-in-up" onclick="event.stopPropagation()">
            <div class="assistant-header">
                <h3><i class="fa-solid fa-wand-magic-sparkles"></i> Smart Assistant <span
                        class="text-[10px] text-white/30 font-medium ml-1">by XO</span></h3>
                <button onclick="closeSmartAssistant()" class="text-white/40 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="assistant-body">
                <div id="assistant-summary"></div>
                <div class="assistant-actions mt-4">
                    <button class="assistant-action-btn" onclick="executeAssistantAction('scan_papers')">
                        <i class="fa-solid fa-camera text-primary bg-primary/15"></i>
                        <div><span>Grade Next Test</span>
                            <p>Scan new scripts for a class</p>
                        </div>
                    </button>
                    <button class="assistant-action-btn" onclick="executeAssistantAction('edit_scores')">
                        <i class="fa-solid fa-pen-to-square text-amber-400 bg-amber-500/15"></i>
                        <div><span>Fix a Score</span>
                            <p>Correct a mistake in the results</p>
                        </div>
                    </button>
                    <button class="assistant-action-btn" onclick="executeAssistantAction('view_standings')">
                        <i class="fa-solid fa-ranking-star text-emerald-400 bg-emerald-500/15"></i>
                        <div><span>See Results</span>
                            <p>Check rankings and download Excel</p>
                        </div>
                    </button>
                    <button class="assistant-action-btn" onclick="executeAssistantAction('add_student')">
                        <i class="fa-solid fa-user-plus text-blue-400 bg-blue-500/15"></i>
                        <div><span>Add a Student</span>
                            <p>Someone missing from the list?</p>
                        </div>
                    </button>
                    <button class="assistant-action-btn"
                        onclick="sendAssistantMessage('Analyze my current scores and flag anything unusual')">
                        <i class="fa-solid fa-chart-line text-cyan-400 bg-cyan-500/15"></i>
                        <div><span>Analyze Scores</span>
                            <p>Get insights and spot anomalies</p>
                        </div>
                    </button>
                    <button class="assistant-action-btn" onclick="executeAssistantAction('update_roster')">
                        <i class="fa-solid fa-list-check text-violet-400 bg-violet-500/15"></i>
                        <div><span>Update Class List</span>
                            <p>Add or fix names in a class roster</p>
                        </div>
                    </button>
                </div>
                <div id="assistant-chat" class="mt-6"></div>
            </div>
            <div class="assistant-input-bar">
                <button id="assistant-upload-btn" onclick="document.getElementById('assistant-file-input').click()"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-all border border-white/10"
                    title="Upload image or Excel">
                    <i class="fa-solid fa-paperclip"></i>
                </button>
                <input type="file" id="assistant-file-input" class="hidden" accept="image/*,.xlsx,.xls,.csv"
                    onchange="handleAssistantFileUpload(this)">
                <input type="text" id="assistant-input" placeholder="Ask me anything..." autocomplete="off">
                <button id="assistant-send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Enhancement Layer -->
    <script src="/static/app-enhancements.js"></script>
</body>

</html>