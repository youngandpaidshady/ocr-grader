<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Grader Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        background: 'hsl(215, 10%, 4%)',    /* Deep midnight blue layer 0 */
                        foreground: 'hsl(215, 5%, 98%)',
                        card: 'hsl(215, 10%, 6%)',          /* Elevated surface */
                        'card-foreground': 'hsl(215, 5%, 98%)',
                        muted: 'hsl(215, 10%, 15%)',
                        'muted-foreground': 'hsl(215, 10%, 65%)',
                        primary: 'hsl(215, 90%, 55%)',      /* QSI Blue */
                        'primary-foreground': 'hsl(0, 0%, 98%)',
                        accent: 'hsl(215, 80%, 70%)',
                        destructive: 'hsl(0, 72%, 51%)',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'spin-slow': 'spin 8s linear infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: 0.2 },
                            '50%': { opacity: 0.4 },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- OpenCV.js for Advanced Document Detection -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="console.log('OpenCV loaded');"
        type="text/javascript"></script>

    <style>
        :root {
            --brand-rgb: 33, 150, 243;
            /* Matches primary HSL 215, 90%, 55% */
        }

        body {
            background-color: theme('colors.background');
            color: theme('colors.foreground');
        }

        /* 21st.dev Premium Depth & Textures */
        .dot-matrix {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .shadow-glow {
            box-shadow: 0 0 20px rgba(var(--brand-rgb), 0.3);
        }

        .shadow-glow-lg {
            box-shadow: 0 0 40px rgba(var(--brand-rgb), 0.4);
        }

        .shadow-bloom {
            box-shadow: 0 0 60px 20px rgba(var(--brand-rgb), 0.15);
        }

        .noise {
            position: relative;
        }

        .noise::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Input Animations */
        .input-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
        }

        .input-focus-anim {
            position: absolute;
            inset: -1px;
            background: linear-gradient(90deg, transparent, rgba(var(--brand-rgb), 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border-radius: 0.75rem;
        }

        select:focus~.input-focus-anim,
        input[type="text"]:focus~.input-focus-anim {
            opacity: 1;
        }

        /* Animation Base */
        .reveal {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: opacity, transform;
        }

        .reveal.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .reveal-delay-1 {
            transition-delay: 100ms;
        }

        .reveal-delay-2 {
            transition-delay: 200ms;
        }

        /* Card Light Beam (Active Card Effect) */
        .light-beam-card {
            position: relative;
        }

        .light-beam-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .light-beam-card:hover::before {
            opacity: 1;
        }

        /* Holographic Sheen */
        .holographic {
            background-image: linear-gradient(75deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            background-size: 200% 100%;
            background-position: 100% 0;
            transition: background-position 0.6s ease;
        }

        .holographic:hover {
            background-position: -100% 0;
        }

        /* Mobile Touch Ripples */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 600ms linear;
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        @keyframes ripple-anim {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Magnetic Button Transition */
        .magnetic {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s;
            will-change: transform;
        }

        /* Component Overrides */
        #video-container {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 4/3;
            margin: 0 auto;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
            background-color: #000;
        }

        #camera-feed {
            width: 100%;
            height: auto;
            object-fit: cover;
            display: block;
        }

        .captured-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="min-h-screen font-sans antialiased overflow-x-hidden selection:bg-primary/30 relative bg-background">

    <!-- Scroll Progress Indicator -->
    <div id="scroll-progress"
        class="fixed top-0 left-0 h-1 bg-gradient-to-r from-primary to-accent z-50 transition-all duration-100 origin-left shadow-glow border-b border-primary"
        style="width: 0%;"></div>

    <!-- Depth Layer 1: Atmosphere (Dot Matrix + Single Spotlight Glow) -->
    <div class="fixed inset-0 z-0 noise pointer-events-none"></div>
    <div class="fixed inset-0 z-0 dot-matrix pointer-events-none opacity-50"></div>
    <div
        class="fixed top-[-20%] left-[-10%] w-[60vw] h-[60vw] rounded-full bg-primary/10 blur-[120px] pointer-events-none z-0">
    </div>

    <!-- Depth Layer 3: Foreground Content -->
    <div class="max-w-4xl mx-auto p-4 md:p-8 relative z-10 w-full animate-fade-in-up">

        <!-- Header -->
        <header class="text-center mb-16 pt-12 reveal visible relative">
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-primary/20 blur-[60px] rounded-full -z-10">
            </div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-extrabold text-white mb-4 tracking-tight">
                <i
                    class="fa-solid fa-graduation-cap mr-3 text-primary drop-shadow-[0_0_15px_rgba(var(--brand-rgb),0.5)]"></i>OCR
                Grader
            </h1>
            <p class="text-muted-foreground text-lg max-w-xl mx-auto font-medium">Capture handwritten exam scripts and
                let the model automatically extract, format, and rank the results directly to Excel.</p>
        </header>

        <main>
            <!-- Step 0: Start Screen -->
            <section id="start-section"
                class="reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mb-12 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] text-center">
                <i
                    class="fa-solid fa-file-excel text-5xl text-emerald-500 mb-6 drop-shadow-[0_0_15px_rgba(16,185,129,0.5)]"></i>
                <h2 class="text-2xl font-heading font-bold text-white mb-2 tracking-tight">Initialize Roster</h2>
                <p class="text-muted-foreground mb-8 max-w-md mx-auto text-sm leading-relaxed">To get started, choose
                    whether to begin a brand new blank spreadsheet or upload an existing class roster for smart
                    name-matching.</p>

                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="btn-start-blank"
                        class="w-full md:w-auto bg-primary hover:bg-primary/90 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-glow flex items-center justify-center group mb-2 md:mb-0">
                        <i class="fa-solid fa-file-lines mr-3 group-hover:scale-110 transition-transform"></i> Start
                        Blank Sheet
                    </button>
                    <div class="relative w-full md:w-auto">
                        <input type="file" id="upload-roster-input" accept=".xlsx, .xls, .csv" class="hidden">
                        <button id="btn-upload-roster" onclick="document.getElementById('upload-roster-input').click()"
                            class="w-full bg-white/5 hover:bg-white/10 text-white border border-white/10 font-bold py-4 px-8 rounded-xl transition-all flex items-center justify-center group">
                            <i
                                class="fa-solid fa-file-arrow-up mr-3 group-hover:-translate-y-1 transition-transform"></i>
                            Upload Existing Sheet
                        </button>
                    </div>
                </div>
                <div id="start-msg" class="text-sm font-semibold mt-6 hidden"></div>
            </section>

            <!-- Step 1: Capture Area -->
            <section id="capture-section"
                class="hidden reveal reveal-delay-1 bg-card rounded-[1rem] border border-white/5 p-4 md:p-10 mb-12 relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <!-- Inner subtle gradient for volume -->
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <!-- Header (Compact) -->
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h2 class="text-xl font-heading font-bold text-white tracking-tight flex items-center">
                        <span
                            class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center mr-3 border border-primary/20 shadow-glow"><i
                                class="fa-solid fa-camera text-primary text-sm"></i></span>
                        Capture Scripts
                    </h2>
                </div>

                <!-- Video Feed with Overlays -->
                <div id="video-container"
                    class="mb-4 border border-white/10 flex items-center justify-center bg-black shadow-inner overflow-hidden relative group z-10 rounded-xl">
                    <video id="camera-feed" class="w-full h-full object-cover relative z-0" autoplay
                        playsinline></video>

                    <!-- OpenCV Canvas Visualizer -->
                    <canvas id="cv-visualizer"
                        class="absolute inset-0 w-full h-full z-10 pointer-events-none opacity-80 mix-blend-screen"></canvas>

                    <div id="camera-loading"
                        class="absolute z-20 text-muted-foreground text-sm flex flex-col items-center gap-3 bg-black/70 backdrop-blur-xl p-5 rounded-2xl border border-white/5">
                        <i class="fa-solid fa-circle-notch fa-spin text-primary text-3xl"></i>
                        <span class="font-medium tracking-wide">Initializing Camera...</span>
                    </div>

                    <!-- Top Overlays -->
                    <div
                        class="absolute top-3 left-3 right-3 flex justify-between items-start z-20 pointer-events-none">
                        <!-- Batch Count -->
                        <div
                            class="pointer-events-auto bg-black/60 backdrop-blur-md border border-white/10 text-[10px] font-semibold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm text-white uppercase tracking-widest">
                            Batch
                            <span id="batch-count"
                                class="bg-primary text-white px-2 py-0.5 rounded-md text-[10px] font-bold shadow-glow border border-primary/30">0/10</span>
                        </div>

                        <!-- Flip Camera -->
                        <button id="btn-camera"
                            class="pointer-events-auto w-10 h-10 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-white transition-all hover:scale-105 active:scale-95 shadow-sm flex items-center justify-center">
                            <i class="fa-solid fa-camera-rotate"></i>
                        </button>
                    </div>

                    <!-- Bottom Overlays -->
                    <div class="absolute bottom-3 inset-x-3 flex justify-center z-20 pointer-events-none">
                        <!-- Auto-Capture Toggle -->
                        <div
                            class="pointer-events-auto flex items-center gap-3 bg-black/70 backdrop-blur-xl px-4 py-2.5 rounded-full border border-white/10 shadow-[0_4px_20px_-5px_rgba(0,0,0,0.8)]">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-capture-toggle" class="sr-only peer">
                                <div
                                    class="w-9 h-5 bg-muted-foreground/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary shadow-inner">
                                </div>
                            </label>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-bold text-white tracking-widest uppercase leading-tight drop-shadow-md">AI
                                    Auto-Capture</span>
                            </div>
                            <div id="auto-capture-status"
                                class="ml-1 w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capture Controls (SNAP button full width) -->
                <div class="mb-6 relative z-10 px-2 lg:px-0">
                    <button id="btn-capture"
                        class="magnetic shadow-glow bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl w-full mx-auto transition-all active:scale-95 flex items-center justify-center tracking-wide overflow-hidden relative group">
                        <span
                            class="absolute inset-0 w-full h-full bg-white opacity-0 active:opacity-40 transition-opacity duration-100 mix-blend-overlay"></span>
                        <i class="fa-solid fa-camera mr-2 group-hover:scale-110 transition-transform"></i> <span
                            class="tracking-widest uppercase text-sm">Snap Script</span>
                    </button>
                </div>

                <!-- Captured Thumbnails -->
                <div id="thumbnails-container"
                    class="flex overflow-x-auto space-x-3 py-2 mb-6 min-h-[70px] relative z-10 scrollbar-hide"></div>

                <!-- Settings Box -->
                <div class="bg-black/20 rounded-xl border border-white/5 p-4 md:p-6 relative z-10 shadow-inner">
                    <h3
                        class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-4 flex items-center">
                        <i class="fa-solid fa-sliders text-[10px] mr-2"></i> Batch Settings
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- Assessment Type -->
                        <div class="space-y-2">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Assessment
                                Type</label>
                            <div
                                class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                                <select id="assessment-type"
                                    class="w-full p-4 bg-transparent text-white text-sm outline-none cursor-pointer appearance-none relative z-10 font-medium">
                                    <option value="1st CA" class="bg-card">1st CA</option>
                                    <option value="2nd CA" class="bg-card">2nd CA</option>
                                    <option value="Assignment" class="bg-card">Assignment</option>
                                    <option value="Exam" class="bg-card">Exam</option>
                                    <option value="Open Day" class="bg-card">Open Day</option>
                                    <option value="custom" class="bg-card">-- Custom Name --</option>
                                </select>
                                <i
                                    class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground/70 text-xs pointer-events-none z-10"></i>
                                <div class="input-focus-anim"></div>
                            </div>
                            <div class="input-wrapper border border-white/10 bg-black/40 mt-3 hidden"
                                id="custom-assessment-wrapper">
                                <input type="text" id="custom-assessment"
                                    class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide"
                                    placeholder="e.g., Midterm Project">
                                <div class="input-focus-anim"></div>
                            </div>
                        </div>

                        <!-- Target Class -->
                        <div class="space-y-2 group">
                            <label
                                class="block text-[11px] font-bold text-muted-foreground uppercase tracking-widest pl-1">Target
                                Class</label>
                            <div
                                class="input-wrapper border border-white/10 bg-black/40 hover:bg-black/60 transition-colors">
                                <input type="text" id="target-class"
                                    class="w-full p-4 bg-transparent text-white text-sm outline-none placeholder:text-muted-foreground/50 relative z-10 font-medium tracking-wide"
                                    placeholder="e.g., SS1Q" required>
                                <div class="input-focus-anim"></div>
                            </div>
                            <p class="text-[11px] text-muted-foreground/60 mt-1 pl-1 flex items-start gap-1.5"><i
                                    class="fa-solid fa-circle-info text-primary/70 mt-[2px]"></i> Matches handwriting to
                                known students.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Action Area / Action Zone Divider -->
            <div class="relative flex justify-center -my-6 z-20 reveal reveal-delay-2">
                <button id="btn-process" disabled
                    class="magnetic holographic shadow-glow-lg bg-card border border-white/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:bg-card disabled:holographic-none text-white font-extrabold text-sm uppercase px-10 py-5 rounded-full transition-all active:scale-95 flex items-center justify-center tracking-widest group">
                    <span
                        class="absolute inset-0 rounded-full border border-primary/30 group-hover:border-primary/60 transition-colors"></span>
                    <i
                        class="fa-solid fa-wand-magic-sparkles mr-2 text-primary group-hover:scale-110 transition-transform"></i>
                    Extract Data
                </button>
            </div>

            <div id="processing-indicator"
                class="hidden text-center mt-12 mb-4 text-primary font-medium flex flex-col items-center justify-center gap-3">
                <div class="relative flex items-center justify-center p-2">
                    <div class="absolute inset-0 border-2 border-primary/20 border-t-primary rounded-full animate-spin">
                    </div>
                    <i class="fa-solid fa-microchip text-primary"></i>
                </div>
                <span
                    class="text-xs font-bold tracking-widest uppercase border border-primary/20 bg-primary/10 px-5 py-2 rounded-full shadow-glow">Extracting
                    via Model...</span>
            </div>

            <!-- Step 2: Review Area -->
            <section id="review-section"
                class="reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mt-16 mb-8 hidden relative overflow-hidden shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)] transition-all duration-300">
                <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent pointer-events-none">
                </div>

                <div
                    class="flex flex-col md:flex-row md:justify-between items-start md:items-center mb-10 gap-4 relative z-10">
                    <h2 class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight flex items-center">
                        <span
                            class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center mr-3 border border-white/10 shadow-sm"><i
                                class="fa-solid fa-list-check text-white text-sm"></i></span>
                        Data Review
                    </h2>
                    <button id="btn-reset"
                        class="text-xs font-bold tracking-widest uppercase text-muted-foreground hover:text-white transition-colors px-4 py-2 rounded-lg border border-white/5 hover:border-white/20 bg-black/40 hover:bg-black/60 flex items-center shadow-sm">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Clear Batch
                    </button>
                </div>

                <div class="overflow-x-visible md:overflow-x-auto mb-10 relative z-10">
                    <table class="w-full text-sm text-left block md:table">
                        <thead
                            class="hidden md:table-header-group text-[11px] uppercase bg-black/60 border-b border-white/5 tracking-widest font-bold text-muted-foreground/80">
                            <tr>
                                <th scope="col"
                                    class="px-5 py-4 w-12 text-center rounded-tl-xl border-r border-white/5">#</th>
                                <th scope="col" class="px-5 py-4 border-r border-white/5">Student Identity <span
                                        class="text-primary">*</span></th>
                                <th scope="col" class="px-5 py-4 border-r border-white/5">Class</th>
                                <th scope="col" class="px-5 py-4 text-right rounded-tr-xl" id="score-th">Score</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="block md:table-row-group space-y-4 md:space-y-0">
                            <!-- Results go here via JS -->
                        </tbody>
                    </table>
                </div>

                <button id="btn-export"
                    class="magnetic holographic shadow-glow w-full bg-primary hover:bg-primary/90 text-white font-extrabold text-sm uppercase tracking-widest py-5 px-6 rounded-xl transition-all active:scale-95 flex justify-center items-center group relative z-10 border border-t-white/30 border-primary shadow-[0_4px_14px_0_rgba(var(--brand-rgb),0.39)]">
                    <i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Append to
                    Results.xlsx
                </button>
                <div id="export-msg" class="text-center mt-5 text-sm font-bold hidden relative z-10"></div>
            </section>
            <!-- Step 3: Analytics Dashboard (Appears after export) -->
            <section id="analytics-section"
                class="hidden reveal bg-card rounded-[1rem] border border-white/5 p-6 md:p-10 mb-12 shadow-[0_20px_40px_-15px_rgba(0,0,0,0.5)]">
                <div class="flex items-center gap-3 mb-8">
                    <span
                        class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center border border-emerald-500/20 shadow-glow"><i
                            class="fa-solid fa-chart-pie text-emerald-400 text-sm"></i></span>
                    <h2 class="text-xl md:text-2xl font-heading font-bold text-white tracking-tight">Session Analytics
                    </h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Average Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-chart-line text-4xl text-primary"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Class Average
                        </p>
                        <p id="stat-avg" class="text-4xl font-extrabold text-white">--</p>
                    </div>
                    <!-- Highest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-up text-4xl text-emerald-400"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Highest Score
                        </p>
                        <p id="stat-high" class="text-4xl font-extrabold text-emerald-400">--</p>
                        <p id="stat-high-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                    <!-- Lowest Score Card -->
                    <div class="bg-background rounded-xl p-5 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-arrow-trend-down text-4xl text-destructive"></i></div>
                        <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest mb-1">Lowest Score
                        </p>
                        <p id="stat-low" class="text-4xl font-extrabold text-destructive">--</p>
                        <p id="stat-low-name" class="text-xs text-muted-foreground/70 mt-1 truncate">--</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="btn-download-sheet" onclick="window.location.href='/download-sheet'"
                        class="w-full md:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-glow flex items-center justify-center group mb-2 md:mb-0">
                        <i class="fa-solid fa-download mr-2 group-hover:translate-y-1 transition-transform"></i>
                        Download Final Sheet
                    </button>
                    <button id="btn-new-batch"
                        class="w-full md:w-auto bg-white/5 hover:bg-white/10 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-sm border border-white/10 flex items-center justify-center group">
                        <i
                            class="fa-solid fa-rotate-right mr-2 group-hover:-rotate-90 transition-transform duration-500"></i>
                        Start Next Batch
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer
            class="mt-20 mb-10 text-center text-muted-foreground/40 text-[10px] uppercase font-bold tracking-widest animate-fade-in-up flex items-center justify-center gap-2"
            style="animation-delay: 0.5s;">
            <div class="w-8 h-px bg-white/10"></div>
            <p>Made with <span class="text-destructive mx-1 animate-pulse inline-block opacity-80">❤️</span> for <span
                    class="text-white/80">QSI</span></p>
            <div class="w-8 h-px bg-white/10"></div>
        </footer>
    </div>

    <!-- Invisible Canvas for capturing image frames -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        // Elements
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const btnCapture = document.getElementById('btn-capture');
        const btnSwitchCam = document.getElementById('btn-camera');
        const btnProcess = document.getElementById('btn-process');
        const loadingIndicator = document.getElementById('camera-loading');
        const batchCountEl = document.getElementById('batch-count');
        const thumbnailsContainer = document.getElementById('thumbnails-container');
        const processingIndicator = document.getElementById('processing-indicator');

        const captureSection = document.getElementById('capture-section');
        const reviewSection = document.getElementById('review-section');
        const analyticsSection = document.getElementById('analytics-section');
        const tbody = document.getElementById('results-tbody');
        const btnReset = document.getElementById('btn-reset');
        const btnExport = document.getElementById('btn-export');
        const exportMsg = document.getElementById('export-msg');
        const btnNewBatch = document.getElementById('btn-new-batch');

        // Auto-Capture Elements
        const autoCaptureToggle = document.getElementById('auto-capture-toggle');
        const autoCaptureStatus = document.getElementById('auto-capture-status');

        // Start Section Elements
        const startSection = document.getElementById('start-section');
        const btnStartBlank = document.getElementById('btn-start-blank');
        const uploadRosterInput = document.getElementById('upload-roster-input');
        const startMsg = document.getElementById('start-msg');

        // Start Blank Flow
        btnStartBlank.addEventListener('click', async () => {
            btnStartBlank.disabled = true;
            btnStartBlank.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Initializing...`;
            startMsg.classList.add('hidden');
            try {
                const res = await fetch('/start-blank-sheet', { method: 'POST' });
                if (!res.ok) throw new Error("Failed to initialize");
                startSection.classList.add('hidden');
                captureSection.classList.remove('hidden');
                initCamera();
            } catch (e) {
                startMsg.classList.remove('hidden', 'text-primary');
                startMsg.classList.add('text-destructive');
                startMsg.innerText = e.message;
            } finally {
                btnStartBlank.disabled = false;
                btnStartBlank.innerHTML = `<i class="fa-solid fa-file-lines mr-3 group-hover:scale-110 transition-transform"></i> Start Blank Sheet`;
            }
        });

        // Upload Existing Flow
        uploadRosterInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const btnUploadRoster = document.getElementById('btn-upload-roster');
            btnUploadRoster.disabled = true;
            btnUploadRoster.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Uploading...`;
            startMsg.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload-sheet', {
                    method: 'POST',
                    body: formData
                });
                if (!res.ok) throw new Error("Upload failed");
                startSection.classList.add('hidden');
                captureSection.classList.remove('hidden');
                initCamera();
            } catch (err) {
                startMsg.classList.remove('hidden', 'text-primary');
                startMsg.classList.add('text-destructive');
                startMsg.innerText = err.message;
            } finally {
                btnUploadRoster.disabled = false;
                btnUploadRoster.innerHTML = `<i class="fa-solid fa-file-arrow-up mr-3 group-hover:-translate-y-1 transition-transform"></i> Upload Existing Sheet`;
                uploadRosterInput.value = '';
            }
        });

        // Analytics Elements
        const statAvg = document.getElementById('stat-avg');
        const statHigh = document.getElementById('stat-high');
        const statHighName = document.getElementById('stat-high-name');
        const statLow = document.getElementById('stat-low');
        const statLowName = document.getElementById('stat-low-name');

        // State
        let imagesBatch = [];
        let extractedData = [];
        let currentFacingMode = 'environment';
        let stream = null;
        let imageIdCounter = 0;
        let finalAssessmentType = '';

        // UI Logic for Select Custom
        const assessmentTypeSelect = document.getElementById('assessment-type');
        const customAssessmentInput = document.getElementById('custom-assessment');
        const customAssessmentWrapper = document.getElementById('custom-assessment-wrapper');
        const scoreTh = document.getElementById('score-th');

        assessmentTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'custom') {
                customAssessmentWrapper.classList.remove('hidden');
            } else {
                customAssessmentWrapper.classList.add('hidden');
            }
        });

        // Initialize Camera
        async function initCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            loadingIndicator.classList.remove('hidden');
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    loadingIndicator.classList.add('hidden');
                };
            } catch (err) {
                console.error("Camera error:", err);
                loadingIndicator.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-destructive text-3xl mb-3 block"></i><span class="text-sm font-bold text-destructive">Camera Access Denied</span>`;
            }
        }

        // Smart Image Compression: only downscale if > MAX_WIDTH, preserving quality for low-end cameras
        const COMPRESS_MAX_WIDTH = 1600;
        const COMPRESS_QUALITY = 0.85;
        function compressImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // If image is already small enough, skip compression entirely
                    if (img.width <= COMPRESS_MAX_WIDTH) {
                        resolve(base64Str);
                        return;
                    }
                    const ratio = COMPRESS_MAX_WIDTH / img.width;
                    const newW = COMPRESS_MAX_WIDTH;
                    const newH = Math.round(img.height * ratio);
                    const offscreen = document.createElement('canvas');
                    offscreen.width = newW;
                    offscreen.height = newH;
                    const octx = offscreen.getContext('2d');
                    octx.drawImage(img, 0, 0, newW, newH);
                    resolve(offscreen.toDataURL('image/jpeg', COMPRESS_QUALITY));
                };
                img.src = base64Str;
            });
        }

        // Initialization
        async function initCamera() {
            loadingIndicator.classList.remove('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    loadingIndicator.classList.add('hidden');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
            } catch (err) {
                console.error("Error accessing camera:", err);
                loadingIndicator.innerHTML = `Error: Cannot access camera. <br/><span class="text-xs opacity-70 mt-2 block font-normal">Ensure permissions are granted.</span>`;
            }
        }

        // Capture Image
        function captureFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const rawBase64 = canvas.toDataURL('image/jpeg', 0.9); // Capture at high quality first
            const imageId = imageIdCounter++;
            const base64ForPreview = canvas.toDataURL('image/jpeg', 0.5); // Fast low res preview

            // Compress asynchronously (won't block the UI)
            compressImage(rawBase64).then(compressedBase64 => {
                imagesBatch.push({ id: imageId, base64: compressedBase64 });
                batchCountEl.innerText = imagesBatch.length;
                btnProcess.disabled = false;
            });

            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'relative flex-shrink-0 group mt-2';
            thumbDiv.dataset.id = imageId;

            const img = document.createElement('img');
            img.src = base64ForPreview;
            img.className = 'captured-thumb shadow-sm group-hover:border-primary/50 transition-colors';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'absolute -top-2 -right-2 bg-black backdrop-blur-md hover:bg-destructive text-white border border-white/20 rounded-full w-6 h-6 flex items-center justify-center text-[10px] shadow-lg z-10 transition-all transform hover:scale-110';
            cancelBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
            cancelBtn.title = 'Remove image';
            cancelBtn.onclick = function () {
                imagesBatch = imagesBatch.filter(item => item.id !== imageId);
                batchCountEl.innerText = imagesBatch.length;
                thumbDiv.remove();
                if (imagesBatch.length === 0) {
                    btnProcess.disabled = true;
                }
            };

            thumbDiv.appendChild(img);
            thumbDiv.appendChild(cancelBtn);
            thumbnailsContainer.appendChild(thumbDiv);

            if (navigator.vibrate) navigator.vibrate(50);

            // Shutter flash effect
            const container = document.getElementById('video-container');
            const flash = document.createElement('div');
            flash.className = 'absolute inset-0 bg-white z-50 mix-blend-overlay';
            container.appendChild(flash);
            setTimeout(() => {
                flash.style.transition = 'opacity 0.2s';
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 200);
            }, 50);
        }

        btnCapture.addEventListener('click', captureFrame);

        // ═══════════════════════════════════════════════════════════════
        //  AUTO-CAPTURE v3: Document-Presence-First Architecture
        //  Instead of waiting for "stillness" (which fails with hand tremor),
        //  we continuously scan for a document and trigger after N consecutive
        //  detections. This is how CamScanner/Google Lens work.
        // ═══════════════════════════════════════════════════════════════
        let scanIntervalId = null;
        let consecutiveDetections = 0;
        const SCAN_INTERVAL_MS = 160;        // ~6 FPS OpenCV scans
        const DETECTIONS_TO_SNAP = 8;        // 8 consecutive = ~1.3s of seeing paper
        const COOLDOWN_AFTER_SNAP_MS = 3000; // 3s pause after snap to swap paper

        function scanForDocument() {
            const hudCanvas = document.getElementById('cv-visualizer');
            if (!hudCanvas) return false;

            hudCanvas.width = video.videoWidth || 640;
            hudCanvas.height = video.videoHeight || 480;
            const hudCtx = hudCanvas.getContext('2d');
            hudCtx.clearRect(0, 0, hudCanvas.width, hudCanvas.height);

            if (typeof cv === 'undefined' || !cv.Mat) return false;
            if (!video.videoWidth) return false; // Video not ready

            const checkW = 320;
            const checkH = 240;
            const docCanvas = document.createElement('canvas');
            docCanvas.width = checkW;
            docCanvas.height = checkH;
            const docCtx = docCanvas.getContext('2d', { willReadFrequently: true });

            try {
                docCtx.drawImage(video, 0, 0, checkW, checkH);

                let src = cv.imread(docCanvas);
                let gray = new cv.Mat();
                let edges = new cv.Mat();
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();

                // Grayscale + heavy blur to smooth out noise and merge nearby text strokes
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                cv.GaussianBlur(gray, gray, new cv.Size(7, 7), 0, 0, cv.BORDER_DEFAULT);

                // Very sensitive Canny to catch faint pen strokes and paper edges
                cv.Canny(gray, edges, 20, 60, 3, false);

                // Dilate to fuse individual text characters/lines into one solid blob
                let kernel = cv.Mat.ones(7, 7, cv.CV_8U);
                cv.dilate(edges, edges, kernel, new cv.Point(-1, -1), 2, cv.BORDER_CONSTANT, cv.morphologyDefaultBorderValue());
                kernel.delete();

                // Find all contours
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let documentFound = false;
                let bestContour = null;
                let maxArea = (checkW * checkH) * 0.10; // At least 10% of the frame

                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);

                    if (area > maxArea) {
                        maxArea = area;
                        if (bestContour) bestContour.delete();
                        bestContour = cnt.clone();
                        documentFound = true;
                    }
                }

                // ── DISCRIMINATOR GATE ─────────────────────────────────────
                // Reject false positives (floors, walls, desks) with 3 checks:
                //   1. MAX AREA: if blob covers >75% of frame, it's the entire scene, not a document
                //   2. ASPECT RATIO: paper is roughly rectangular (0.3 to 3.5 w/h ratio)
                //   3. BRIGHTNESS: paper is WHITE (mean > 150), not beige tiles (~140)
                //   4. INK CONTRAST: stddev > 30 means dark ink on light paper
                if (documentFound && bestContour) {
                    let rect = cv.boundingRect(bestContour);
                    let blobArea = cv.contourArea(bestContour);
                    let frameArea = checkW * checkH;

                    // Check 1: Blob can't be the entire scene
                    if (blobArea > frameArea * 0.75) {
                        documentFound = false;
                    }

                    // Check 2: Aspect ratio must be paper-like
                    if (documentFound && rect.width > 0 && rect.height > 0) {
                        let aspectRatio = rect.width / rect.height;
                        if (aspectRatio < 0.3 || aspectRatio > 3.5) {
                            documentFound = false;
                        }
                    }

                    // Check 3: White Pixel Ratio (the KEY discriminator)
                    // Paper has many near-white pixels (the background between text lines).
                    // Floor tiles are uniformly beige (~140) with almost zero pixels above 180.
                    // This test counts what % of the ROI is "white" (>180 brightness).
                    //   - White paper with ink: 20-70% white pixels → PASS
                    //   - Beige floor tiles: <5% white pixels → FAIL
                    //   - Dark desk/metal: <1% white pixels → FAIL
                    if (documentFound) {
                        let rx = Math.max(0, rect.x);
                        let ry = Math.max(0, rect.y);
                        let rw = Math.min(rect.width, checkW - rx);
                        let rh = Math.min(rect.height, checkH - ry);

                        if (rw > 5 && rh > 5) {
                            let roi = gray.roi(new cv.Rect(rx, ry, rw, rh));

                            // Threshold at 180: pixels brighter than 180 = "white"
                            let binary = new cv.Mat();
                            cv.threshold(roi, binary, 180, 255, cv.THRESH_BINARY);
                            let whitePixels = cv.countNonZero(binary);
                            let totalPixels = rw * rh;
                            let whiteRatio = whitePixels / totalPixels;

                            roi.delete();
                            binary.delete();

                            // Paper needs at least 20% white pixels
                            if (whiteRatio < 0.20) {
                                documentFound = false;
                            }
                        } else {
                            documentFound = false;
                        }
                    }
                }

                // Draw HUD when found
                if (documentFound && bestContour) {
                    let hull = new cv.Mat();
                    cv.convexHull(bestContour, hull, false, true);

                    const scaleX = hudCanvas.width / checkW;
                    const scaleY = hudCanvas.height / checkH;

                    hudCtx.strokeStyle = '#10b981';
                    hudCtx.lineWidth = 3;
                    hudCtx.shadowColor = '#10b981';
                    hudCtx.shadowBlur = 12;
                    hudCtx.setLineDash([12, 6]);

                    hudCtx.beginPath();
                    let points = hull.data32S;
                    for (let j = 0; j < points.length; j += 2) {
                        let x = points[j] * scaleX;
                        let y = points[j + 1] * scaleY;
                        if (j === 0) hudCtx.moveTo(x, y);
                        else hudCtx.lineTo(x, y);
                    }
                    hudCtx.closePath();
                    hudCtx.stroke();

                    // Draw corner markers for a "targeting" feel
                    hudCtx.setLineDash([]);
                    hudCtx.lineWidth = 4;
                    const cornerLen = 20;
                    let rect = cv.boundingRect(bestContour);
                    let rx = rect.x * scaleX, ry = rect.y * scaleY;
                    let rw = rect.width * scaleX, rh = rect.height * scaleY;
                    // Top-left
                    hudCtx.beginPath(); hudCtx.moveTo(rx, ry + cornerLen); hudCtx.lineTo(rx, ry); hudCtx.lineTo(rx + cornerLen, ry); hudCtx.stroke();
                    // Top-right
                    hudCtx.beginPath(); hudCtx.moveTo(rx + rw - cornerLen, ry); hudCtx.lineTo(rx + rw, ry); hudCtx.lineTo(rx + rw, ry + cornerLen); hudCtx.stroke();
                    // Bottom-left
                    hudCtx.beginPath(); hudCtx.moveTo(rx, ry + rh - cornerLen); hudCtx.lineTo(rx, ry + rh); hudCtx.lineTo(rx + cornerLen, ry + rh); hudCtx.stroke();
                    // Bottom-right
                    hudCtx.beginPath(); hudCtx.moveTo(rx + rw - cornerLen, ry + rh); hudCtx.lineTo(rx + rw, ry + rh); hudCtx.lineTo(rx + rw, ry + rh - cornerLen); hudCtx.stroke();

                    hull.delete();
                }

                // Cleanup
                if (bestContour) bestContour.delete();
                src.delete(); gray.delete(); edges.delete(); contours.delete(); hierarchy.delete();
                return documentFound;

            } catch (e) {
                console.error("OpenCV scan error:", e);
                return false;
            }
        }

        function autoCaptureLoop() {
            if (!autoCaptureToggle.checked) return;

            const found = scanForDocument();

            if (found) {
                consecutiveDetections++;
                // Show progress: yellow → orange → green as we approach snap
                const progress = consecutiveDetections / DETECTIONS_TO_SNAP;
                if (progress < 0.5) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-yellow-500 transition-colors shadow-glow';
                } else if (progress < 1) {
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-orange-500 transition-colors shadow-glow animate-pulse';
                }

                if (consecutiveDetections >= DETECTIONS_TO_SNAP) {
                    // SNAP!
                    autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-emerald-500 transition-colors shadow-glow ring-2 ring-emerald-500/50';
                    captureFrame();
                    consecutiveDetections = 0;

                    // Cooldown: pause scanning to let user swap paper
                    if (scanIntervalId) clearInterval(scanIntervalId);
                    setTimeout(() => {
                        if (autoCaptureToggle.checked) {
                            consecutiveDetections = 0;
                            scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
                        }
                    }, COOLDOWN_AFTER_SNAP_MS);
                    return;
                }
            } else {
                // Reset streak — paper left the frame or no document detected
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-blue-500/50 transition-colors shadow-glow';
            }
        }

        autoCaptureToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                consecutiveDetections = 0;
                scanIntervalId = setInterval(autoCaptureLoop, SCAN_INTERVAL_MS);
            } else {
                if (scanIntervalId) clearInterval(scanIntervalId);
                scanIntervalId = null;
                consecutiveDetections = 0;
                autoCaptureStatus.className = 'ml-1 w-2.5 h-2.5 rounded-full bg-muted-foreground/30 transition-colors shadow-glow';
                const hudCanvas = document.getElementById('cv-visualizer');
                if (hudCanvas) {
                    const hudCtx = hudCanvas.getContext('2d');
                    hudCtx.clearRect(0, 0, hudCanvas.width, hudCanvas.height);
                }
            }
        });

        // Switch Camera
        btnSwitchCam.addEventListener('click', () => {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera();
        });

        // Process Batch (Send to Backend)
        btnProcess.addEventListener('click', async () => {
            if (imagesBatch.length === 0) return;

            btnProcess.disabled = true;
            btnCapture.disabled = true;
            processingIndicator.classList.remove('hidden');

            try {
                const base64List = imagesBatch.map(item => item.base64);
                const targetClassVal = document.getElementById('target-class').value.trim();

                finalAssessmentType = assessmentTypeSelect.value === 'custom'
                    ? (customAssessmentInput.value.trim() || 'Score')
                    : assessmentTypeSelect.value;
                scoreTh.innerText = finalAssessmentType;

                captureSection.classList.add('hidden');
                reviewSection.classList.remove('hidden');

                // Initialize empty table and array
                tbody.innerHTML = '';
                extractedData = new Array(base64List.length).fill({});

                const response = await fetch('/upload-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: base64List,
                        targetClass: targetClassVal
                    })
                });

                if (!response.ok) {
                    let errStr = "Server error";
                    try {
                        const errData = await response.json();
                        errStr = errData.error || errStr;
                    } catch (e) { }
                    throw new Error(errStr);
                }

                // Read SSE Stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // Keep the last incomplete chunk in the buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') {
                                continue;
                            }
                            try {
                                const parsed = JSON.parse(dataStr);
                                const idx = parsed.index;
                                const item = parsed.result;
                                extractedData[idx] = item;
                                renderSingleRow(item, idx);
                            } catch (e) {
                                console.error("Error parsing SSE data:", e, dataStr);
                            }
                        }
                    }
                }

            } catch (err) {
                console.error("Processing error:", err);
                alert(`Error processing images: ${err.message}`);
                btnProcess.disabled = false;
                btnCapture.disabled = false;
                reviewSection.classList.add('hidden');
                captureSection.classList.remove('hidden');
            } finally {
                processingIndicator.classList.add('hidden');
            }
        });

        function renderSingleRow(item, index) {
            const tr = document.createElement('tr');

            // Confidence-based styling
            const confidence = (item.confidence || 'high').toLowerCase();
            const isLow = confidence === 'low';
            const isMedium = confidence === 'medium';

            let borderClass = 'border-white/5';
            let confidenceBadge = '';
            if (isLow) {
                borderClass = 'border-destructive/40 ring-1 ring-destructive/20';
                confidenceBadge = `<span class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-destructive bg-destructive/10 border border-destructive/20 px-2 py-0.5 rounded-full ml-2"><i class="fa-solid fa-triangle-exclamation text-[8px]"></i> Low</span>`;
            } else if (isMedium) {
                borderClass = 'border-yellow-500/30 ring-1 ring-yellow-500/10';
                confidenceBadge = `<span class="inline-flex items-center gap-1 text-[9px] font-extrabold uppercase tracking-widest text-yellow-400 bg-yellow-500/10 border border-yellow-500/20 px-2 py-0.5 rounded-full ml-2"><i class="fa-solid fa-circle-exclamation text-[8px]"></i> Med</span>`;
            }

            tr.className = `reveal light-beam-card flex flex-col md:table-row bg-background md:bg-transparent rounded-xl md:rounded-none border ${borderClass} md:border-none md:border-b md:border-white/5 transition-colors group overflow-hidden md:hover:bg-white/[0.02] p-4 md:p-0 my-3 md:my-0 shadow-lg md:shadow-none translate-y-4 opacity-0 transition-all duration-500 hidden`;

            const nameStr = item.name || '';
            const classStr = item.class || '';
            const scoreStr = item.score || '';

            tr.innerHTML = `
            <td class="flex justify-between items-center md:table-cell px-2 md:px-5 py-2 md:py-4 border-b border-white/5 md:border-none text-muted-foreground/50 font-mono text-xs"><span class="md:hidden font-bold text-white/40 uppercase tracking-widest text-[10px]">ID</span> ${index + 1}${confidenceBadge}</td>
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold">Student Identity <span class="text-primary">*</span></span><input type="text" data-index="${index}" data-field="name" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm font-semibold transition-colors outline-none placeholder:text-muted-foreground/30" value="${nameStr}" placeholder="Enter Name"></td>
            <td class="flex flex-col md:table-cell px-2 md:px-5 py-3 border-b border-white/5 md:border-none md:border-l md:border-white/5"><span class="md:hidden text-[10px] text-muted-foreground/80 mb-1.5 uppercase tracking-widest font-bold">Class</span><input type="text" data-index="${index}" data-field="class" class="w-full bg-transparent border-b border-transparent focus:border-white/20 focus:ring-0 px-0 py-1 text-white text-base md:text-sm transition-colors outline-none placeholder:text-muted-foreground/30 font-medium" value="${classStr}" placeholder="Class"></td>
            <td class="flex justify-between items-center md:table-cell px-2 md:px-5 py-4 bg-black/40 md:bg-transparent -mx-4 px-6 md:mx-0 mt-2 md:mt-0 rounded-b-xl md:rounded-none md:border-l md:border-white/5"><span class="md:hidden text-[11px] text-primary uppercase tracking-widest font-extrabold">Final Score</span><input type="text" data-index="${index}" data-field="score" class="w-24 md:w-full md:min-w-[70px] bg-white/[0.04] md:bg-transparent border border-white/10 md:border-none md:border-b md:border-transparent focus:border-primary/50 focus:bg-primary/5 focus:ring-0 md:px-2 py-2 text-primary md:text-foreground text-right font-bold text-lg md:text-sm rounded-lg md:rounded-none transition-colors outline-none placeholder:text-muted-foreground/30 shadow-inner md:shadow-none" value="${scoreStr}" placeholder="Score"></td>
            `;

            // Insert in order
            const rows = Array.from(tbody.children);
            let inserted = false;
            for (let i = 0; i < rows.length; i++) {
                const rowInput = rows[i].querySelector('input[data-index]');
                if (rowInput) {
                    const rowIndex = parseInt(rowInput.getAttribute('data-index'), 10);
                    if (index < rowIndex) {
                        tbody.insertBefore(tr, rows[i]);
                        inserted = true;
                        break;
                    }
                }
            }
            if (!inserted) {
                tbody.appendChild(tr);
            }

            // Bind events
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'), 10);
                    const field = e.target.getAttribute('data-field');
                    extractedData[idx][field] = e.target.value;
                });
            });

            // Animate in progressively
            requestAnimationFrame(() => {
                tr.classList.remove('hidden');
                requestAnimationFrame(() => {
                    tr.classList.remove('translate-y-4', 'opacity-0');
                    tr.classList.add('visible');
                });
            });
        }

        // Analytics Calculation
        function calculateAnalytics(data) {
            let validScores = [];
            let high = { score: -1, name: '' };
            let low = { score: 999999, name: '' };

            data.forEach(item => {
                const s = parseFloat(item.score);
                if (!isNaN(s)) {
                    validScores.push(s);
                    if (s > high.score) { high.score = s; high.name = item.name || ''; }
                    if (s < low.score) { low.score = s; low.name = item.name || ''; }
                }
            });

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                const avg = (sum / validScores.length).toFixed(1);
                statAvg.innerText = avg;

                statHigh.innerText = high.score;
                statHighName.innerText = high.name;

                statLow.innerText = low.score;
                statLowName.innerText = low.name;

                // Trigger Confetti for Perfect Scores
                const rawHasPerfect = data.some(item => {
                    if (!item.score) return false;
                    const str = String(item.score).trim();
                    return str === '100' || str.startsWith('100/') || str === '10/10' || str === '20/20';
                });

                if (rawHasPerfect && typeof confetti === 'function') {
                    const duration = 2500;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({
                            particleCount: 5,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24'] // brand colors
                        });
                        confetti({
                            particleCount: 5,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: ['#3b82f6', '#10b981', '#fbbf24']
                        });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                }

            } else {
                statAvg.innerText = '--';
                statHigh.innerText = '--';
                statHighName.innerText = '--';
                statLow.innerText = '--';
                statLowName.innerText = '--';
            }
        }

        // Export to Excel / Sheets
        btnExport.addEventListener('click', async () => {
            btnExport.disabled = true;
            btnExport.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> APPENDING...`;
            exportMsg.classList.add('hidden');

            try {
                const response = await fetch('/export-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        results: extractedData,
                        assessmentType: finalAssessmentType
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Export failed");

                exportMsg.classList.remove('hidden', 'text-destructive');
                exportMsg.classList.add('text-primary');
                exportMsg.innerHTML = `<i class="fa-solid fa-circle-check mr-2"></i> ${data.message}`;

                // Show Analytics Dashboard
                calculateAnalytics(extractedData);
                reviewSection.classList.add('hidden');
                analyticsSection.classList.remove('hidden');

            } catch (err) {
                console.error("Export error:", err);
                exportMsg.classList.remove('hidden', 'text-primary');
                exportMsg.classList.add('text-destructive');
                exportMsg.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> Error: ${err.message}`;
            } finally {
                btnExport.disabled = false;
                btnExport.innerHTML = `<i class="fa-solid fa-file-csv mr-2 group-hover:-translate-y-1 transition-transform"></i> Compile To Dashboard`;
            }
        });

        // Start Next Batch
        btnNewBatch.addEventListener('click', () => {
            imagesBatch = [];
            extractedData = [];
            batchCountEl.innerText = '0';
            thumbnailsContainer.innerHTML = '';
            exportMsg.classList.add('hidden');

            btnProcess.disabled = true;
            btnCapture.disabled = false;

            analyticsSection.classList.add('hidden');
            reviewSection.classList.add('hidden');
            captureSection.classList.remove('hidden');

            if (autoCaptureToggle.checked) {
                stillTimeStart = null;
                previousFrameData = null;
                detectMotion();
            }
        });

        // Reset Flow
        btnReset.addEventListener('click', () => {
            if (confirm("Are you sure? This will discard the current batch.")) {
                imagesBatch = [];
                extractedData = [];
                batchCountEl.innerText = '0';
                thumbnailsContainer.innerHTML = '';

                btnProcess.disabled = true;
                btnCapture.disabled = false;

                reviewSection.classList.remove('visible');
                setTimeout(() => {
                    reviewSection.classList.add('hidden');
                    captureSection.classList.remove('hidden');
                    setTimeout(() => {
                        captureSection.classList.add('visible');
                    }, 50);
                }, 300);

                exportMsg.classList.add('hidden');
            }
        });

        // Start video on load
        window.addEventListener('load', () => {
            initCamera();
            triggerRevealObserver();
            initMagneticButtons();
            initTouchRipples();
            initScrollProgress();
        });

        // 21st.dev Premium Animations

        function triggerRevealObserver() {
            const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
            setTimeout(() => {
                document.querySelectorAll('.reveal:not(.hidden)').forEach(el => el.classList.add('visible'));
            }, 100);
        }

        function initMagneticButtons() {
            const magnetics = document.querySelectorAll('.magnetic');
            magnetics.forEach(btn => {
                btn.addEventListener('mousemove', (e) => {
                    if (window.innerWidth < 768) return;
                    const rect = btn.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const xc = rect.width / 2;
                    const yc = rect.height / 2;
                    const dx = x - xc;
                    const dy = y - yc;
                    const maxTranslate = 15;
                    const tx = (dx / xc) * maxTranslate;
                    const ty = (dy / yc) * maxTranslate;
                    btn.style.transform = `translate(${tx}px, ${ty}px) scale(1.02)`;
                });

                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translate(0px, 0px) scale(1)';
                });

                btn.addEventListener('mousedown', () => {
                    const span = btn.querySelector('span.absolute');
                    if (span) {
                        span.style.transform = 'scale(1)';
                        span.style.opacity = '1';
                        setTimeout(() => {
                            span.style.transform = 'scale(0)';
                            span.style.opacity = '0';
                        }, 500);
                    }
                });
            });
        }

        function initTouchRipples() {
            const buttons = document.querySelectorAll('button:not(#btn-capture)');
            buttons.forEach(btn => {
                btn.style.position = 'relative';
                btn.style.overflow = 'hidden';

                const createRipple = (e) => {
                    const circle = document.createElement('span');
                    const diameter = Math.max(btn.clientWidth, btn.clientHeight);
                    const radius = diameter / 2;

                    let clientX, clientY;
                    if (e.touches && e.touches.length > 0) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    const rect = btn.getBoundingClientRect();

                    circle.style.width = circle.style.height = `${diameter}px`;
                    circle.style.left = `${clientX - rect.left - radius}px`;
                    circle.style.top = `${clientY - rect.top - radius}px`;
                    circle.classList.add('ripple');

                    const ripple = btn.querySelector('.ripple');
                    if (ripple) ripple.remove();

                    btn.appendChild(circle);
                };

                btn.addEventListener('mousedown', createRipple);
                btn.addEventListener('touchstart', createRipple, { passive: true });
            });
        }

        function initScrollProgress() {
            const progressBar = document.getElementById('scroll-progress');
            if (!progressBar) return;

            window.addEventListener('scroll', () => {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                if (height <= 0) return;
                const scrolled = (winScroll / height) * 100;
                progressBar.style.width = scrolled + '%';
            }, { passive: true });
        }
    </script>
</body>

</html>